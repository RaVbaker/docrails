<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Podstawowe informacje o module Action Controller</title>
  <!--[if lt IE 8]>
  <script src="http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE8.js" type="text/javascript"></script>
  <![endif]-->
  <link href="stylesheets/base.css" media="screen" rel="Stylesheet" type="text/css" />
  <link href="stylesheets/forms.css" media="screen" rel="Stylesheet" type="text/css" />
  <link href="stylesheets/more.css" media="screen" rel="Stylesheet" type="text/css" />
</head>
<body>
  <div id="header" >
    <div id="logo">
      <a href="index.html" title="Ruby on Rails"><img src="images/rails_logo_remix.gif" alt="Rails" height="140" width="110" /></a>
    </div>

    <h1 id="site_title"><span>Ruby on Rails</span></h1>
    <h2 id="site_title_tagline">Sustainable productivity for web-application development</h2>

    <ul id="navMain">
      <li class="first-child"><a href="http://www.rubyonrails.org/" title="Ruby on Rails" class="ruby_on_rails">Ruby on Rails</a></li>
      <li><a class="manuals" href="index.html" title="Manuals Index">Guides Index</a></li>
    </ul>
  </div>

  <div id="container">
    
    <div id="sidebar">
      <h2>Chapters</h2>
      <ol>
          <li>
          <a href="#_co_robi_kontroler">Co robi kontroler?</a>
          </li>
          <li>
          <a href="#_metody_i_akcje">Metody i akcje</a>
          </li>
          <li>
          <a href="#_parametry">Parametry</a>
            <ul>
            
              <li><a href="#_parametry_tablic_zwyk_ych_ang_array_i_tablic_asocjacyjnych_ang_hash">Parametry tablic zwykłych (ang. array) i tablic asocjacyjnych (ang. hash)</a></li>
            
              <li><a href="#_parametry_routingu">Parametry routingu</a></li>
            
              <li><a href="#_tt_default_url_options_tt"><tt>default_url_options</tt></a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_sesja">Sesja</a>
            <ul>
            
              <li><a href="#_dost_pno_sesji">Dostępność sesji</a></li>
            
              <li><a href="#_flash">Flash</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_cookies">Cookies</a>
          </li>
          <li>
          <a href="#_filtry">Filtry</a>
            <ul>
            
              <li><a href="#_filtry_ko_cowe_i_okalaj_ce">Filtry końcowe i okalające</a></li>
            
              <li><a href="#_inne_sposoby_wykorzystania_filtr_w">Inne sposoby wykorzystania filtrów</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_weryfikacja">Weryfikacja</a>
          </li>
          <li>
          <a href="#_ochrona_przed_atakami_typu_cross_site_request_forgery">Ochrona przed atakami typu Cross-site request forgery</a>
          </li>
          <li>
          <a href="#_obiekty_tt_request_tt_i_tt_response_tt">Obiekty <tt>request</tt> i <tt>response</tt></a>
            <ul>
            
              <li><a href="#_obiekt_tt_request_tt">Obiekt <tt>request</tt></a></li>
            
              <li><a href="#_obiekt_tt_response_tt">Obiekt <tt>response</tt></a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_podstawowe_uwierzytelnianie_http">Podstawowe uwierzytelnianie HTTP</a>
          </li>
          <li>
          <a href="#_przesy_anie_strumieniowe_i_pobieranie_plik_w">Przesyłanie strumieniowe i pobieranie plików</a>
            <ul>
            
              <li><a href="#_wysy_anie_plik_w">Wysyłanie plików</a></li>
            
              <li><a href="#_pobieranie_plik_w_w_aplkacjach_restful">Pobieranie plików w aplkacjach RESTful</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_filtrowanie_parametr_w">Filtrowanie parametrów</a>
          </li>
          <li>
          <a href="#_obs_uga_b_d_w">Obsługa błędów</a>
            <ul>
            
              <li><a href="#_domy_lne_szablony_b_d_w_500_and_404">Domyślne szablony błędów 500 and 404</a></li>
            
              <li><a href="#_tt_rescue_from_tt"><tt>rescue_from</tt></a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_changelog">Changelog</a>
          </li>
      </ol>
    </div>
    
    <div id="content">
        <h1>Podstawowe informacje o module Action Controller</h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>W tym przewodniku dowiesz się jak pracują kontrolery (controllers) oraz w jaki sposób używać ich w cyklu żądań twojej aplikacji. Po przeczytaniu tego przewodnika, będziesz potrafił:</p></div>
<div class="ulist"><ul>
<li>
<p>
kierować przepływ żądania do kontrolera
</p>
</li>
<li>
<p>
zrozumieć jak i dlaczego przechowywać dane w sesji lub cookies
</p>
</li>
<li>
<p>
pracować z filtrami, po to by móc wykonywać kod podczas przetwarzania żądania
</p>
</li>
<li>
<p>
używać wbudowanego w moduł Action Controller uwieżytelniania HTTP
</p>
</li>
<li>
<p>
przesyłać dane bezpośrednio do przeglądarki użytkownika
</p>
</li>
<li>
<p>
filtrować niejawne parametry, tak by nie pojawiały się w logach aplikacji
</p>
</li>
<li>
<p>
radzić sobie z wyjątkami, które mogą wystąpić podczas przetwarzania żądania
</p>
</li>
</ul></div>
</div>
</div>
<h2 id="_co_robi_kontroler">1. Co robi kontroler?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Moduł Action Controller odpowiada literze C we wzorcu MVC. Po tym, jak routing określi, którego kontrolera użyć do wykonania żądania, twój kontroler jest odpowiedzialny za zrozumienie tego żądania i za stworzenie odpowiednich danych wyjściowych. Na szczęście moduł Action Controller wykonuje większość podstawowej pracy za ciebie, używa inteligentnych konwencji po to, by uczynić wszystko tak prostym, jak to tylko możliwe.</p></div>
<div class="paragraph"><p>Dla większości typowych aplikacji RESTful, kontroler otrzyma żądanie (co nie
jest widoczne dla ciebie jako programisty), zapisze albo pobierze dane z
modelu i użyje widoku w celu stworzenia wyjściowej strony HTML. Jeżeli twój
kontroler potrzebuje wykonywać pewne rzeczy trochę inaczej - nie ma problemu,
to jest tylko najbardziej typowy sposób pracy kontrolera.</p></div>
<div class="paragraph"><p>Kontroler może być zatem traktowany jako pośrednik między modelami a widokami. Udostępnia on dane modelu do widoku, który następnie wyświetla dane użytkownikowi. I w drugą stronę - kontroler zapisuje bądź uaktualnia dane w modelu pobierając je od użytkownika.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Aby dowiedzieć się więcej o procesie routingu, zajrzyj do
      <a href="routing_outside_in.html">Routingu w Ruby on Rails</a>.</td>
</tr></table>
</div>
</div>
<h2 id="_metody_i_akcje">2. Metody i akcje</h2>
<div class="sectionbody">
<div class="paragraph"><p>Kontroler jest klasą języka Ruby dziedziczącą z klasy ApplicationController,
posiada metody jak każda inna klasa. Kiedy twoja aplikacja otrzymuje żądanie,
routing określa, który wybrać kontroler i którą akcję wykonać, a następnie
Railsy tworzą instancję klasy danego kontrolera i wywołuje publiczną metodę o tej samej nazwie co akcja.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ClientsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-style: italic"><span style="color: #9A1900"># Actions are public methods</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> new
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-style: italic"><span style="color: #9A1900"># Action methods are responsible for producing output</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> edit
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># Helper methods are private and can not be used as actions</span></span>
private

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> foo
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Nie ma zasady mówiącej, że metoda na kontrolerze musi być akcją; równie dobrze może być użyta do innych celów, takich jak filtrowanie, które będzie omówione w dalszej części tego przewodnika.</p></div>
<div class="paragraph"><p>Na przykład, jeżeli użytkownik przejdzie do <tt>/clients/new</tt> w twojej aplikacji, aby dodać nowego klienta, Rails stworzy instancję klasy ClientsController i uruchomi metodę <tt>new</tt>. Zwróć uwagę, że pusta metoda z przykładu powyżej może działać dobrze, ponieważ Rails domyślnie wyrenderuje widok <tt>new.html.erb</tt>, chyba że akcja powie inaczej. Metoda <tt>new</tt> może udostępnić do widoku zmienną instancyjną <tt>@client</tt> poprzez stworzenie nowego klienta.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> new
  <span style="color: #009900">@client</span> <span style="color: #990000">=</span> Client<span style="color: #990000">.</span>new
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Przewodnik <a href="layouts_and_rendering.html">Layouty oraz renderowanie</a> wyjaśnia to szczegółowo.</p></div>
<div class="paragraph"><p>Klasa ApplicationController dziedziczy z klasy ActionController::Base, która
definiuje szereg pomocnych metod. Niniejszy przewodnik obejmuje niektóre z
nich, ale jeśli jesteś ciekaw, możesz zobaczyć je wszystkie w dokumentacji API
albo w kodzie źródłowym.</p></div>
</div>
<h2 id="_parametry">3. Parametry</h2>
<div class="sectionbody">
<div class="paragraph"><p>Prawdopodobnie będziesz chciał uzyskać dostęp do danych przesłanych przez
użytkownika lub innych parametrów występujących w akcjach twojego kontrolera.
Mamy dwa rodzaje parametrów występujących w aplikacjach webowych. Pierwszy typ
to parametry, które są wysyłane jako część adresu URL, która to część jest
nazywana ciągiem zapytania (ang. query string). Ciąg zapytania to wszystko, co
znajduje się po znaku "?" w adresie URL. Drugi typ parametrów jest zazwyczaj
określany jako dane POST (ang. POST data). Te informacje pochodzą zwykle z
formularza HTML, który został wypełniony przez użytkownika. Są nazywane jako
dane POST, ponieważ mogą być wysłane jedynie jako część żądania HTTP POST.
Railsy nie tworzą żadnego rozróżnienia pomiędzy parametrami ciągu zapytania a
parametrami POST. Oba typy są dostępne w tablicy asocjacyjnej (ang. hash) <tt>params</tt> w twoim kontrolerze:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ClientsController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

  <span style="font-style: italic"><span style="color: #9A1900"># This action uses query string parameters because it gets run by a HTTP</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># GET request, but this does not make any difference to the way in which</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># the parameters are accessed. The URL for this action would look like this</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># in order to list activated clients: /clients?status=activated</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> index
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> params<span style="color: #990000">[:</span>status<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"activated"</span>
      <span style="color: #009900">@clients</span> <span style="color: #990000">=</span> Client<span style="color: #990000">.</span>activated
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
      <span style="color: #009900">@clients</span> <span style="color: #990000">=</span> Client<span style="color: #990000">.</span>unativated
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-style: italic"><span style="color: #9A1900"># This action uses POST parameters. They are most likely coming from an HTML</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># form which the user has submitted. The URL for this RESTful request will</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># be "/clients", and the data will be sent as part of the request body.</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    <span style="color: #009900">@client</span> <span style="color: #990000">=</span> Client<span style="color: #990000">.</span>new<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>client<span style="color: #990000">])</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #009900">@client</span><span style="color: #990000">.</span>save
      redirect_to <span style="color: #009900">@client</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
      <span style="font-style: italic"><span style="color: #9A1900"># This line overrides the default rendering behavior, which would have been</span></span>
      <span style="font-style: italic"><span style="color: #9A1900"># to render the "create" view.</span></span>
      render <span style="color: #990000">:</span>action <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"new"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<h3 id="_parametry_tablic_zwyk_ych_ang_array_i_tablic_asocjacyjnych_ang_hash">3.1. Parametry tablic zwykłych (ang. array) i tablic asocjacyjnych (ang. hash)</h3>
<div class="paragraph"><p>Tablica haszująca <tt>params</tt> nie musi być ograniczona do jednego wymiaru. Możemy stworzyć tablicę wielowymiarową, która zawiera w sobie zagnieżdżone tablice haszujące lub zwykłe tablice. Aby wysłać tablicę wartości, dołącz "[]" do nazwy klucza.</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>GET /clients?ids[]=1&amp;ids[]=2&amp;ids[]=3</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Rzeczywisty URL w tym przykładzie byłby zakodowany jako "/clients?ids%5b%5d=1&amp;ids%5b%5d=2&amp;ids%5b%5b=3", jako że znaki [ i ] nie są dozwolone w adresach URL. Najczęściej nie będziesz się musiał o to martwić, ponieważ przeglądarka będzie dbać o to za ciebie, a Railsy, gdy otrzymają taki ciąg, będą dekodować to z powrotem. Ale jeśli kiedyś znajdziesz się w konieczności, by wysłać takie żądanie do serwera ręcznie, musisz o tym pamiętać.</td>
</tr></table>
</div>
<div class="paragraph"><p>Wartość <tt>params[:ids]</tt> będzie teraz wynosić <tt>["1", "2", "3"]</tt>. Zauważ, że
wartości parametru są zawsze łańcuchami znaków). Railsy nie próbują odgadywać ani rzutować typu.</p></div>
<div class="paragraph"><p>Aby przesłać tablicę haszującą, zawrzyj nazwę klucza wewnątrz nawiasów:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>&lt;form action="/clients" method="post"&gt;
  &lt;input type="text" name="client[name]" value="Acme" /&gt;
  &lt;input type="text" name="client[phone]" value="12345" /&gt;
  &lt;input type="text" name="client[address][postcode]" value="12345" /&gt;
  &lt;input type="text" name="client[address][city]" value="Carrot City" /&gt;
&lt;/form&gt;</tt></pre>
</div></div>
<div class="paragraph"><p>Wartość tablicy <tt>params[:client]</tt> po tym, jak ten formularz zostanie przekazany, będzie wynosić <tt>{"name" =&gt; "Acme", "phone" =&gt; "12345", "address" =&gt; {"postcode" =&gt; "12345", "city" =&gt; "Carrot City"}}</tt>. Zwróć uwagę na zagnieżdżoną tablicę haszującą w <tt>params[:client][:address]</tt>.</p></div>
<div class="paragraph"><p>Zauważ też, że tablica haszująca params jest w rzeczywistości instancją klasy
<tt>HashWithIndifferentAccess</tt> (z modułu Active Support), która jest podklasą
klasy Hash. Pozwala ona na stosowanie zamiennie symboli oraz łańcuchów znaków jako kluczy.</p></div>
<h3 id="_parametry_routingu">3.2. Parametry routingu</h3>
<div class="paragraph"><p>Tablica haszująca <tt>params</tt> będzie zawsze zawierać klucze <tt>:controller</tt> i
<tt>:action</tt>, ale należy używać metod <tt>controller_name</tt> i <tt>action_name</tt> zamiast
odwoływać się do ich wartości. Wszelkie inne parametry określone przez
routing, takie jak <tt>:id</tt> będą również dostepne. Jako przykład, rozważ listę
klientów, gdzie lista może wyświetlić albo aktywnych, albo nieaktywnych
klientów. Możemy dodać drogę routingu (ang. route), która ujmie parametr <tt>:status</tt> w zgrabny adres URL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># ...</span></span>
map<span style="color: #990000">.</span>connect <span style="color: #FF0000">"/clients/:status"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>controller <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"clients"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>action <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"index"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>foo <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"bar"</span>
<span style="font-style: italic"><span style="color: #9A1900"># ...</span></span></tt></pre></div></div>
<div class="paragraph"><p>W tym przypadku, gdy użytkownik otwiera URL <tt>/clients/active</tt>, <tt>params[:status]</tt> zostanie ustawiony na "active". Gdy ta reguła jest stosowana, także <tt>params[:foo]</tt> zostanie ustawiony na "bar", tak jak zostało to przekazane w ciągu zapytania. Na tej samej zasadzie <tt>params[:action]</tt> będzie zawierać "index".</p></div>
<h3 id="_tt_default_url_options_tt">3.3. <tt>default_url_options</tt></h3>
<div class="paragraph"><p>Możesz ustawić domyślne parametry globalne, które będą wykorzystywane podczas generowania adresów URL z użyciem <tt>default_url_options</tt>. Aby to zrobić, zdefiniuj metodę o takiej nazwie w swoim kontrolerze:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

  <span style="font-style: italic"><span style="color: #9A1900">#The options parameter is the hash passed in to +url_for+</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> default_url_options<span style="color: #990000">(</span>options<span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span><span style="color: #990000">:</span>locale <span style="color: #990000">=&gt;</span> I18n<span style="color: #990000">.</span>locale<span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Opcje te zostaną wykorzystane jako punkt wyjścia podczas generowania, więc
jest możliwe, że zostaną nadpisane przez <tt>url_for</tt>. Ponieważ metoda ta jest
zdefiniowana w kontrolerze, możesz określić ją w klasie ApplicationController,
wtedy będzie używana dla wszystkich tworzonych adresów URL. Ale możesz także
określić ją tylko w wybranym kontrolerze dla adresów URL tam generowanych.</p></div>
</div>
<h2 id="_sesja">4. Sesja</h2>
<div class="sectionbody">
<div class="paragraph"><p>Twoja aplikacja tworzy sesję dla każdego użytkownika, w której możesz
zapisywać nieiwelkie ilości danych. Dane te są utrzymywane pomiędzy żądaniami.
Sesja jest dostępna jedynie w kontrolerze i w widoku i może korzystać z wielu różnych mechanizmów przechowywania:</p></div>
<div class="ulist"><ul>
<li>
<p>
CookieStore - przechowuje wszystko po stronie klienta.
</p>
</li>
<li>
<p>
DRbStore - przechowuje dane na serwerze DRb.
</p>
</li>
<li>
<p>
MemCacheStore - przechowuje dane w memcache.
</p>
</li>
<li>
<p>
ActiveRecordStore - przechowuje dane w bazie danych przy użyciu Active Record.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Wszystkie sesje używają cookie - jest to wymagane i Railsy nie pozwalają, by któraś część sesji była przekazana w inny sposób (np. nie można użyć ciągu zapytania do przekazywania identyfikatora sesji) z powodów bezpieczeństwa (łatwiej jest przejąć sesję, gdy identyfikator jest częścią adresu URL).</p></div>
<div class="paragraph"><p>Większość mechanizmów przechowywania używa cookie do przechowywania
identyfikatora sesji, który jest następnie używany do sprawdzenia danych sesji
na serwerze. Domyślny i zalecany mechanizm, CookieStore, nie przechowuje
danych sesji na serwerze, ale w samym cookie. Dane są kryptograficznie
oznaczone, by były odporne na manipulacje, ale nie są szyfrowane. To znaczy,
że każda osoba mająca do nich dostęp, może odczytać ich zawartość, ale nie
może ich edytować (Railsy nie zaakceptują danych, jeśli były edytowane).
CookieStore może przechować tylko około 4kB danych - znacznie mniej niż
pozostałe mechanizmy - ale zazwyczaj jest to wystarczająca ilość.
Przechowywanie dużych ilości danych jest odradzane niezależnie od tego, który
mechanizm do przechowywania danych sesji wybierzesz w swojej aplikacji. Należy
unikać przechowywania w sesji szczególnie złożonych obiektów (innych niż
podstawowe obiekty Rubiego, najbardziej powszechnym przykładem jest instancja
modelu), ponieważ serwer może nie być w stanie ponownie ich odtworzyć pomiędzy żądaniami, co w rezultacie może zakończyć się błędem. CookieStore posiada dodatkową korzyść - nie wymaga żadnych uprzednich ustawień - Railsy wygenerują "tajny klucz", który będzie użyty do oznaczenia cookie.</p></div>
<div class="paragraph"><p>Poczytaj więcej o przechowywaniu sesji w przewodniku <a href="security.html">Bezpieczeństwo w Ruby on Rails</a>.</p></div>
<div class="paragraph"><p>Jeśli potrzbujesz innego mechanizmu przechowywania sesji, możesz zmienić go w pliku <tt>config/environment.rb</tt></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Wstaw jeden spośród [:active_record_store, :drb_store, :mem_cache_store, :cookie_store]</span></span>
config<span style="color: #990000">.</span>action_controller<span style="color: #990000">.</span>session_store <span style="color: #990000">=</span> <span style="color: #990000">:</span>active_record_store</tt></pre></div></div>
<h3 id="_dost_pno_sesji">4.1. Dostępność sesji</h3>
<div class="paragraph"><p>W twoim kontrolerze masz dostęp do sesji poprzez metodę instancyją <em>session</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Sesje są leniwie ładowane (ang. lazily loaded). Jeśli nie korzystasz z sesji w kodzie akcji, nie będzie ona ładowana. Dlatego nie musisz wyłączać mechanizmu sesji, wystarczy, że z niego nie korzystasz.</td>
</tr></table>
</div>
<div class="paragraph"><p>Wartości sesji są przechowywane z użyciem par klucz/wartość:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

private

  <span style="font-style: italic"><span style="color: #9A1900"># Znajdowanie użytkownika, którego ID jest przechowywane w sesji, za pomocą klucza :current_user_id</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># To jest typowy sposób obsługi logowania użytkownika w aplikacjach Railsowych;</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># logując ustawia wartość sesji i wylogowując usuwa ją</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> current_user
    <span style="color: #009900">@_current_user</span> <span style="color: #990000">||=</span> session<span style="color: #990000">[:</span>current_user_id<span style="color: #990000">]</span> <span style="color: #990000">&amp;&amp;</span> User<span style="color: #990000">.</span>find<span style="color: #990000">(</span>session<span style="color: #990000">[:</span>current_user_id<span style="color: #990000">])</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Aby zapisać coś w sesji, wystarczy przypisać to do klucza:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> LoginsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-style: italic"><span style="color: #9A1900"># "Stwórz" login, aka "zaloguj użytkownika"</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> user <span style="color: #990000">=</span> User<span style="color: #990000">.</span>authenticate<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>username<span style="color: #990000">,</span> params<span style="color: #990000">[:</span>password<span style="color: #990000">])</span>
      <span style="font-style: italic"><span style="color: #9A1900"># Zapisanie identyfikatora użytkownika w sesji, by mógł być wykorzystany w kolejnych żądaniach</span></span>
      session<span style="color: #990000">[:</span>current_user_id<span style="color: #990000">]</span> <span style="color: #990000">=</span> user<span style="color: #990000">.</span>id
      redirect_to root_url
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Żeby usunąć coś z sesji, przypisz kluczowi wartość <tt>nil</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> LoginsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-style: italic"><span style="color: #9A1900"># "Usuń" login, aka "wyloguj użytkownika"</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> destroy
    <span style="font-style: italic"><span style="color: #9A1900"># Usunięcie ID użytkownika z sesji</span></span>
    session<span style="color: #990000">[:</span>current_user_id<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">nil</span></span>
    redirect_to root_url
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Aby skasować całą sesję, użyj `reset_session".</p></div>
<h3 id="_flash">4.2. Flash</h3>
<div class="paragraph"><p>Flash jest specjalną częścią sesji, która jest czyszczona przy każdym żądaniu,
w takim sensie, że wartości tam przechowywane są dostępne tylko w następnym
żądaniu. Jest to przydatne do przechowywania komunikatów o błędach itp. Jest
ona dostępna w bardzo podobny sposób jak sama sesja, czyli jako tablica
haszująca. Jako przykładu użyjmy mechanizmu wylogowywania. Kontroler może wysłać komunikat, który będzie wyświetlony użytkownikowi przy następnym żądaniu:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> LoginsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> destroy
    session<span style="color: #990000">[:</span>current_user_id<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">nil</span></span>
    flash<span style="color: #990000">[:</span>notice<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"You have successfully logged out"</span>
    redirect_to root_url
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Akcja <tt>destroy</tt> przekierowuje do <tt>root_url</tt> aplikacji, gdzie komunikat będzie wyświetlony. Należy podkreślić, że obowiązkiem następnej akcji jest zdecydować, co (jeśli cokolwiek) ma zrobić z tym, co wcześniejsza akcja umieściła we flash&#8217;u. Konwencją jest wyświetlenie ewentualnych błędów lub powiadomień z flash w layoutcie aplikacji:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>&lt;html&gt;
  &lt;!-- &lt;head/&gt; --&gt;
  &lt;body&gt;
    &lt;% if flash[:notice] -%&gt;
      &lt;p class="notice"&gt;&lt;%= flash[:notice] %&gt;&lt;/p&gt;
    &lt;% end -%&gt;
    &lt;% if flash[:error] -%&gt;
      &lt;p class="error"&gt;&lt;%= flash[:error] %&gt;&lt;/p&gt;
    &lt;% end -%&gt;
    &lt;!-- more content --&gt;
  &lt;/body&gt;
&lt;/html&gt;</tt></pre>
</div></div>
<div class="paragraph"><p>W ten sposób, jeśli akcja umieści komunikat błędu lub powiadomienie, layout wyświetli je automatycznie.</p></div>
<div class="paragraph"><p>Jeśli chcesz, by wartość flash była przeniesiona do innego żądania, użyj metody <tt>keep</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> MainController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-style: italic"><span style="color: #9A1900"># Powiedzmy, że ta akcja odpowiada root_url, ale chcesz, żeby wszystkie żądania tutaj były przekierowane do</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># UsersController#index. Jeżeli akcja umieści flash i przekieruje tutaj, wartości normalnie zostaną utracone</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># wraz z następnym przekierowaniem. Ale możesz użyć metody keep, by je utrwalić dla innych żądań.</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> index
    flash<span style="color: #990000">.</span>keep <span style="font-style: italic"><span style="color: #9A1900"># Utrzymane zostaną wszystkie wartości flash. Możesz także użyć klucza, żeby utrzymać tylko wybraną wartość: flash.keep(:notice)</span></span>
    redirect_to users_url
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<h4 id="_tt_flash_now_tt">4.2.1. <tt>flash.now</tt></h4>
<div class="paragraph"><p>Domyślnie dodanie wartości do flash czyni je dostpępnymi w następnym żądaniu.
Ale czasami możesz potrzebować dostępu do tych wartości już w tym żądaniu. Na
przykład, jeżeli akcji <tt>create</tt> nie uda się zapisać zasobów i ty natychmiast
wyrenderujesz szablon <tt>new</tt>, nie będzie to prowadzić do nowego żądania, ale ty i tak będziesz potrzebować wyświetlić komunikat używając flash. Możesz to zrobić przy użyciu <tt>flash.now</tt>. Robi się to tak samo jak przy normalnym <tt>flash</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ClientsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    <span style="color: #009900">@client</span> <span style="color: #990000">=</span> Client<span style="color: #990000">.</span>new<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>client<span style="color: #990000">])</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #009900">@client</span><span style="color: #990000">.</span>save
      <span style="font-style: italic"><span style="color: #9A1900"># ...</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
      flash<span style="color: #990000">.</span>now<span style="color: #990000">[:</span>error<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"Could not save client"</span>
      render <span style="color: #990000">:</span>action <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"new"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
</div>
<h2 id="_cookies">5. Cookies</h2>
<div class="sectionbody">
<div class="paragraph"><p>Twoja aplikacja może przechowywać małe ilości danych po stronie klienta w postaci tzw. cookies. Mogą one trwać poprzez wiele żądań, a nawet sesji. Railsy zapewniają łatwy dostęp do cookies za pomocą metody <tt>cookies</tt>, która podobnie jak metoda <tt>session</tt>, działa jako tablica haszująca:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> CommentsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> new
    <span style="font-style: italic"><span style="color: #9A1900">#Auto-fill the commenter's name if it has been stored in a cookie</span></span>
    <span style="color: #009900">@comment</span> <span style="color: #990000">=</span> Comment<span style="color: #990000">.</span>new<span style="color: #990000">(:</span>name <span style="color: #990000">=&gt;</span> cookies<span style="color: #990000">[:</span>commenter_name<span style="color: #990000">])</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    <span style="color: #009900">@comment</span> <span style="color: #990000">=</span> Comment<span style="color: #990000">.</span>new<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>comment<span style="color: #990000">])</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #009900">@comment</span><span style="color: #990000">.</span>save
      flash<span style="color: #990000">[:</span>notice<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"Thanks for your comment!"</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> params<span style="color: #990000">[:</span>remember_name<span style="color: #990000">]</span>
        <span style="font-style: italic"><span style="color: #9A1900"># Remember the commenter's name</span></span>
        cookies<span style="color: #990000">[:</span>commenter_name<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #009900">@comment</span><span style="color: #990000">.</span>name
      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># Don't remember, and delete the name if it has been remembered before</span></span>
        cookies<span style="color: #990000">.</span>delete<span style="color: #990000">(:</span>commenter_name<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
      redirect_to <span style="color: #009900">@comment</span><span style="color: #990000">.</span>article
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
      render <span style="color: #990000">:</span>action <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"new"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Zwróć uwagę: żeby skasować wartości sesji, musisz przypisać kluczowi wartość <tt>nil</tt>. Natomiast żeby skasować wartość cookie, powinieneś użyć <tt>cookies.delete(:key)</tt>.</p></div>
</div>
<h2 id="_filtry">6. Filtry</h2>
<div class="sectionbody">
<div class="paragraph"><p>Filtry są metodami, które są uruchamiane przed, po lub wokół akcji kontrolera.
Na przykład, jeden filtr może sprawdzać czy zalogowany użytkownik ma prawa
dostępu do tego konkretnego kontrolera lub akcji. Filtry są dziedziczone, więc
jeśli ustawisz filtr w <tt>ApplicationController</tt>, będzie wykonywany w każdym
kontrolerze w twojej aplikacji. Typowy, prosty filtr wymaga, by użytkownik był zalogowany, aby akcja została wykonana.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

private

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> require_login
    <span style="font-weight: bold"><span style="color: #0000FF">unless</span></span> logged_in?
      flash<span style="color: #990000">[:</span>error<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"You must be logged in to access this section"</span>
      redirect_to new_login_url <span style="font-style: italic"><span style="color: #9A1900"># Prevents the current action from running</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-style: italic"><span style="color: #9A1900"># The logged_in? method simply returns true if the user is logged in and</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># false otherwise. It does this by "booleanizing" the current_user method</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># we created previously using a double ! operator. Note that this is not</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># common in Ruby and is discouraged unless you really mean to convert something</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># into true or false.</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> logged_in?
    <span style="color: #990000">!!</span>current_user
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ta metoda po prostu przechowuje komunikat o błędzie (we flash) i przekierowuje
do formularza logowania, jeśli użytkownik jest niezalogowany. Jeśli filtr
wstępny (ang. <em>before filter</em>; filtr, który jest uruchamiany przed akcją) renderuje lub przekierowuje, akcja nie będzie wykonana. Jeśli istnieją dodatkowe filtry, które miały być wykonane po filtrze renderującym bądź przekierowującym, zostaną one anulowane. Aby użyć tego filtra w kontrolerze, skorzystaj z metody <tt>before_filter</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

  before_filter <span style="color: #990000">:</span>require_login

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>W tym przykładzie, filtr jest dodany do <tt>ApplicationController</tt>, a tym samym do wszystkich kontrolerów w aplikacji. W ten sposób każdy element aplikacji wymaga, by użytkownik był zalogowany, aby cokolwiek zrobić. Z oczywistych powodów (użytkownik nie będzie mmógł zalogować się już na starcie!) nie każdy kontroler lub akcja powinien tego wymagać. Możesz zapobiec uruchomieniu tego filtra przed szczególną, określoną akcją za pomocą metody <tt>skip_before_filter</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> LoginsController <span style="color: #990000">&lt;</span> Application

  skip_before_filter <span style="color: #990000">:</span>require_login<span style="color: #990000">,</span> <span style="color: #990000">:</span>only <span style="color: #990000">=&gt;</span> <span style="color: #990000">[:</span>new<span style="color: #990000">,</span> <span style="color: #990000">:</span>create<span style="color: #990000">]</span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Teraz akcje <tt>new</tt> i <tt>create</tt> klasy <tt>LoginsController</tt> będą działać bez wymagania, by użytkownik był zalogowany. Opcja <tt>:only</tt> jest użyta w takim celu, żeby pominięcie dotyczyło tylko tego filtra dla wskazanych akcji. Istnieje też opcja <tt>:except</tt>, która działa odwrotnie do opcji <tt>:only</tt>. Te opcje mogą być użyte także podczas dodawania filtrów. Możesz więc dodać filtr dla wybranych akcji, który uruchomi się w pierwszej kolejności (tzn. przed samą akcją).</p></div>
<h3 id="_filtry_ko_cowe_i_okalaj_ce">6.1. Filtry końcowe i okalające</h3>
<div class="paragraph"><p>W uzupełnieniu do filtrów wstępnych (uruchamianych przed akcją), możesz
wywoływać filtry uruchamiane po akcji albo oba typy na raz - i przed, i po.
Filtr końcowy (ang. after filter) jest podobny do filtra wstępnego, ale
ponieważ w tym wypadku akcja już jest uruchomiona, filtr ma dostęp do danych
zwrotnych, które zostały wysłane do klienta. Oczywiście filtr taki nie może
zatrzymać akcji przed uruchomieniem. Filtr okalający (ang. around filter;
filtr uruchamiany jakby jednocześnie, "wokół" akcji) jest odpowiedzialny
za uruchomienie akcji i może zdecydować żeby tego nie robić, co jest
sposobem na jej zatrzymanie.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Przykład zaczerpnięty z dokumentacji API Railsów:</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># http://api.rubyonrails.org/classes/ActionController/Filters/ClassMethods.html</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> Application

  around_filter <span style="color: #990000">:</span>catch_exceptions

private

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> catch_exceptions
    <span style="font-weight: bold"><span style="color: #0000FF">yield</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">rescue</span></span> <span style="color: #990000">=&gt;</span> exception
    logger<span style="color: #990000">.</span>debug <span style="color: #FF0000">"Caught exception! #{exception}"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<h3 id="_inne_sposoby_wykorzystania_filtr_w">6.2. Inne sposoby wykorzystania filtrów</h3>
<div class="paragraph"><p>Choć najczęstszym sposobem używania filtrów jest tworzenie prywatnych metod  i
używanie <tt>*_filter</tt> dla dodania ich, istnieją jeszcze dwa inne sposoby, aby zrobić to samo.</p></div>
<div class="paragraph"><p>Pierwszym jest użycie bloku bezpośrednio z metodą <tt>*_filter</tt>. Blok otrzymuje
kontroler jako argument i filtr <tt>require_login</tt> z powyższych przykładów może
być przepisany na blok:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

  before_filter <span style="color: #FF0000">{</span> <span style="color: #990000">|</span>controller<span style="color: #990000">|</span> redirect_to new_login_url <span style="font-weight: bold"><span style="color: #0000FF">unless</span></span> controller<span style="color: #990000">.</span>send<span style="color: #990000">(:</span>logged_in?<span style="color: #990000">)</span> <span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Zauważ, że filtr w tym przypadku używa <tt>send</tt>, a to dlatego, że metoda <tt>logged_in?</tt> jest metodą prywatną i filtr nie jest wywołany w obszarze kontrolera. Nie jest to zalecany sposób implementacji tego konkretnego filtra, ale w licznych prostych przypadkach może być przydatny.</p></div>
<div class="paragraph"><p>Drugim sposobem jest użycie klasy (właściwie, każdy obiekt, który odpowiada
właściwej metodzie będzie odpowiedni) do obsłużenia filtrowania. Jest to
przydatne w przypadkach, które są bardziej złożone, których zaimplementowanie
w sposób czytelny i odtwarzalny nie jest możliwe przy użyciu dwóch poprzednich
metod. Jako przykład, mógłbyś przepisać filtr logowania przy użyciu klasy:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

  before_filter LoginFilter

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> LoginFilter

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>filter<span style="color: #990000">(</span>controller<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">unless</span></span> logged_in?
      controller<span style="color: #990000">.</span>flash<span style="color: #990000">[:</span>error<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"You must be logged in to access this section"</span>
      controller<span style="color: #990000">.</span>redirect_to controller<span style="color: #990000">.</span>new_login_url
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Znowu, to nie jest idealny przykład dla tego filtra, ponieważ nie działa on w
obszarze kontrolera, tylko otrzymuje kontroler przekazany jako argument. Klasa
filtra posiada metodę klasową <tt>filter</tt>, która zostanie uruchomiona przed lub
po akcji, w zależności od tego, czy jest to filtr wstępny czy końcowy. Klasy
używane jako filtry okalające również mogą używać tej samej metody <tt>filter</tt>, która będzie działać tak samo. Metoda musi użyć instrukcji <tt>yield</tt>, aby wykonać akcję. Alternatywnie, może mieć obie metody, i <tt>before</tt>, i <tt>after</tt>, które będą wywołane i przed, i po akcji.</p></div>
<div class="paragraph"><p>Dokumentacja API Railsów zawiera
<a href="http://api.rubyonrails.org/classes/ActionController/Filters/ClassMethods.html">więcej
informacji na temat sposobu korzystania z filtrów</a>.</p></div>
</div>
<h2 id="_weryfikacja">7. Weryfikacja</h2>
<div class="sectionbody">
<div class="paragraph"><p>Weryfikacja to sprawdzenie czy pewne kryteria są spełnione, aby uruchomić
kontroler lub akcję. Może określać, że pewien klucz (lub kilka kluczy w formie
tablicy) jest obecny w tablicy haszującej <tt>params</tt>, <tt>session</tt> lub <tt>flash</tt> lub
to, że jakaś metoda HTTP została użyta lub to, że żądanie zostało wykonane
przy użyciu XMLHTTPRequest (Ajax). Gdy kryteria nie są spełnione, domyślnie
podejmowaną akcją jest wyrenderowanie błędu 400 (Bad Request), ale możesz to
zmienić wedle swojego uznania, na przykład podając adres URL pod który akcja
ma zostać przekierowana. Możesz wyrenderować cokolwiek innego albo na przykład dodać wiadomości we flash i nagłówki HTTP do odpowiedzi. Jest to dokładnie opisane w <a href="http://api.rubyonrails.org/classes/ActionController/Verification/ClassMethods.html">dokumentacji API</a> jako "essentially a special kind of before_filter".</p></div>
<div class="paragraph"><p>Oto przykład użycia weryfikacji sprawdzającej czy użytkownik dostarczył login i hasło do zalogowania:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> LoginsController <span style="color: #990000">&lt;</span> ApplicationController

  verify <span style="color: #990000">:</span>params <span style="color: #990000">=&gt;</span> <span style="color: #990000">[:</span>username<span style="color: #990000">,</span> <span style="color: #990000">:</span>password<span style="color: #990000">],</span>
         <span style="color: #990000">:</span>render <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #990000">:</span>action <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"new"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #990000">:</span>add_flash <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #990000">:</span>error <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"Username and password required to log in"</span><span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    <span style="color: #009900">@user</span> <span style="color: #990000">=</span> User<span style="color: #990000">.</span>authenticate<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>username<span style="color: #990000">],</span> params<span style="color: #990000">[:</span>password<span style="color: #990000">])</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #009900">@user</span>
      flash<span style="color: #990000">[:</span>notice<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"You're logged in"</span>
      redirect_to root_url
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
      render <span style="color: #990000">:</span>action <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"new"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Teraz akcja <tt>create</tt> nie będzie wywoływana dopóki parametry <tt>username</tt> i <tt>password</tt> nie zostaną podane. Jeśli się nie pojawią, do flash zostanie dodany komunikat błędu i zostanie wyrenderowana akcja <tt>new</tt>. Ale jest jeszcze coś ważnego, czego nie dopracowaliśmy w weryfikacji powyżej: będzie ona używana dla każdej akcji klasy LoginsController, a nie o to nam chodzi. Możesz wskazać dla których akcji weryfikacja ma być używana za pomocą opcji <tt>:only</tt> i <tt>:except</tt> tak jak w przypadku filtrów:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> LoginsController <span style="color: #990000">&lt;</span> ApplicationController

  verify <span style="color: #990000">:</span>params <span style="color: #990000">=&gt;</span> <span style="color: #990000">[:</span>username<span style="color: #990000">,</span> <span style="color: #990000">:</span>password<span style="color: #990000">],</span>
         <span style="color: #990000">:</span>render <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #990000">:</span>action <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"new"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #990000">:</span>add_flash <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #990000">:</span>error <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"Username and password required to log in"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #990000">:</span>only <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>create <span style="font-style: italic"><span style="color: #9A1900"># weryfikacja będzie uruchamiana tylko dla akcji "create"</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
</div>
<h2 id="_ochrona_przed_atakami_typu_cross_site_request_forgery">8. Ochrona przed atakami typu Cross-site request forgery</h2>
<div class="sectionbody">
<div class="paragraph"><p>Cross-site request forgery to metoda ataku na stronę internetową, polegająca
na tym, że użytkownik nieświadomie wysyła spreparowane przez hackera żądania.
W ten sposób hacker może dodać, zmodyfikować lub usunąć dane ze strony bez
wiedzy i pozwolenia użytkownika. Pierwszym krokiem do uniknięcia takiego
zagrożenia jest upewnienie się, że wszystkie "destrukcyjne" akcje (create,
update, destroy) są dostępne jedynie za pomocą żądań innych niż GET. Jeżeli
stosujesz się do konwencji RESTful, na pewno już jest to zrobione. Jednak
złośliwa strona nadal może wysyłać żądania inne niż GET do twojej strony i to
całkiem prosto. I tu z pomocą przychodzi ochrona przed atakami typu Cross-site
request forgery. Jak sama nazwa mówi, jest to ochrona przed fałszywymi
żądaniami. Sposobem na zabezpieczenie naszej strony jest dodanie
niezgadywalnego jednorazowego kodu (ang. token) do każdego osobnego żądania.
Kod ten jest znany tylko twojemu serwerowi. Na tej zasadzie jeśli żądanie
przyjdzie bez właściwego kodu, dostęp zostanie mu zabroniony.</p></div>
<div class="paragraph"><p>Jeśli wygenerujesz formularz taki jak ten:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">&lt;% form_for @user do |f| -%&gt;</span>
  <span style="color: #FF0000">&lt;%= f.text_field :username %&gt;</span>
  <span style="color: #FF0000">&lt;%= f.text_field :password -%&gt;</span>
<span style="color: #FF0000">&lt;% end -%&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>Możesz dodoać token jako ukryte pole:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/users/1"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- ... --&gt;</span></span><span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"67250ab105eb5ad10851c00a5621854a23af5489"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"authenticity_token"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;&lt;/div&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- Fields --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Railsy dodają ten token do każdego formularza, który jest generowany przy użyciu <a href="form_helpers.html">helperów formularzy</a>, więc w większości przypadków nie musisz się o nic martwić. Jeśli piszesz swój formularz ręcznie, albo potrzebujesz dodać token z innych przyczyn, jest to możliwe za pomocą metody <tt>form_authenticity_token</tt>:</p></div>
<div class="listingblock">
<div class="title">Dodanie zmiennej JavaScript zawierającej token przy użyciu AJAXa</div>
<div class="content">
<pre><tt>&lt;%= javascript_tag "MyApp.authenticity_token = '#{form_authenticity_token}'" %&gt;</tt></pre>
</div></div>
<div class="paragraph"><p>Przewodnik <a href="security.html">Bezpieczeństwo w Ruby On Rails</a> zawiera więcej informacji na ten temat, a także wiele innych zagadnień związanych z bezpieczeństwem, których powinieneś być świadomy podczas opracowywania aplikacji internetowych.</p></div>
</div>
<h2 id="_obiekty_tt_request_tt_i_tt_response_tt">9. Obiekty <tt>request</tt> i <tt>response</tt></h2>
<div class="sectionbody">
<div class="paragraph"><p>W każdym kontrolerze występują dwie metody dostępowe wskazujące na obiekty żądania i odpowiedzi, które są związane z cyklem żądań będącym obecnie w realizacji. Metoda <tt>request</tt> zawiera instancję klasy AbstractRequest, a metoda <tt>response</tt> zwraca obiekt <tt>response</tt> prezentujący co zostanie odesłane z powrotem do klienta.</p></div>
<h3 id="_obiekt_tt_request_tt">9.1. Obiekt <tt>request</tt></h3>
<div class="paragraph"><p>Obiekt request zawiera wiele przydatnych informacji na temat żądania przychodzącego od klienta. Aby uzyskać pełną listę dostępnych metod, odwołaj się do <a href="http://api.rubyonrails.org/classes/ActionController/AbstractRequest.html">dokumentacji API</a>. Wśród właściwości tego obiektu, do których możesz mieć dostęp, są:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>host</tt> - nazwa hosta użytego do wysłania tego żądania.
</p>
</li>
<li>
<p>
<tt>domain(n=2)</tt> - pierwszych <tt>n</tt> segmentów nazwy hosta, zaczynając od prawej (TLD).
</p>
</li>
<li>
<p>
<tt>format</tt> - typ zawartości żądanej przez klienta.
</p>
</li>
<li>
<p>
<tt>method</tt> - metoda HTTP użyta do wysłania żądania.
</p>
</li>
<li>
<p>
<tt>get?</tt>, <tt>post?</tt>, <tt>put?</tt>, <tt>delete?</tt>, <tt>head?</tt> - zwraca <tt>true</tt> jeśli metoda HTTP to GET/POST/PUT/DELETE/HEAD.
</p>
</li>
<li>
<p>
<tt>headers</tt> - zwraca tablicę haszującą zawierającą nagłówki stowarzyszone z żądaniem.
</p>
</li>
<li>
<p>
<tt>port</tt> - numer portu (typ integer) użyty w żądaniu.
</p>
</li>
<li>
<p>
<tt>protocol</tt> - zwraca łańcuch zawierający użyty protokół plus "://", na przykład "http://"
</p>
</li>
<li>
<p>
<tt>query_string</tt> - ciąg zapytania (część adresu URL - wszystko po znaku "?").
</p>
</li>
<li>
<p>
<tt>remote_ip</tt> - adres IP klienta.
</p>
</li>
<li>
<p>
<tt>url</tt> - cały adres URL użyty w żądaniu.
</p>
</li>
</ul></div>
<h4 id="_tt_path_parameters_tt_tt_query_parameters_tt_i_tt_request_parameters_tt">9.1.1. <tt>path_parameters</tt>, <tt>query_parameters</tt> i <tt>request_parameters</tt></h4>
<div class="paragraph"><p>Railsy gromadzą wszystkie parametry przesłane wraz z żądaniem w tablicy haszującej <tt>params</tt>, bez względu czy zostały przesłane jako część ciągu zapytania czy jako zawartość POST. Obiekt request posiada trzy akcesory (ang. accessors) umożliwiające ci dostęp do tych parametrów w zależności od ich pochodzenia. Tablica haszująca <tt>query_parameters</tt> zawiera parametry, które były wysłane jako część ciągu zapytania, natomiast tablica haszująca <tt>request_parameters</tt> zawiera parametry wysłane jako POST. Tablica haszująca <tt>path_parameters</tt> zawiera parametry, które zostały rozpoznane przez routing jako część ścieżki prowadzącej do tego konkretnego kontrolera i akcji.</p></div>
<h3 id="_obiekt_tt_response_tt">9.2. Obiekt <tt>response</tt></h3>
<div class="paragraph"><p>Obiekt <tt>response</tt> nie jest zazwyczaj stosowany od razu, ale jest tworzony w
trakcie wykonywania akcji i renderuje dane, które są przesyłane z powrotem do
użytkownika. Ale czasami - jak w przypadku filtrów końcowych -  może być potrzebny dostęp do tych danych natychmiast. Niektóre z tych akcesorów posiadają jeszcze settery (ang. setters), umożliwiające ci zmianę wartości.</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>body</tt> - jest to ciąg danych przesyłanych z powrotem do klienta. Najczęściej jest to HTML.
</p>
</li>
<li>
<p>
<tt>status</tt> - kod statusu HTTP, na przykład 200 dla pomyślnie zrealizowanego żądania, lub 404 gdy plik nie został znaleziony.
</p>
</li>
<li>
<p>
<tt>location</tt> - adres URL pod który klient jest przekierowywany (o ile jest).
</p>
</li>
<li>
<p>
<tt>content_type</tt> - typ zawartości zwracanych danych.
</p>
</li>
<li>
<p>
<tt>charset</tt> - kodowanie znaków, zazwyczaj ustawione na"utf8".
</p>
</li>
<li>
<p>
<tt>headers</tt> - nagłówki użyte w zwracanych danych.
</p>
</li>
</ul></div>
<h4 id="_ustawienie_niestandardowych_nag_wk_w">9.2.1. Ustawienie niestandardowych nagłówków</h4>
<div class="paragraph"><p>Jeśli chcesz ustawić niestandardowe nagłówki dla danych zwrotnych, miejscem na
to jest <tt>response.headers</tt>. Atrybut headers jest tablicą haszującą, który
mapuje nazwę nagłówka na jego wartość, a Railsy ustawiają niektóre z nich -
np. <tt>Content-Type</tt> - automatycznie. Jeśli chcesz dodać lub zmienić nagłówek, dopisz go do <tt>headers</tt> z nazwą i wartością:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>response<span style="color: #990000">.</span>headers<span style="color: #990000">[</span><span style="color: #FF0000">"Content-Type"</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"application/pdf"</span></tt></pre></div></div>
</div>
<h2 id="_podstawowe_uwierzytelnianie_http">10. Podstawowe uwierzytelnianie HTTP</h2>
<div class="sectionbody">
<div class="paragraph"><p>Railsy mają wbudowany mechanizm podstawowego uwierzyrzytelniania HTTP. Jest to system uwierzytelniania, który jest obsługiwany przez większość przeglądarek i innych klientów HTTP. Jako przykład, rozważmy sekcję administracyjną, która będzie dostępna tylko po wprowadzeniu nazwy użytkownika i hasła do podstawowego okna dialogowego HTTP przeglądarki. Korzystanie z tego wbudowanego uwierzytelniania jest całkiem proste i wymaga jedynie użycia jednej metody - <tt>authenticate_or_request_with_http_basic</tt></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> AdminController <span style="color: #990000">&lt;</span> ApplicationController

  USERNAME<span style="color: #990000">,</span> PASSWORD <span style="color: #990000">=</span> <span style="color: #FF0000">"humbaba"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8"</span>

  before_filter <span style="color: #990000">:</span>authenticate

private

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> authenticate
    authenticate_or_request_with_http_basic <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>username<span style="color: #990000">,</span> password<span style="color: #990000">|</span>
      username <span style="color: #990000">==</span> USERNAME <span style="color: #990000">&amp;&amp;</span> Digest<span style="color: #990000">::</span>SHA1<span style="color: #990000">.</span>hexdigest<span style="color: #990000">(</span>password<span style="color: #990000">)</span> <span style="color: #990000">==</span> PASSWORD
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>W tym miejscu możesz utworzyć kontrolery w odpowiedniej przestrzeni nazw,
które będą dziedziczyć z klasy <tt>AdminController</tt>. Filtr wstępny będzie zatem wywoływany dla wsztskich akcji w tamtych kontrolerach, chroniąc je przy użyciu podstawowego uwierzytelniania HTTP.</p></div>
</div>
<h2 id="_przesy_anie_strumieniowe_i_pobieranie_plik_w">11. Przesyłanie strumieniowe i pobieranie plików</h2>
<div class="sectionbody">
<div class="paragraph"><p>Czasami możesz chcieć przesłać do użytkownika plik zamiast renderować stronę HTML. Wszystkie kontrolery w Railsach posiadają metody <tt>send_data</tt> i <tt>send_file</tt>, obie z nich przesyłają strumieniowo dane do klienta. <tt>send_file</tt> jest wygodną metodą, która pozwala dostarczyć nazwę pliku znajdującego się na dysku i przesłać zawartość tego pliku.</p></div>
<div class="paragraph"><p>Aby przesłać dane do klienta, użyj <tt>send_data</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">require</span></span> <span style="color: #FF0000">"prawn"</span>
<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ClientsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-style: italic"><span style="color: #9A1900"># Generate a PDF document with information on the client and return it.</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># The user will get the PDF as a file download.</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> download_pdf
    client <span style="color: #990000">=</span> Client<span style="color: #990000">.</span>find<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span>
    send_data<span style="color: #990000">(</span>generate_pdf<span style="color: #990000">,</span> <span style="color: #990000">:</span>filename <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"#{client.name}.pdf"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>type <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"application/pdf"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

private

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> generate_pdf<span style="color: #990000">(</span>client<span style="color: #990000">)</span>
    Prawn<span style="color: #990000">::</span>Document<span style="color: #990000">.</span>new <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
      text client<span style="color: #990000">.</span>name<span style="color: #990000">,</span> <span style="color: #990000">:</span>align <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>center
      text <span style="color: #FF0000">"Address: #{client.address}"</span>
      text <span style="color: #FF0000">"Email: #{client.email}"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">.</span>render
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Akcja <tt>download_pdf</tt> w przykładzie powyżej wezwie prywatną metodę, która
właściwie generuje plik (dokument PDF) i zwróci to jako string. Ten string
będzie następnie przesłany do klienta jako plik do pobrania, a nazwa pliku
będzie użytkownikowi sugerowana. Czasami kiedy  przesyłasz pliki do
użytkownika, możesz nie chcieć, aby plik był do pobrania. Weźmy na przykład
obrazki, które są wbudowane w treść strony HTML. Aby poinformować
przeglądarkę, że plik nie jest do pobrania, możesz ustawić opcję
<tt>:disposition</tt> na <tt>inline</tt>. Przeciwną i zarazem domyślną wartością dla tej
opcji jest <tt>attachment</tt>.</p></div>
<h3 id="_wysy_anie_plik_w">11.1. Wysyłanie plików</h3>
<div class="paragraph"><p>Jeżeli chcesz wysłać plik, który już istnieje na dysku, użyj metody <tt>send_file</tt>. Jest to zwykle nie zalecane, ale może być przydatne, jeżeli chcesz wykonać jakąś weryfikację przed pozwoleniem użytkownikowi na pobranie tego pliku.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ClientsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-style: italic"><span style="color: #9A1900"># Stream a file that has already been generated and stored on disk</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> download_pdf
    client <span style="color: #990000">=</span> Client<span style="color: #990000">.</span>find<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span>
    send_data<span style="color: #990000">(</span><span style="color: #FF0000">"#{RAILS_ROOT}/files/clients/#{client.id}.pdf"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>filename <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"#{client.name}.pdf"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>type <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"application/pdf"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ta metoda będzie czytać i przesyłać strumieniowo plik w blokach po 4 Kb, unikając ładowania całego pliku do pamięci na raz. Możesz wyłączyć strumieniowanie poprzez opcję <tt>:stream</tt> albo ustawić rozmiar bloku poprzez opcję <tt>:buffer_size</tt>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content">Bądź ostrożny kiedy używasz (lub po prostu nie używaj) zewnętrznych danych (parametrów, cookis, itp) do zlokalizowania pliku na dysku, jest to ryzykowne z punktu widzenia bezpieczeństwa i może pozwolić komuś na uzyskanie dostępu do plików które nie są przeznaczone do oglądania.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Nie zaleca się przesyłania statycznych plików przez Railsy, jeśli możesz
zamiast tego trzymaj je w folderze publicznym na twoim serwerze. O wiele
bardziej efektywne jest umożliwienie użytkownikowi pobierania pliku
bezpośrednio za pomocą serwera Apache lub innego serwera www, ponieważ
utrzymywane żądanie przechodzi niepotrzebnie przez cały stos Railsów. Jednak
jeśli potrzebujesz aby z jakiegoś powodu żądanie przeszło przez Railsy możesz
ustawić opcję <tt>:x_sendfile</tt> na <tt>true</tt>, wówczas Railsy pozwolą serwerowi www
obsłużyć wysyłanie pliku do użytkownika, uwalniając od tego proces Railsów.
Pamiętaj, że Twój serwer www musi obsługiwać nagłówek <tt>X-Sendfile</tt>, oraz musisz uważać, aby nie używać wejścia użytkownika w sposób, który pozwoli komuś na pobieranie przypadkowych plików.</td>
</tr></table>
</div>
<h3 id="_pobieranie_plik_w_w_aplkacjach_restful">11.2. Pobieranie plików w aplkacjach RESTful</h3>
<div class="paragraph"><p>Chociaż metoda <tt>send_data</tt> działa całkiem dobrze, jeśli tworzysz aplikację
RESTful posiadającą osobne akcje dla pobierania plików, zwykle będzie ona
niepotrzebna. W terminologii REST, plik PDF z przykładu powyżej można uznać za
kolejną reprezentację danych zwracachych do klienta. Railsy zapewniają łatwy i
dosyć gładki sposób na "RESTful downloads". Oto jak możesz przepisać wcześniejszy przykład, tak aby pobranie pliku PDF było częścią akcji <tt>show</tt>, bez przesyłania strumieniowego:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ClientsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-style: italic"><span style="color: #9A1900"># The user can request to receive this resource as HTML or PDF.</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> show
    <span style="color: #009900">@client</span> <span style="color: #990000">=</span> Client<span style="color: #990000">.</span>find<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span>

    respond_to <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>format<span style="color: #990000">|</span>
      format<span style="color: #990000">.</span>html
      format<span style="color: #990000">.</span>pdf<span style="color: #FF0000">{</span> render <span style="color: #990000">:</span>pdf <span style="color: #990000">=&gt;</span> generate_pdf<span style="color: #990000">(</span><span style="color: #009900">@client</span><span style="color: #990000">)</span> <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Aby ten przykład zadziałał, musisz dodać typ PDF jako MIME type w Railsach. Można to zrobić poprzez dodanie następującej linii do pliku <tt>config/initializers/mime_types.rb</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Mime<span style="color: #990000">::</span>Type<span style="color: #990000">.</span>register <span style="color: #FF0000">"application/pdf"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>pdf</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Pliki konfiguracyjne nie są wczytywane przy kazdym żądaniu, więc musisz uruchomić ponownie serwer, aby uaktywnić zmiany.</td>
</tr></table>
</div>
<div class="paragraph"><p>Teraz użytkownik może zażądać pobrania wersji PDF strony tylko przez dodanie rozszerzenia ".pdf" do adresu URL:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>GET /clients/1.pdf</tt></pre>
</div></div>
</div>
<h2 id="_filtrowanie_parametr_w">12. Filtrowanie parametrów</h2>
<div class="sectionbody">
<div class="paragraph"><p>Railsy trzymają pliki logów dla każdego środowiska (rozwojowego, testowania i
produkcji) w folderze <tt>log</tt>. Są one niezwykle przydatne podczas debugowania,
żeby zobaczyć co faktycznie działo się w aplikacji, ale w czasie późniejszego
działania aplikacji możesz nie chcieć, żeby każda informacja była zapisywany w
pliku logu. Metoda <tt>filter_parameter_logging</tt> może być używana do
odfiltrowywania poufnych informacji z logu. Działa ona poprzez zastępowania
pewnych wartości z tablicy haszującej <tt>params</tt> przez "[FILTERED]" przy
zapisywaniu do logu. Jako przykład zobaczmy, jak filtrować wszystkie parametry
z kluczem zawierającym <tt>password</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

  filter_parameter_logging <span style="color: #990000">:</span>password

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Metoda działa rekursywnie na wszystkich poziomach tablicy haszującej params.
Może przyjmować drugi opcjonalny parametr, który jeśli występuje, jest używany
jako tekst zastępujący. Funkcja ta może też przyjąć blok, który sprawdza warunek dla każdego klucza i zastępuje te, dla których blok zwraca ‘true’.</p></div>
</div>
<h2 id="_obs_uga_b_d_w">13. Obsługa błędów</h2>
<div class="sectionbody">
<div class="paragraph"><p>Jest bardzo prawdopodobne, że twoja aplikacja będzie zawierać błędy albo w
innym razie będzie wyrzucać jakieś wyjątki, które muszą być rozpatrzone. Na
przykład, jeśli użytkownik użyje linka do zasobu, który już nie istnieje w
bazie danych, moduł Active Record rzuci wyjąkiem
<tt>ActiveRecord::RecordNotFound</tt>. Przy wystąpieniu jakiegokolwiek wyjątku Railsy
domyślnie wyświetlają komunikat błędu 500, czyli wewnętrzny błąd serwera (500
Server Error). Jeżeli żądanie było wywołane lokalnie, dzięki prześledzeniu go
od początku i kilku dodatkowym informacjom, które zostaną wyświetlone, możesz
dowiedzieć się, co poszło źle i jak sobie z tym poradzić. Jeżeli żądanie było
zdalne, Railsy wyświetlą tylko zwykły komunikat  "500 Server Error" lub "404
Not Found", jeżeli jest to błąd routingu albo zapis nie został znaleziony.
Czasami możesz chcieć dostosować sposób, w jaki te błędy będą złapane i jak
zostaną wyświetlone użytkownikowi. Istnieje kilka poziomów obsługi wyjątków
dostępnych w aplikacjach Railsowych, które omówione są niżej.</p></div>
<h3 id="_domy_lne_szablony_b_d_w_500_and_404">13.1. Domyślne szablony błędów 500 and 404</h3>
<div class="paragraph"><p>Domyślnym działaniem aplikacji jest wyrenderowanie komunikatu błędu 404 lub 500. Komunikaty te zawarte są w statycznych plikach HTML w katalogu <tt>public</tt>, odpowiednio w plikach <tt>404.html</tt> i <tt>500.html</tt>. Możesz dostosować te pliki poprzez zamieszczenie kilku dodatkowych informacji i rozmieszczenie graficzne, ale pamiętaj, że są to pliki statyczne, tzn. nie możesz użyć w nich RHTML lub layoutów, tylko czysty HTML.</p></div>
<h3 id="_tt_rescue_from_tt">13.2. <tt>rescue_from</tt></h3>
<div class="paragraph"><p>Jeżeli chcesz zrobić coś bardziej wymyślnego dla obsługi błędu, możesz użyć <tt>rescue_from</tt>, który obsługuje wyjątki pewnego typu (lub wielu typów) w całym kontrolerze i jego podklasach. Kiedy pojawia się wyjątek, który złapany został przez dyrektywę <tt>rescue_from</tt> obiekt wyjątku zostaje przekazany do  handlera. Handler może być metodą lub obiektem Proc przekazywanym do opcji <tt>:with</tt>. Możesz także użyć bezpośrednio bloku, zamiast wyraźnego obiektu Proc.</p></div>
<div class="paragraph"><p>Oto jak możesz użyć <tt>rescue_from</tt> do przechwycenia wszystkich błędów
<tt>ActiveRecord::RecordNotFound</tt> i zrobienia czegoś z nimi.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

  rescue_from ActiveRecord<span style="color: #990000">::</span>RecordNotFound<span style="color: #990000">,</span> <span style="color: #990000">:</span>with <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>record_not_found

private

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> record_not_found
    render <span style="color: #990000">:</span>text <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"404 Not Found"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>status <span style="color: #990000">=&gt;</span> <span style="color: #993399">404</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Oczywiście ten przykład jest niczym więcej jak opracowaniem i w ogóle nie polepsza domyślnej obsługi błędów, ale kiedyś możesz chcieć złapać wszystkie wyjątki, wtedy będziesz mógł zrobić z nimi co tylko chcesz. Na przykład, możesz utworzyć własne klasy wyjątków, które zostaną rzucone, jeśli użytkownik nie ma dostępu do niektórych części aplikacji:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ApplicationController <span style="color: #990000">&lt;</span> ActionController<span style="color: #990000">::</span>Base

  rescue_from User<span style="color: #990000">::</span>NotAuthorized<span style="color: #990000">,</span> <span style="color: #990000">:</span>with <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>user_not_authorized

private

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> user_not_authorized
    flash<span style="color: #990000">[:</span>error<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"You don't have access to this section."</span>
    redirect_to <span style="color: #990000">:</span>back
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ClientsController <span style="color: #990000">&lt;</span> ApplicationController

  <span style="font-style: italic"><span style="color: #9A1900"># Check that the user has the right authorization to access clients.</span></span>
  before_filter <span style="color: #990000">:</span>check_authorization

  <span style="font-style: italic"><span style="color: #9A1900"># Note how the actions don't have to worry about all the auth stuff.</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> edit
    <span style="color: #009900">@client</span> <span style="color: #990000">=</span> Client<span style="color: #990000">.</span>find<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

private

  <span style="font-style: italic"><span style="color: #9A1900"># If the user is not authorized, just throw the exception.</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> check_authorization
    <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> User<span style="color: #990000">::</span>NotAuthorized <span style="font-weight: bold"><span style="color: #0000FF">unless</span></span> current_user<span style="color: #990000">.</span>admin?
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Niektóre wyjątki są obsługiwalne tylko w klasie ApplicationController, ponieważ występują zanim sam kontroler zostanie zainicjalizowany i będzie mógł podjąć akcję. Zobacz <a href="http://m.onkey.org/2008/7/20/rescue-from-dispatching">artykuł</a> autorstwa Pratik&#8217;a Naik&#8217;a na ten temat, aby zaczerpnąć więcej informacji.</td>
</tr></table>
</div>
</div>
<h2 id="_changelog">14. Changelog</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="http://rails.lighthouseapp.com/projects/16213-rails-guides/tickets/17">Lighthouse ticket</a></p></div>
<div class="ulist"><ul>
<li>
<p>
November 4, 2008: First release version by Tore Darrell
</p>
</li>
</ul></div>
</div>

    </div>
  </div>
</body>
</html>
