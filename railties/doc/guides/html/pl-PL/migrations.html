<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Migracje</title>
  <!--[if lt IE 8]>
  <script src="http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE8.js" type="text/javascript"></script>
  <![endif]-->
  <link href="stylesheets/base.css" media="screen" rel="Stylesheet" type="text/css" />
  <link href="stylesheets/forms.css" media="screen" rel="Stylesheet" type="text/css" />
  <link href="stylesheets/more.css" media="screen" rel="Stylesheet" type="text/css" />
</head>
<body>
  <div id="header" >
    <div id="logo">
      <a href="index.html" title="Ruby on Rails"><img src="images/rails_logo_remix.gif" alt="Rails" height="140" width="110" /></a>
    </div>

    <h1 id="site_title"><span>Ruby on Rails</span></h1>
    <h2 id="site_title_tagline">Sustainable productivity for web-application development</h2>

    <ul id="navMain">
      <li class="first-child"><a href="http://www.rubyonrails.org/" title="Ruby on Rails" class="ruby_on_rails">Ruby on Rails</a></li>
      <li><a class="manuals" href="index.html" title="Manuals Index">Guides Index</a></li>
    </ul>
  </div>

  <div id="container">
    
    <div id="sidebar">
      <h2>Chapters</h2>
      <ol>
          <li>
          <a href="#_anatomia_migracji">Anatomia migracji</a>
            <ul>
            
              <li><a href="#_migracje_s_klasami">Migracje są klasami</a></li>
            
              <li><a href="#_co_kryje_si_w_nazwie">Co kryje się w nazwie</a></li>
            
              <li><a href="#_zmiany_w_migracjach">Zmiany w migracjach</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_tworzenie_migracji">Tworzenie migracji</a>
            <ul>
            
              <li><a href="#_tworzenie_modelu">Tworzenie modelu</a></li>
            
              <li><a href="#_tworzenie_samodzielnej_migracji">Tworzenie samodzielnej migracji</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_pisanie_migracji">Pisanie migracji</a>
            <ul>
            
              <li><a href="#_tworzenie_tabeli">Tworzenie tabeli</a></li>
            
              <li><a href="#_zmienianie_tabel">Zmienianie tabel</a></li>
            
              <li><a href="#_specjalne_helpery">Specjalne helpery</a></li>
            
              <li><a href="#_tworzenie_metody_down">Tworzenie metody down</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_wykonywanie_migracji">Wykonywanie migracji</a>
            <ul>
            
              <li><a href="#_wycofywanie_migracji">Wycofywanie migracji</a></li>
            
              <li><a href="#_wywo_ywanie_konkretnej_migracji">Wywoływanie konkretnej migracji</a></li>
            
              <li><a href="#_komunikaty">Komunikaty</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#models">Użycie modeli w migracjach</a>
            <ul>
            
              <li><a href="#_praca_na_zmieniaj_cych_si_modelach">Praca na zmieniających się modelach</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_zrzuty_schemat_w">Zrzuty schematów</a>
            <ul>
            
              <li><a href="#schema">Po co tworzyć pliki schematów?</a></li>
            
              <li><a href="#_typy_zrzut_w_schematu">Typy zrzutów schematu</a></li>
            
              <li><a href="#_kontrola_wersji_zrzut_w_schemat_w">Kontrola wersji zrzutów schematów</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#foreign_key">Active Record i integralność referencyjna</a>
          </li>
          <li>
          <a href="#_changelog">Changelog</a>
          </li>
      </ol>
    </div>
    
    <div id="content">
        <h1>Migracje</h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Migracje są wygodnym sposobem, by w zorganizowany sposób modyfikować bazę
danych. Mógłbyś oczywiście edytować fragmenty kodu SQL ręcznie, ale musiałbyś
potem samemu zatroszczyć się o to, by poinformować innych projektantów o konieczności wykonania potrzebnych zmian. Musiałbyś też pilnować jakie zmiany należy wprowadzić na serwerze, na którym działa ostateczna wersja tworzonego serwisu. Moduł Active Record śledzi migracje, które zostały już wykonane, więc jedyne co musisz wykonać ze swojej strony, to wprowadzenie zmian w kodzie i wykonanie polecenia <tt>rake db:migrate</tt>. Moduł Active Record sam zdecyduje, które migracje powinny zostać wykonane. Zaktualizuje on też schemat bazy danych zawarty w pliku db/schema.rb tak, by odpowiadał on aktualnej strukturze Twojej bazy.</p></div>
<div class="paragraph"><p>Migracje pozwalają na opisanie zmian bazy danych w Rubim. Dzięki temu,
podobnie jak większość funkcji modułu Active Record, nie zależą one od
używanego przez Ciebie systemu zarządzania bazą danych. Nie musisz więc martwić się o dokładną składnię komendy CREATE TABLE ani zastanawiać się nad różnymi wariacjami polecenia SELECT *. Możesz na przykład użyć SQLite3 podczas tworzenia, a MySQL w gotowym, udostępnionym serwisie.</p></div>
<div class="paragraph"><p>W poniższym przewodniku dowiesz się wszystkiego o migracjach. W szczególności, tekst opisuje:</p></div>
<div class="ulist"><ul>
<li>
<p>
generatory używane przy tworzeniu migracji
</p>
</li>
<li>
<p>
metody modułu Active Record służące do modyfikacji bazy danych
</p>
</li>
<li>
<p>
zadania Rake działające na migracjach
</p>
</li>
<li>
<p>
powiązania między migracjami a plikiem schema.rb
</p>
</li>
</ul></div>
</div>
</div>
<h2 id="_anatomia_migracji">1. Anatomia migracji</h2>
<div class="sectionbody">
<div class="paragraph"><p>Zanim zagłębimy się w detale migracji, przedstawiam kilka przykładów ilustrujących ich możliwości:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> CreateProducts <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
      t<span style="color: #990000">.</span>string <span style="color: #990000">:</span>name
      t<span style="color: #990000">.</span>text <span style="color: #990000">:</span>description

      t<span style="color: #990000">.</span>timestamps
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    drop_table <span style="color: #990000">:</span>products
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ta migracja tworzy tabelę <tt>products</tt> z kolumną o nazwie <tt>name</tt> typu string oraz kolumną tekstową <tt>description</tt>. Zostanie również utworzona domyślna kolumna ID, bedąca kluczem głównym tabeli, ale ponieważ jest to domyślna kolumna każdej tabeli, nie musimy jej nawet definiować. Kolumny zawierające znaczniki czasu (timestamp) <tt>created_at</tt> i <tt>updated_at</tt> również zostaną automatycznie dodane przez moduł Active Record. Odwrócenie takiej migracji to po prostu usunięcie tabeli.</p></div>
<div class="paragraph"><p>Możliwości migracji nie ograniczają się do zmiany schematu bazy danych. Przy ich pomocy można także poprawić błędne dane lub uzupełniać nowe pola:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> AddReceiveNewsletterToUsers <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    change_table <span style="color: #990000">:</span>users <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
      t<span style="color: #990000">.</span>boolean <span style="color: #990000">:</span>receive_newsletter<span style="color: #990000">,</span> <span style="color: #990000">:</span>default <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
    User<span style="color: #990000">.</span>update_all <span style="color: #990000">[</span><span style="color: #FF0000">"receive_newsletter = ?"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    remove_column <span style="color: #990000">:</span>users<span style="color: #990000">,</span> <span style="color: #990000">:</span>receive_newsletter
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ta migracja dodaje kolumnę <tt>receive_newsletter</tt> do tabeli <tt>users</tt>. Pole to
mówi nam o przypisaniu użytkownika na listę odbiorców aktualności. Chcemy, by
domyślnie zawierało ono wartość false dla nowych użytkowników, ale użytkownicy
juz zarejestrowani są zgłoszeni do otrzymywania aktualności, więc możemy użyć
modelu <tt>User</tt> do ustawienia dla nich flagi <tt>reveive_newsletter</tt> jako <tt>true</tt>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content"><a href="#models">Ostrzeżenie</a> dotyczące używania modeli w migracjach.</td>
</tr></table>
</div>
<h3 id="_migracje_s_klasami">1.1. Migracje są klasami</h3>
<div class="paragraph"><p>Migracja jest podklasą klasy ActiveRecord::Migration, która posiada
zaimplementowane dwie metody: <tt>up</tt> (wykonaj żądane transformacje) i <tt>down</tt>
(wycofaj je).</p></div>
<div class="paragraph"><p>Moduł Active Record udostępnia metody, służące do typowych operacji na bazach danych w sposób niezależny od typu używanej bazy (ich dokładniejszy opis będzie zamieszczony w dalszej części):</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>create_table</tt>
</p>
</li>
<li>
<p>
<tt>change_table</tt>
</p>
</li>
<li>
<p>
<tt>drop_table</tt>
</p>
</li>
<li>
<p>
<tt>add_column</tt>
</p>
</li>
<li>
<p>
<tt>remove_column</tt>
</p>
</li>
<li>
<p>
<tt>change_column</tt>
</p>
</li>
<li>
<p>
<tt>rename_column</tt>
</p>
</li>
<li>
<p>
<tt>add_index</tt>
</p>
</li>
<li>
<p>
<tt>remove_index</tt>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Jeśli chcesz wykonać zadanie specyficzne tylko dla Twojego typu bazy danych
(np. utworzyć <a href="#foreign_key">klucz obcy</a>), możesz do tego celu wykorzystać
funkcję <tt>execute</tt>, która umożliwia Ci wykonanie kodu SQL. Migracja jest zwykłą klasą Ruby, więc nie musisz ograniczać się do tych funkcji. Przykładowo, możesz po dodaniu kolumny dopisać kod odpowiedzialny za przypisanie jej odpowiedniej wartości we wszystkich istniejących rekordach.</p></div>
<div class="paragraph"><p>W bazach danych obsługujących transakcje zmieniające schemat bazy danych
(takich jak PostgreSQL), migracje są realizowane jako transakcje. Jeśli baza
danych nie posiada takiej funkcjonalności (np. MySQL i SQLite), w przypadku
niepowodzenia migracji, etapy już wykonane nie zostaną automatycznie wycofane.
Wymaga to ręcznego usunięcia już wprowadzonych zmian.</p></div>
<h3 id="_co_kryje_si_w_nazwie">1.2. Co kryje się w nazwie</h3>
<div class="paragraph"><p>Każda klasa migracji jest przechowywana w oddzielnym pliku w katalogu
<tt>db/migrate</tt>. Nazwa pliku posiada format <tt>YYYYMMDDHHMMSS_create_products.rb</tt>, zawierającym znacznik czasowy (w czasie UTC) oraz - po podkreślniku - nazwę migracji. Nazwa taka musi się zgadzać z migracją, którą plik zawiera, np:
<tt>20080906120000_create_products</tt> powinna definiować migrację CreateProducts, a
<tt>20080906120001_add_details_to_products</tt> - migrację AddDetailsToProducts. Jeśli z jakichś przyczyn zmienisz nazwę pliku, MUSISZ poprawić także nazwę klasy - w przeciwnym wypadku Railsy będą informowały Cię o braku wymaganej klasy.</p></div>
<div class="paragraph"><p>Railsy wykorzystują jedynie numer migracji (czyli jej znacznik czasowy) do jej identyfikacji. Wersje wcześniejsze niż 2.1 numerowały migracje liczbami naturalnymi począwszy od 1, przypisując każdej nowej migracji kolejną liczbę. W przypadku pracy w zespołach kolizje oznaczeń były nieuniknione, co wymagało wycofania zmian i przenumerowania wszystkich migracji. Od wersji 2.1 rozwiązano ten problem identyfikując migrację poprzez datę jej utworzenia. Można przywrócić starszy sposób numeracji, ustawiając w pliku <tt>environment.rb</tt> zmienną <tt>config.active_record.timestamped_migrations</tt> na wartość <tt>false</tt>.</p></div>
<div class="paragraph"><p>Dzięki nowemu sposobowi numeracji oraz monitorowaniu które migracje już zostały wykonane, Railsy rozwiązują wiele częstych problemów powstających przy pracy zespołowej nad jednym projektem.</p></div>
<div class="paragraph"><p>Przykładowo, Ania tworzy migracje <tt>20080906120000</tt> i <tt>20080906123000</tt>, a Bartek tworzy <tt>20080906124500</tt> i ją wykonuje. Ania kończy wprowadzać zmiany, a Bartek wycofuje swoją migrację. Railsy wiedzą, że migracje Ani nie zostały wykonane, więc <tt>rake db:migrate</tt> wykona je (pomimo tego, że późniejsza migracja stworzona przez Bartka już została wykonana). Analogicznie, polecenie wycofania migracji pominie niewykonane jeszcze migracje Ani.</p></div>
<div class="paragraph"><p>Oczywiście nie zastąpi to w pełni komunikacji wewnątrz zespołu. Na przykład, jeśli migracja Ani usunęła tabelę wykorzystywaną przez migrację Bartka, problem i tak wystąpi.</p></div>
<h3 id="_zmiany_w_migracjach">1.3. Zmiany w migracjach</h3>
<div class="paragraph"><p>Czasem popełnisz błąd podczas tworzenia migracji. Jeśli już ją wykonałeś, nie
możesz po prostu jej wyedytować i wykonać ją ponownie: Railsy uznają, że została już wykonana i kolejne wpisanie komendy <tt>rake db:migrate</tt> nie zaowocuje wprowadzeniem poprawek. Musisz w tym celu wycofać migrację (np. komendą <tt>rake db:rollback</tt>), poprawić błędy w migracji i ponownie ją wykonać poleceniem <tt>rake db:migrate</tt>.</p></div>
<div class="paragraph"><p>Ogólnie rzecz biorąc, edycja istniejących migracji nie jest dobrym pomysłem: dodajesz tym samym pracy sobie i swoim współpracownikom. Może to być przyczyną poważnych kłopotów, jeżeli Twoja migracja została już uruchomiona na docelowym serwerze. Lepszym rozwiązaniem jest stworzenie nowej migracji, która wprowadzi wymagane zmiany. Edycja świeżo utworzonej migracji, która nie została jeszcze przekazana na serwer docelowy jest stosunkowo bezpieczna.</p></div>
</div>
<h2 id="_tworzenie_migracji">2. Tworzenie migracji</h2>
<div class="sectionbody">
<h3 id="_tworzenie_modelu">2.1. Tworzenie modelu</h3>
<div class="paragraph"><p>Generatory modelu i rusztowania (<em>scaffold</em>) utworzą migrację odpowiednią dla tworzonego modelu. Migracja taka zawiera od razu instrukcje potrzebne do utworzenia powiązanej z danym modelem tablicy. Jeśli powiesz Railsom jakie kolumny powinny znaleźć się w tej tabeli, do migracji zostaną dodane odpowiednie formuły. Przykładowo, wykonanie polecenia</p></div>
<div class="paragraph"><p><tt>ruby script/generate model Product name:string description:text</tt></p></div>
<div class="paragraph"><p>spowoduje stworzenie następującej migracji:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> CreateProducts <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
      t<span style="color: #990000">.</span>string <span style="color: #990000">:</span>name
      t<span style="color: #990000">.</span>text <span style="color: #990000">:</span>description

      t<span style="color: #990000">.</span>timestamps
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    drop_table <span style="color: #990000">:</span>products
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Możesz dołączyć tyle par kolumna/typ ile potrzebujesz. Domyślnie zostaną dodane znaczniki czasu <tt>t.timestamps</tt> (które powodują automatyczne utworzenie przez moduł Active Record kolumn <tt>updated_at</tt> i <tt>created_at</tt>).</p></div>
<h3 id="_tworzenie_samodzielnej_migracji">2.2. Tworzenie samodzielnej migracji</h3>
<div class="paragraph"><p>Jeśli tworzysz migracje dla innych celów (np. aby dodać kolumnę do istniejącej już tabeli), możesz skorzystać z generatora migracji:</p></div>
<div class="paragraph"><p><tt>ruby script/generate migration AddPartNumberToProducts</tt></p></div>
<div class="paragraph"><p>Ta komenda utworzy pustą, lecz odpowiednio nazwaną i skonstruowaną migrację:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> AddPartNumberToProducts <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Jeśli nazwa podana w poleceniu generatora migracji jest formatu AddXXXToYYY lub RemoveXXXFromYYY i po niej wymieniona jest lista kolumn i ich typów, to w wyniku utworzona zostanie migracja z odpowiednimi poleceniami dodania/usunięcia kolumny, przykładowo:</p></div>
<div class="paragraph"><p><tt>ruby script/generate migration AddPartNumberToProducts part_number:string</tt></p></div>
<div class="paragraph"><p>wygeneruje migrację:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> AddPartNumberToProducts <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    add_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>part_number<span style="color: #990000">,</span> <span style="color: #990000">:</span>string
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    remove_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>part_number
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Analogicznie, komenda</p></div>
<div class="paragraph"><p><tt>ruby script/generate migration RemovePartNumberFromProducts part_number:string</tt></p></div>
<div class="paragraph"><p>generuje</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> RemovePartNumberFromProducts <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    remove_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>part_number
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    add_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>part_number<span style="color: #990000">,</span> <span style="color: #990000">:</span>string
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Przy tworzeniu migracji nie musisz ograniczać się do jednej kolumny, na przykład:</p></div>
<div class="paragraph"><p><tt>ruby script/generate migration AddDetailsToProducts part_number:string price:decimal</tt></p></div>
<div class="paragraph"><p>wygeneruje migrację:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> AddDetailsToProducts <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    add_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>part_number<span style="color: #990000">,</span> <span style="color: #990000">:</span>string
    add_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>price<span style="color: #990000">,</span> <span style="color: #990000">:</span>decimal
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    remove_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>price
    remove_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>part_number
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Jak zwykle, wygenerowana migracja jest dopiero punktem startowym Twojej pracy. Możesz ją dalej modyfikować, dodając lub usuwając elementy.</p></div>
</div>
<h2 id="_pisanie_migracji">3. Pisanie migracji</h2>
<div class="sectionbody">
<div class="paragraph"><p>Jeśli już utworzyłeś migrację przy pomocy jednego z generatorów, najwyższy czas zabrać się do pracy!</p></div>
<h3 id="_tworzenie_tabeli">3.1. Tworzenie tabeli</h3>
<div class="paragraph"><p><tt>create_table</tt> jest jedną z najbardziej podstawowych komend. Jej typowe użycie ilustruje przykład:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>string <span style="color: #990000">:</span>name
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Przykład ten generuje tabelę <tt>products</tt> z kolumną o nazwie <tt>name</tt> (i, jak to omówimy w dalszej części, domyślną kolumną <tt>id</tt>).</p></div>
<div class="paragraph"><p>Obiekt przekazany (yielded) do bloku pozwala na tworzenie kolumn tabeli. Są na to dwa sposoby. Pierwszy z nich wygląda tak:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>column <span style="color: #990000">:</span>name<span style="color: #990000">,</span> <span style="color: #990000">:</span>string<span style="color: #990000">,</span> <span style="color: #990000">:</span>null <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Drugi sposób, tzw. "seksowne" migracje, nie korzysta z nadmiarowej metody
<tt>column</tt>. Zamiast niej wykorzystać można metody <tt>string</tt>, <tt>integer</tt> itp.,
które tworzą kolumny odpowiednich typów. Pozostałe parametry są identyczne do parametrów metody <tt>column</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>string <span style="color: #990000">:</span>name<span style="color: #990000">,</span> <span style="color: #990000">:</span>null <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Domyślnie <tt>create_table</tt> stworzy klucz główny nazwany <tt>id</tt>. Możesz zmienić jego nazwę korzystając z opcji <tt>:primiary_key</tt> (nie zapomnij poprawić powiązanego z tabelą modelu) lub, jeśli nie chcesz w ogóle klucza głównego (np. dla tabeli HABTM, realizującej relację typu wiele-do-wielu) możesz dodać <tt>id =&gt; false</tt>. Jeśli chcesz dodać opcję specyficzną dla konkretnego typu bazy danych, możesz umieścić fragment kodu SQL wewnątrz parametru <tt>:options</tt>. Na przykład:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>create_table <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>options <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"ENGINE=BLACKHOLE"</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>string <span style="color: #990000">:</span>name<span style="color: #990000">,</span> <span style="color: #990000">:</span>null <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Opcja ta doda <tt>ENGINE=BLACKHOLE</tt> do kodu SQL użytego do tworzenia tabeli (dla MySQL domyślny parametr to "ENGINE=InnoDB").</p></div>
<div class="paragraph"><p>Typy obsługiwane przez moduł Active Record to <tt>:primary_key</tt>, <tt>:string</tt>, <tt>:text</tt>, <tt>:integer</tt>, <tt>:float</tt>, <tt>:decimal</tt>, <tt>:datetime</tt>, <tt>:timestamp</tt>, <tt>:time</tt>, <tt>:date</tt>, <tt>:binary</tt>, <tt>:boolean</tt>.</p></div>
<div class="paragraph"><p>Zostaną one zrealizowane poprzez odpowiednie dla bazy danych typy danych, np.
w MySQL <tt>:string</tt> zostanie przetłumaczony na <tt>VARCHAR(255)</tt>. Możesz tworzyć
kolumny innych niż wymienione typów pod warunkiem, że nie używasz "seksownej" składni, przykładowo:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>column <span style="color: #990000">:</span>name<span style="color: #990000">,</span> <span style="color: #FF0000">'polygon'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>null <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Może to jednak uniemożliwić poprawne przeniesienie migracji na inny typ bazy danych.</p></div>
<h3 id="_zmienianie_tabel">3.2. Zmienianie tabel</h3>
<div class="paragraph"><p>Bliskim kuzynem <tt>create_table</tt> jest <tt>change_table</tt>. Komenda ta służy do zmiany istniejących już tabel i używana jest w analogiczny sposób jak <tt>create_table</tt>, jednak w jej wypadku obiekt przekazany do bloku daje o wiele większe możliwości. Przykładowo:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>change_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>remove <span style="color: #990000">:</span>description<span style="color: #990000">,</span> <span style="color: #990000">:</span>name
  t<span style="color: #990000">.</span>string <span style="color: #990000">:</span>part_number
  t<span style="color: #990000">.</span>index <span style="color: #990000">:</span>part_number
  t<span style="color: #990000">.</span>rename <span style="color: #990000">:</span>upccode<span style="color: #990000">,</span> <span style="color: #990000">:</span>upc_code
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ta komenda usuwa kolumnę <tt>description</tt>, dodaje kolumnę <tt>part_number</tt> i tworzy na niej indeks. Ostatnia metoda powoduje zmianę nazwy kolumny <tt>upccode</tt> na <tt>upc_code</tt>. Ten sam efekt można osiągnąć również następującym sposobem:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>remove_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>description
remove_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>name
add_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>part_number<span style="color: #990000">,</span> <span style="color: #990000">:</span>string
add_index <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>part_number
rename_column <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>upccode<span style="color: #990000">,</span> <span style="color: #990000">:</span>upc_code</tt></pre></div></div>
<div class="paragraph"><p>Stosując pierwszą składnię nie musisz powtarzać przy każdej komendzie nazwy tabeli - grupujesz wszystkie wykonane na niej operacje w jedną komendę. Dodatkowo nazwy transformacji są krótsze: <tt>remove_column</tt> zastępuje samo <tt>remove</tt> a <tt>add_index</tt> - po prostu <tt>index</tt>.</p></div>
<h3 id="_specjalne_helpery">3.3. Specjalne helpery</h3>
<div class="paragraph"><p>Moduł Active Record zapewnia kilka skrótów do najczęściej używanych opcji. Bardzo częste jest na przykład dodawanie kolumn <tt>created_at</tt> i <tt>updated_at</tt>, więc stworzono specjalną metodę, która to ułatwia:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>timestamps
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ten zapis spowoduje stworzenie nowej tabeli <tt>products</tt> z oboma wspomnianymi kolumnami, podczas gdy:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>change_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>timestamps
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>spowoduje dodanie tych kolumn do istniejącej tabeli.</p></div>
<div class="paragraph"><p>Inny helper nazywa się <tt>references</tt> (można też używać nazwy <tt>belongs_to</tt>). W najprostrzej postaci, poprawia on po prostu czytelność:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>references <span style="color: #990000">:</span>category
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ten zapis stworzy kolumnę <tt>category_id</tt> odpowiedniego typu. Zwróc uwagę na fakt, że w kodzie podajemy nazwę modelu, a nie kolumny. Moduł Active Record sam dodaje przyrostek <tt>_id</tt>. Jeśli potrzebujesz polimorficznych asocjacji, to <tt>references</tt> doda obie potrzebne kolumny:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
  t<span style="color: #990000">.</span>references <span style="color: #990000">:</span>attachment<span style="color: #990000">,</span> <span style="color: #990000">:</span>polymorphic <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #990000">:</span>default <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">'Photo'</span><span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ten zapis spowoduje dodanie kolumny <tt>attachment_id</tt> oraz drugiej kolumny <tt>attachment_type</tt> typu string, o domyślnej wartości Photo.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Helper <tt>references</tt> nie tworzy  <a href="#foreign_key">kluczy obcych</a>. Aby je dodać, musisz użyć metody <tt>execute</tt> lub skorzystać z wtyczki poszerzającej funkcjonalność modułu Active Record.</td>
</tr></table>
</div>
<div class="paragraph"><p>Jeśli helpery udostępniane przez moduł Active Record nie wystarczają do Twoich potrzeb, możesz użyc funkcji <tt>execute</tt> by wywołać kod SQL.
Aby zapoznać się z detalami i przykładami tworzenia własnych metod polecam dokumentację API, zwłaszcza <a href="http://api.rubyonrails.com/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html">ActiveRecord::ConnectionAdapters::SchemaStatements</a> (opis metod dostępnych w metodach <tt>up</tt> i <tt>down</tt>), <a href="http://api.rubyonrails.com/classes/ActiveRecord/ConnectionAdapters/TableDefinition.html">ActiveRecord::ConnectionAdapters::TableDefinition</a> (metody dostępne na obiekcie przekazanym przy pomocy komendy <tt>create_table</tt>) i <a href="http://api.rubyonrails.com/classes/ActiveRecord/ConnectionAdapters/Table.html">ActiveRecord::ConnectionAdapters::Table</a> (metody na obiekcie przekazanym przez <tt>change_table</tt>).</p></div>
<h3 id="_tworzenie_metody_down">3.4. Tworzenie metody down</h3>
<div class="paragraph"><p>Metoda <tt>down</tt> Twojej migracji powinna odwrócić transformacje wywołane przez metodę <tt>up</tt>. Innymi słowy, baza nie powinna ulec zmianie, jeśli wywołamy metodę <tt>up</tt> a po niej metodę <tt>down</tt>. Na przykład, jeśli w metodzie <tt>up</tt> tworzymy tabelę, to w metodzie <tt>down</tt> powinniśmy ją usunąć. Rozsądnie jest w metodzie <tt>down</tt> odwoływać wszystkie polecenia w dokładnie odwrotnej kolejności niż zostały one wywołane. Na przykład:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> ExampleMigration <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
      t<span style="color: #990000">.</span>references <span style="color: #990000">:</span>category
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">#add a foreign key</span></span>
    execute <span style="color: #FF0000">"ALTER TABLE products ADD CONSTRAINT fk_products_categories FOREIGN KEY (category_id) REFERENCES categories(id)"</span>

    add_column <span style="color: #990000">:</span>users<span style="color: #990000">,</span> <span style="color: #990000">:</span>home_page_url<span style="color: #990000">,</span> <span style="color: #990000">:</span>string

    rename_column <span style="color: #990000">:</span>users<span style="color: #990000">,</span> <span style="color: #990000">:</span>email<span style="color: #990000">,</span> <span style="color: #990000">:</span>email_address
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    rename_column <span style="color: #990000">:</span>users<span style="color: #990000">,</span> <span style="color: #990000">:</span>email_address<span style="color: #990000">,</span> <span style="color: #990000">:</span>email
    remove_column <span style="color: #990000">:</span>users<span style="color: #990000">,</span> <span style="color: #990000">:</span>home_page_url
    execute <span style="color: #FF0000">"ALTER TABLE products DROP FOREIGN KEY fk_products_categories"</span>
    drop_table <span style="color: #990000">:</span>products
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Czasem Twoja migracja wykona transformację, która jest nieodwracalna, na przykład usunie jakieś dane. W takim przypadku, możesz wywołać IrreverisbleMigration ze swojej metody <tt>down</tt>. W przypadku próby odwrócenia Twojej migracji wyświetlony zostanie komunikat informujący o braku możliwości cofnięcia migracji.</p></div>
</div>
<h2 id="_wykonywanie_migracji">4. Wykonywanie migracji</h2>
<div class="sectionbody">
<div class="paragraph"><p>Railsy zapewniają zestaw zadań Rake służących do działań na migracjach, sprowadzających się do wykonania określonych zestawów migracji. Prawdopodobnie najważniejszym zadaniem Rake jest <tt>db:migrate</tt>. W swojej najbardziej podstawowej formie wykonuje ona metodę <tt>up</tt> dla każdej migracji, która nie została jeszcze wywołana. Jeśli nie ma takich migracji, polecenie po prostu kończy swoje działanie.</p></div>
<div class="paragraph"><p>Warto zauważyć, że wywołanie <tt>db:migrate</tt> powoduje również uruchomienie zadania <tt>db:schema:dump</tt>, które zmienia zawartość pliku <tt>db/schema.rb</tt> tak, by odpowiadał on aktualnej strukturze bazy.</p></div>
<div class="paragraph"><p>Jeśli sprecyzujesz docelową wersję migracji, moduł Active Record wykona (lub odwoła) migracje wymagane do osiągnięcia żądanej przez Ciebie wersji. Pod pojęciem wersji rozumiemy prefiks nazwy pliku migracji, zawierający stempel czasowy jego utworzenia. Na przykład, aby migrować do wersji 20080906120000, wykonamy polecenie:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>rake db:migrate VERSION=20080906120000</tt></pre>
</div></div>
<div class="paragraph"><p>Jeśli podana wersja jest późniejsza niż obecna, polecenie spowoduje wywołanie metod <tt>up</tt> kolejnych migracji aż do migracji 20080906120000 włącznie. W przeciwnym wypadku, wszystkie późniejsze niż wskazana migracje zostaną wycofane metodą <tt>down</tt>.</p></div>
<h3 id="_wycofywanie_migracji">4.1. Wycofywanie migracji</h3>
<div class="paragraph"><p>Częstym zadaniem jest wycofanie ostatniej migracji, na przykład po to, by poprawić znaleziony w niej błąd. Zamiast wpisywać numer poprzedniej wersji, możemy po prostu wycofać ostatnią zmianę poleceniem:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>rake db:rollback</tt></pre>
</div></div>
<div class="paragraph"><p>Wykonana zostanie metoda <tt>down</tt> ostatniej migracji. Jeśli potrzebujesz wycofać więcej migracji, możesz dodać parametr <tt>STEP</tt>:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>rake db:rollback STEP=3</tt></pre>
</div></div>
<div class="paragraph"><p>Tym sposobem wykonasz metodę <tt>down</tt> dla trzech ostatnich migracji.</p></div>
<div class="paragraph"><p>Zadanie <tt>dr:migrate:redo</tt> jest skrótowym zapisem wycofania i ponownego wykonania migracji. Podobnie jak w przypadku <tt>db:rollback</tt>, możesz dodać parametr <tt>STEP</tt> jeśli chcesz powtórzyć więcej niż jedną migrację, np:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>rake db:migrate:redo STEP=3</tt></pre>
</div></div>
<div class="paragraph"><p>Żadne z powyższych zadań Rake nie wykonuje niczego, czego nie można osiągnąć przy pomocy podstawowego polecenia <tt>db:migrate</tt>. Są to po prostu wygodniejsze sposoby pracy na migracjach, nie wymagają bowiem podawania wprost docelowej wersji migracji.</p></div>
<div class="paragraph"><p>Ostatnim poleceniem jest <tt>db:reset</tt>. Służy ono do usunięcia całej bazy danych, ponownego jej stworzenia i przywrócenia obecnego schematu.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Polecenie to nie jest idenyczne z wprowadzeniem wszystkich migracji -
      szczegóły znajdziesz w sekcji <a href="#schema">schema.rb</a>.</td>
</tr></table>
</div>
<h3 id="_wywo_ywanie_konkretnej_migracji">4.2. Wywoływanie konkretnej migracji</h3>
<div class="paragraph"><p>Jeśli chcesz wywołać metodę <tt>up</tt> lub <tt>down</tt> konkretnej migracji, możesz w tym celu użyć komend <tt>db:migrate:up</tt> i <tt>db:migrate:down</tt>. Wystarczy podać dokładną wersję migracji, a jej metoda <tt>up</tt> albo <tt>down</tt> zostanie wykonana. Na przykład</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>rake db:migrate:up VERSION=20080906120000</tt></pre>
</div></div>
<div class="paragraph"><p>wywoła metodę <tt>up</tt> dla migracji 20080906120000. Zadanie to sprawdza najpierw czy podana migracja została wcześniej wykonana, więc np. komenda <tt>db:migrate:up VERSION=20080906120000</tt> nie spowoduje żadnych zmian, jeśli moduł Active Record uzna, że ta migracja jest już wywołana.</p></div>
<h3 id="_komunikaty">4.3. Komunikaty</h3>
<div class="paragraph"><p>Domyślnie migracja informuje Cię dokładnie o wykonywanej obecnie transformacji oraz o czasie który był potrzebny do wykonania ukończonych zadań. Migracja tworząca tabelę i indeks może wygenerować na przykład taki komunikat:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>== 20080906170109 CreateProducts: migrating ===================================
-- create_table(:products)
   -&gt; 0.0021s
-- add_index(:products, :name)
   -&gt; 0.0026s
== 20080906170109 CreateProducts: migrated (0.0059s) ==========================</tt></pre>
</div></div>
<div class="paragraph"><p>Istnieje kilka metod służących do kontroli komunikatów zwrotnych:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>suppress_messages</tt> zawiesza wszystkie komunikaty generowane przez dany blok
</p>
</li>
<li>
<p>
<tt>say</tt> wyświetla tekst (drugi parametr służy do określenia czy tekst ma być w nowej linii czy nie)
</p>
</li>
<li>
<p>
<tt>say_with_time</tt> wyświetla wskazany tekst oraz czas potrzebny na wykonanie bloku. Jeśli blok zwróci liczbę typu integer, metoda traktuje ją jako liczbę wierszy zmodyfikowanych przez ten blok.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Na przykład migracja:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> CreateProducts <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    suppress_messages <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
      create_table <span style="color: #990000">:</span>products <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
        t<span style="color: #990000">.</span>string <span style="color: #990000">:</span>name
        t<span style="color: #990000">.</span>text <span style="color: #990000">:</span>description
        t<span style="color: #990000">.</span>timestamps
      <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
    say <span style="color: #FF0000">"Created a table"</span>
    suppress_messages <span style="color: #FF0000">{</span>add_index <span style="color: #990000">:</span>products<span style="color: #990000">,</span> <span style="color: #990000">:</span>name<span style="color: #FF0000">}</span>
    say <span style="color: #FF0000">"and an index!"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
    say_with_time <span style="color: #FF0000">'Waiting for a while'</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
      sleep <span style="color: #993399">10</span>
      <span style="color: #993399">250</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    drop_table <span style="color: #990000">:</span>products
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>wygeneruje następujący komunikat:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>== 20080906170109 CreateProducts: migrating ===================================
-- Created a table
   -&gt; and an index!
-- Waiting for a while
   -&gt; 10.0001s
   -&gt; 250 rows
== 20080906170109 CreateProducts: migrated (10.0097s) =========================</tt></pre>
</div></div>
<div class="paragraph"><p>Jeśli chcesz po prostu zupełnie "uciszyć" moduł Active Record, możesz wykorzystać komendę <tt>rake db:migrate VERBOSE=false</tt>.</p></div>
</div>
<h2 id="models">5. Użycie modeli w migracjach</h2>
<div class="sectionbody">
<div class="paragraph"><p>Podczas tworzenia czy aktualizacji danych zawsze kusi wykorzystanie jednego z modeli. W zasadzie po to przecież tworzymy modele, by ułatwić dostęp do danych. Można to wykonać, zachowując jednak pewien warunek.</p></div>
<div class="paragraph"><p>Wyobraźmy sobie na przykład migrację korzystającą z modelu Product w celu aktualizacji wiersza powiązanej z nim tabeli. Następnie Ania zmienia model Product, dodając nową kolumnę i walidację dla niej. Gdy Bartek wraca z wakacji, aktualizuje kod źródłowy i wpisując komendę <tt>rake db:migrate</tt> wykonuje wszystkie migracje, włącznie z migracją korzystającą z modelu Product. Ponieważ Bartek zaktualizował kod źródłowy, model Product zawiera nową walidację stworzoną przez Anię, podczas gdy baza nie posiada nowej kolumny. Spowoduje to błąd - walidacja będzie się odnosić do nieistniejącej kolumny.</p></div>
<div class="paragraph"><p>Często chcę po prostu zaktualizować wiersze danych w bazie bez konieczności ręcznego wpisywania kodu SQL; nie wykorzystuję żadnych specyficznych dla danego modelu cech. Jednym z rozwiązań jest w takim wypadku stworzenie kopii modelu wewnątrz samej migracji, na przykład:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> AddPartNumberToProducts <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Product <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    <span style="color: #990000">...</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    <span style="color: #990000">...</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Migracja posiada swoją własną kopię modelu Product i nie odnosi się już do modelu zdefiniowanego w aplikacji.</p></div>
<h3 id="_praca_na_zmieniaj_cych_si_modelach">5.1. Praca na zmieniających się modelach</h3>
<div class="paragraph"><p>Dla poprawy wydajności, informacja o kolumnach w modelu jest cache&#8217;owana. Na przykład, jeśli dodasz kolumnę do tabeli a potem spróbujesz użyć powiązanego modelu w celu dodania nowego rekordu, może on użyć starej informacji o kolumnach. Możesz zmusić moduł Active Record do ponownego odczytania informacji o kolumnach korzystając z metody <tt>reset_column_information</tt>. Na przykład:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> AddPartNumberToProducts <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Migration
  <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Product <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>up
    add_column <span style="color: #990000">:</span>product<span style="color: #990000">,</span> <span style="color: #990000">:</span>part_number<span style="color: #990000">,</span> <span style="color: #990000">:</span>string
    Product<span style="color: #990000">.</span>reset_column_information
    <span style="color: #990000">...</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>down
    <span style="color: #990000">...</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
</div>
<h2 id="_zrzuty_schemat_w">6. Zrzuty schematów</h2>
<div class="sectionbody">
<h3 id="schema">6.1. Po co tworzyć pliki schematów?</h3>
<div class="paragraph"><p>Migracje, jakkolwiek potężnym narzędziem by były, nie są wiarygodnym źródłem wiedzy o schemacie bazy. Ta rola należy do pliku <tt>schema.rb</tt> lub pliku SQL, generowanym przez moduł Active Record poprzez odpytywanie bazy danych. Nie zostały one stworzone z myślą o edycji, ich zadanie to po prostu reprezentacja aktualnego schematu bazy.</p></div>
<div class="paragraph"><p>Aby utworzyć nową kopię aplikacji nie musimy powtarzać wszystkich wykonanych migracji. Znacznie szybciej i prościej jest wczytać do bazy opis docelowego schematu.</p></div>
<div class="paragraph"><p>Przykładowo, w celu utworzenia bazy do testów, należy pobrać zrzut aktualnego schematu bazy (do pliku <tt>schema.rb</tt> lub <tt>development.sql</tt>) a następnie wczytać go do bazy testowej.</p></div>
<div class="paragraph"><p>Pliki ze schematami są także przydatne, by szybko sprawdzić atrybuty obiektu Active Record. Ta informacja nie jest zapisana w kodzie modelu, często wynika z w wielu kolejnych migracji, ale jej podsumowanie jest dostępne w pliku schematu. Warta polecenia jest wtyczka <a href="http://agilewebdevelopment.com/plugins/annotate_models">annotate_models</a>, dodająca na górze każdego modelu komentarze podsumowujące jego schemat.</p></div>
<h3 id="_typy_zrzut_w_schematu">6.2. Typy zrzutów schematu</h3>
<div class="paragraph"><p>Są dwa sposoby na zapisanie zrzutu schematu bazy. Który z nich zostanie wykorzystany, zależy od zapisu w pliku konfiguracyjnym <tt>config/environment.rb</tt>. Odpowiedzialna za to jest zmienna <tt>config.active_record.schema_format</tt>, przyjmująca wartości <tt>:sql</tt> lub <tt>:ruby</tt>.</p></div>
<div class="paragraph"><p>Jeśli zmienna ma przypisaną wartość <tt>:ruby</tt>, schemat bazy jest zapisywany w pliku <tt>db/schema.rb</tt>. Jeśli przyjrzeć się temu plikowi, można odnieść wrażenie, że to zapis jednej, wielkiej migracji.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ActiveRecord<span style="color: #990000">::</span>Schema<span style="color: #990000">.</span>define<span style="color: #990000">(:</span>version <span style="color: #990000">=&gt;</span> <span style="color: #993399">20080906171750</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  create_table <span style="color: #FF0000">"authors"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>force <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
    t<span style="color: #990000">.</span>string   <span style="color: #FF0000">"name"</span>
    t<span style="color: #990000">.</span>datetime <span style="color: #FF0000">"created_at"</span>
    t<span style="color: #990000">.</span>datetime <span style="color: #FF0000">"updated_at"</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  create_table <span style="color: #FF0000">"products"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>force <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>t<span style="color: #990000">|</span>
    t<span style="color: #990000">.</span>string   <span style="color: #FF0000">"name"</span>
    t<span style="color: #990000">.</span>text     <span style="color: #FF0000">"description"</span>
    t<span style="color: #990000">.</span>datetime <span style="color: #FF0000">"created_at"</span>
    t<span style="color: #990000">.</span>datetime <span style="color: #FF0000">"updated_at"</span>
    t<span style="color: #990000">.</span>string   <span style="color: #FF0000">"part_number"</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Pod wieloma względami tak właśnie jest. Ten plik jest tworzony poprzez odpytywanie bazy danych i zapisanie jej struktury za pomocą kolejnych poleceń <tt>create_table</tt>, <tt>add_index</tt> itd. Plik taki może zostać wczytany do dowolnej bazy danych, ponieważ polecenia te są niezmienne dla wszystkich obsługiwanych przez moduł Active Record baz. To może być bardzo użyteczne, jeśli chcesz stworzyć aplikację działającą na kilku bazach danych.</p></div>
<div class="paragraph"><p>Wykorzystanie pliku <tt>schema.rb</tt> ma też swoje wady. Nie są w nim zapisywane
informacje o funkcjach specyficznych tylko dla danego typu bazy, takich jak
klucze opcje, triggery czy procedury składowane. O ile możesz ich używać podczas migracji, nie da się ich odtworzyć w zrzucie schematu. Jeśli korzystasz z takich opcji, powinieneś zmienić zawartość zmiennej konfiguracyjnej na <tt>:sql</tt>.</p></div>
<div class="paragraph"><p>W takim przypadku, zamiast korzystać z wbudowanego narzędzia modułu Active Record, schematy zapisywane są przez narzędzia stworzone dla danego typu bazy danych (poprzez polecenie <tt>db:structure:dump</tt>) do pliku <tt>db/#{RAILS_ENV}_structure.sql</tt>. Na przykład dla bazy PostgreSQL używane jest narzędzie <tt>pg_dump</tt>, a dla MySQL w pliku zapisywane są wyniki pytań SHOW CREATE TABLE dla kolejnych tabel. Wczytanie tak zapisanego schematu bazy sprowadza się do wykonania kodu SQL zapisanego we wskazanym pliku.</p></div>
<div class="paragraph"><p>Z założenia taki zrzut schematu umożliwia stworzenie idealnej kopii bazy danych. Niestety zwykle uniemożliwia to przeniesienie schematu na bazę innego typu.</p></div>
<h3 id="_kontrola_wersji_zrzut_w_schemat_w">6.3. Kontrola wersji zrzutów schematów</h3>
<div class="paragraph"><p>Ponieważ pliki schematu powinny być wiarygodnym źródłem wiedzy o bazie danych, zalecane jest włączenie ich do systemu kontroli wersji, by umożliwić wgląd w historię zmian bazy.</p></div>
</div>
<h2 id="foreign_key">7. Active Record i integralność referencyjna</h2>
<div class="sectionbody">
<div class="paragraph"><p>Korzystanie z modułu Active Record powoduje przeniesienie części logiki z bazy danych do modeli. W związku z tym narzędzie takie jak triggery czy klucze obce, które tworzą dodatkową logikę wewnątrz bazy danych nie są zbyt często używane.</p></div>
<div class="paragraph"><p>Walidacje takie jak <tt>validates_uniqueness_of</tt> są jednym ze sposobów na wymuszenie integralności danych przez model. Opcja asocjacji <tt>:dependent</tt> pozwala modelowi automatycznie niszczyć obiekty potomne w przypadku usunięcia ich rodzica. Jak wszystkie opcje działające na poziomie aplikacji, wspomniane sposoby nie gwarantują zachowania integralności referencyjnej. Jest przyczyna dla której niektórzy wspierają je dodatkowo kluczami obcymi zawartymi w bazie danych.</p></div>
<div class="paragraph"><p>Chociaż moduł Active Record nie zapewnia narzędzi do bezpośredniej obsługi kluczy obcych, można w tym celu wykorzystać metodę <tt>execute</tt>. Są także dostępne różne wtyczki, takie jak <a href="http://agilewebdevelopment.com/plugins/search?search=redhillonrails">redhillonrails</a>, które poszerzają możliwości modułu Active Record o obsługę kluczy obcych (m.in. umożliwiają zapisywanie ich w schemacie bazy w pliku <tt>schema.rb</tt>).</p></div>
</div>
<h2 id="_changelog">8. Changelog</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="http://rails.lighthouseapp.com/projects/16213-rails-guides/tickets/6">Lighthouse ticket</a></p></div>
<div class="ulist"><ul>
<li>
<p>
September 14, 2008: initial version by <a href="../authors.html#fcheung">Frederick Cheung</a>
</p>
</li>
</ul></div>
</div>

    </div>
  </div>
</body>
</html>
